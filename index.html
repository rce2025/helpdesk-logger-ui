<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helpdesk Call Logger</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --accent-primary: #0ea5e9;
            --accent-secondary: #06b6d4;
            --accent-gradient: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --purple: #8b5cf6;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 12px 40px rgba(0,0,0,0.12);
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
        }

        .dark {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --border-color: #334155;
            --shadow-md: 0 4px 12px rgba(0,0,0,0.3);
            --shadow-lg: 0 12px 40px rgba(0,0,0,0.4);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* Login Screen */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #0ea5e9 0%, #8b5cf6 100%);
            padding: 20px;
        }

        .login-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 40px;
            max-width: 420px;
            width: 100%;
            box-shadow: var(--shadow-lg);
            text-align: center;
        }

        .login-logo {
            width: 72px;
            height: 72px;
            background: linear-gradient(135deg, #14B8A6 0%, #0D9488 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 2rem;
            color: white;
        }

        .login-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 8px; }
        .login-subtitle { color: var(--text-muted); margin-bottom: 32px; }

        .google-btn {
            width: 100%;
            padding: 14px 24px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.2s;
        }

        .google-btn:hover { background: var(--bg-tertiary); box-shadow: var(--shadow-md); }

        .user-select-modal { display: none; margin-top: 24px; }
        .user-select-modal.show { display: block; }

        .user-list { display: flex; flex-direction: column; gap: 8px; max-height: 280px; overflow-y: auto; }

        .user-option {
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.15s;
        }

        .user-option:hover { background: var(--bg-tertiary); border-color: var(--accent-primary); }

        .user-option-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .user-option-info { text-align: left; }
        .user-option-name { font-weight: 600; }
        .user-option-email { font-size: 0.8rem; color: var(--text-muted); }

        /* App Container */
        .app-container { display: none; flex-direction: column; min-height: 100vh; }
        .app-container.show { display: flex; }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 8px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            gap: 16px;
        }

        .logo { display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 1.1rem; flex-shrink: 0; }

        .header-tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-tertiary);
            padding: 4px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .header-tab {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 500;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            white-space: nowrap;
            min-width: 100px;
        }

        .header-tab:hover { background: var(--bg-secondary); }
        .header-tab.active { background: var(--accent-gradient); color: white; }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #14B8A6 0%, #0D9488 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .header-right { display: flex; align-items: center; gap: 12px; flex-shrink: 0; }

        .theme-toggle {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .theme-toggle:hover { background: var(--bg-tertiary); color: var(--accent-primary); }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 12px;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: background 0.15s;
        }

        .user-menu:hover { background: var(--bg-tertiary); }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .user-name { font-weight: 500; font-size: 0.9rem; }

        /* Main Content */
        .main-content { flex: 1; padding: 20px; max-width: 1400px; margin: 0 auto; width: 100%; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            background: var(--bg-secondary);
            padding: 6px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .tab {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 500;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab:hover { background: var(--bg-tertiary); }
        .tab.active { background: var(--accent-gradient); color: white; }

        /* Dashboard Controls - Combined Period + Stats Row */
        .dashboard-controls {
            display: flex;
            align-items: stretch;
            margin-bottom: 16px;
            gap: 12px;
        }

        .colleague-filter-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .colleague-filter-container select {
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            outline: none;
            border-radius: var(--radius-lg);
            min-width: 160px;
        }
        .colleague-filter-container select:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .date-filter {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 4px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 12px 16px;
            min-width: 130px;
        }
        .date-filter label { font-weight: 500; color: var(--text-muted); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; }

        .date-filter select {
            padding: 4px 0;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
        }

        .date-filter input[type="month"],
        .date-filter input[type="date"] {
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.85rem;
            margin-top: 4px;
            cursor: pointer;
        }
        .date-filter input[type="month"]::-webkit-calendar-picker-indicator,
        .date-filter input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            opacity: 0.7;
        }
        /* Dark mode calendar/clock icons - use filter to make icons white */
        .dark input[type="date"]::-webkit-calendar-picker-indicator,
        .dark input[type="time"]::-webkit-calendar-picker-indicator,
        .dark input[type="month"]::-webkit-calendar-picker-indicator {
            filter: invert(1) brightness(1.5) !important;
            opacity: 1 !important;
            cursor: pointer;
        }
        /* Dark mode for .date-filter specifically (Dashboard pickers) */
        .dark .date-filter input[type="month"]::-webkit-calendar-picker-indicator,
        .dark .date-filter input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1) brightness(1.5) !important;
            opacity: 1 !important;
            cursor: pointer;
        }
        /* Warning Animation (used by Period Button) */
        @keyframes pulse-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Data Loaded Range Info */
        .data-loaded-range {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: default;
        }
        .data-loaded-range i {
            font-size: 0.7rem;
        }
        .data-loaded-range:hover {
            color: var(--text-secondary);
        }

        /* Picker Row with Confirm Button */

        .date-range-inputs {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .date-range-inputs input {
            flex: 1;
        }
        .range-separator {
            color: var(--text-muted);
            font-size: 0.85rem;
            flex-shrink: 0;
        }
        .range-hint {
            font-weight: 400;
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        /* Period Button Styles */
        .period-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 140px;
        }
        .period-button:hover {
            border-color: var(--accent-primary);
            background: var(--bg-tertiary);
        }
        .period-button:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.15);
        }
        .period-button i.fa-calendar-alt {
            color: var(--accent-primary);
        }
        .period-button i.fa-chevron-down {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-left: auto;
        }
        .period-button.has-warning {
            border-color: var(--warning);
            background: rgba(245, 158, 11, 0.08);
        }
        .period-button .period-warning-icon {
            color: var(--warning);
            animation: pulse-warning 2s ease-in-out infinite;
        }

        /* Full Period Modal Styles */
        .period-modal {
            max-width: 420px;
            width: 95%;
        }
        .period-modal .modal-header {
            padding-bottom: 16px;
        }

        /* Preset Buttons Grid */
        .period-presets {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .period-preset-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .period-preset-btn:hover {
            border-color: var(--accent-primary);
            background: rgba(14, 165, 233, 0.08);
            color: var(--accent-primary);
        }
        .period-preset-btn.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }
        .period-preset-btn i {
            font-size: 0.85rem;
        }

        /* Custom Period Section Divider */
        .period-divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 20px 0 16px;
            color: var(--text-muted);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .period-divider::before,
        .period-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border-color);
        }

        /* Custom Period Tabs in Full Modal */
        .period-custom-tabs {
            display: flex;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 4px;
            margin-bottom: 16px;
        }
        .period-custom-tab {
            flex: 1;
            padding: 8px 12px;
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .period-custom-tab:hover {
            color: var(--text-primary);
        }
        .period-custom-tab.active {
            background: var(--bg-secondary);
            color: var(--accent-primary);
            box-shadow: var(--shadow-sm);
        }

        /* Custom Period Content */
        .period-custom-content {
            min-height: 80px;
        }
        .period-custom-panel {
            display: none;
        }
        .period-custom-panel.active {
            display: block;
        }
        .period-custom-panel label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        .period-custom-panel input,
        .period-custom-panel select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
        }
        .period-custom-panel input:focus,
        .period-custom-panel select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }
        /* Highlighted state for previously selected custom values */
        .period-custom-panel input.highlighted,
        .period-custom-panel select.highlighted {
            border-color: var(--accent-primary);
            background: rgba(14, 165, 233, 0.08);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.15);
        }

        /* =============================================
           Classification Wizard Modal Styles
           ============================================= */
        .classification-wizard {
            max-width: 680px;
            width: 95%;
            max-height: 90vh;
            max-height: 90dvh;
            display: flex;
            flex-direction: column;
        }
        @media (min-width: 900px) {
            .classification-wizard {
                max-width: 800px;
            }
        }
        .classification-wizard .modal-header {
            padding: 12px 20px;
            border-bottom: none;
            flex-shrink: 0;
        }
        .classification-wizard .modal-header h2 {
            font-size: 1.1rem;
        }
        .classification-wizard .modal-body {
            padding: 0 20px 16px;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }
        #wizardContent {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        /* Progress Steps with Labels */
        .wizard-progress {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 4px;
            margin-bottom: 10px;
            padding: 0;
            flex-shrink: 0;
        }
        .wizard-step-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 70px;
            max-width: 100px;
        }
        .wizard-step-dot {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            transition: all 0.3s ease;
        }
        .wizard-step-dot.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
            transform: scale(1.1);
        }
        .wizard-step-dot.completed {
            background: var(--success);
            border-color: var(--success);
            color: white;
            cursor: pointer;
        }
        .wizard-step-dot.completed:hover {
            transform: scale(1.15);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .wizard-step-item.clickable {
            cursor: pointer;
        }
        .wizard-step-item.clickable:hover .wizard-step-label {
            color: var(--accent-primary);
        }
        .wizard-step-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 3px;
            max-width: 90px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }
        .wizard-step-label.active {
            color: var(--accent-primary);
            font-weight: 500;
        }
        .wizard-step-label.completed {
            color: var(--success);
        }
        .wizard-step-line {
            width: 16px;
            height: 2px;
            background: var(--border-color);
            transition: background 0.3s ease;
            margin-top: 12px;
            flex-shrink: 0;
        }
        .wizard-step-line.completed {
            background: var(--success);
        }

        /* Wizard Question - more compact */
        .wizard-question {
            text-align: center;
            margin-bottom: 8px;
            flex-shrink: 0;
        }
        .wizard-question h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 2px 0;
        }
        .wizard-question p {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin: 0;
        }

        /* Wizard Options - more compact */
        .wizard-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 14px;
            overflow-y: auto;
            padding-right: 4px;
            flex: 1;
            min-height: 0;
        }
        .wizard-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }
        .wizard-option:hover {
            border-color: var(--accent-primary);
            background: rgba(14, 165, 233, 0.05);
            transform: translateX(4px);
        }
        .wizard-option.selected {
            border-color: var(--accent-primary);
            background: rgba(14, 165, 233, 0.1);
        }
        .wizard-option-icon {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
            background: var(--bg-tertiary);
        }
        .wizard-option-content {
            flex: 1;
            min-width: 0;
        }
        .wizard-option-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        .wizard-option-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
            line-height: 1.3;
        }
        .wizard-option-check {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s ease;
            font-size: 0.7rem;
        }
        .wizard-option.selected .wizard-option-check {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        /* Grid layout for system selection - 3 columns on wider screens */
        .wizard-options.grid-layout {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        @media (max-width: 600px) {
            .wizard-options.grid-layout {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .wizard-options.grid-layout .wizard-option {
            flex-direction: column;
            text-align: center;
            padding: 10px 8px;
            position: relative;
        }
        .wizard-options.grid-layout .wizard-option-icon {
            width: 36px;
            height: 36px;
            margin-bottom: 4px;
        }
        .wizard-options.grid-layout .wizard-option-content {
            width: 100%;
        }
        .wizard-options.grid-layout .wizard-option-title {
            font-size: 0.75rem;
        }
        .wizard-options.grid-layout .wizard-option-desc {
            display: none;
        }
        .wizard-options.grid-layout .wizard-option-check {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 16px;
            height: 16px;
        }

        /* Wizard Navigation - more compact */
        .wizard-nav {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
            background: var(--bg-secondary);
            margin-top: auto;
        }
        .wizard-nav .btn {
            flex: 1;
            padding: 8px 14px;
            font-size: 0.85rem;
        }
        .wizard-nav .btn-back {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            max-width: 90px;
        }
        .wizard-nav .btn-back:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        /* Summary Step - more compact */
        .wizard-summary {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 12px;
            margin-bottom: 12px;
        }
        .wizard-summary-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .wizard-summary-row:last-child {
            border-bottom: none;
        }
        .wizard-summary-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            flex-shrink: 0;
        }
        .wizard-summary-value {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-primary);
            text-align: right;
            max-width: 65%;
        }

        /* Internal Staff Toggle */
        .wizard-toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            margin-bottom: 16px;
        }
        .wizard-toggle-label {
            font-size: 0.9rem;
            color: var(--text-primary);
        }
        .wizard-toggle-hint {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        .wizard-toggle {
            position: relative;
            width: 44px;
            height: 24px;
            background: var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .wizard-toggle.active {
            background: var(--accent-primary);
        }
        .wizard-toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }
        .wizard-toggle.active::after {
            transform: translateX(20px);
        }

        /* Classification Helper Button */
        .classification-helper-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--purple) 100%);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .classification-helper-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }
        .classification-helper-btn i {
            font-size: 0.85rem;
        }

        @media (max-width: 480px) {
            .wizard-options.grid-layout {
                grid-template-columns: 1fr;
            }
            .wizard-options.grid-layout .wizard-option {
                flex-direction: row;
                text-align: left;
            }
            .wizard-options.grid-layout .wizard-option-icon {
                width: 36px;
                height: 36px;
                margin-bottom: 0;
            }
            .wizard-options.grid-layout .wizard-option-check {
                position: static;
            }
        }

        /* Filter Controls Row */
        .filter-controls {
            display: flex;
            align-items: stretch;
            gap: 16px;
            flex-wrap: wrap;
        }

        .channel-filter {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 6px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 12px 16px;
        }
        .channel-filter label {
            font-weight: 500;
            color: var(--text-muted);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .channel-toggles {
            display: flex;
            gap: 6px;
        }
        .channel-toggle {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            background: var(--bg-secondary);
            color: var(--text-muted);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        .channel-toggle .channel-icon {
            font-size: 0.85rem;
        }
        .channel-toggle .check-icon {
            font-size: 0.6rem;
            opacity: 0;
            margin-left: -2px;
            transition: opacity 0.2s;
        }
        /* Inactive state colors */
        .channel-toggle.agency { color: var(--accent-primary); border-color: rgba(14, 165, 233, 0.3); }
        .channel-toggle.broker { color: var(--purple); border-color: rgba(139, 92, 246, 0.3); }
        .channel-toggle.banca { color: var(--success); border-color: rgba(16, 185, 129, 0.3); }
        /* Active state colors */
        .channel-toggle.active.agency { background: rgba(14, 165, 233, 0.15); border-color: var(--accent-primary); color: var(--accent-primary); }
        .channel-toggle.active.broker { background: rgba(139, 92, 246, 0.15); border-color: var(--purple); color: var(--purple); }
        .channel-toggle.active.banca { background: rgba(16, 185, 129, 0.15); border-color: var(--success); color: var(--success); }
        .channel-toggle.active .check-icon {
            opacity: 1;
        }
        .channel-toggle:not(.active) {
            opacity: 0.45;
        }
        @media (hover: hover) {
            .channel-toggle.agency:hover { background: rgba(14, 165, 233, 0.1); opacity: 1; }
            .channel-toggle.broker:hover { background: rgba(139, 92, 246, 0.1); opacity: 1; }
            .channel-toggle.banca:hover { background: rgba(16, 185, 129, 0.1); opacity: 1; }
        }

        /* Stats Grid - Inline with Period */
        .stats-grid {
            display: flex;
            flex: 1;
            gap: 12px;
            margin-bottom: 0;
        }

        .stat-card {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 12px 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            user-select: none;
        }

        @media (hover: hover) {
            .stat-card:hover:not(:active) { border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1); }
        }
        .stat-card:focus,
        .stat-card:focus-visible {
            outline: none !important;
            box-shadow: none !important;
        }
        .stat-card:not(.active) {
            border-color: var(--border-color) !important;
            background: var(--bg-secondary) !important;
        }
        .stat-card.active { border-color: var(--accent-primary) !important; background: rgba(14, 165, 233, 0.05) !important; }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .stat-icon.blue { background: rgba(14, 165, 233, 0.15); color: var(--accent-primary); }
        .stat-icon.orange { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .stat-icon.purple { background: rgba(139, 92, 246, 0.15); color: var(--purple); }
        .stat-icon.green { background: rgba(16, 185, 129, 0.15); color: var(--success); }

        .stat-info h3 { font-size: 1.4rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; line-height: 1; }
        .stat-info p { color: var(--text-muted); font-size: 0.75rem; white-space: nowrap; }

        /* Filter Bar */
        .filter-bar { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }

        .search-box {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 10px 14px;
            flex: 1;
            min-width: 200px;
            max-width: 320px;
        }

        .search-box input {
            flex: 1;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            outline: none;
        }

        .search-box i { color: var(--text-muted); }
        .search-box .fa-search { pointer-events: none; }
        .search-clear {
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            transition: all 0.2s ease;
            display: none;
        }
        .search-clear:hover { color: var(--text-primary); background: var(--bg-tertiary); }
        .search-box.has-value .search-clear { display: block; }

        /* Cases Table */
        .cases-table {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
            position: relative;
        }

        .table-loading-overlay {
            position: absolute;
            top: 50px;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(var(--bg-primary-rgb, 255, 255, 255), 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .dark .table-loading-overlay {
            background: rgba(15, 23, 42, 0.85);
        }
        .table-loading-spinner {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--accent-primary);
            font-size: 0.95rem;
            font-weight: 500;
        }
        .table-loading-spinner i {
            font-size: 1.2rem;
        }

        .table-header {
            display: grid;
            grid-template-columns: 40px 70px 85px 1.3fr 1.3fr 120px 90px 45px 30px;
            gap: 12px;
            padding: 14px 20px;
            background: var(--bg-tertiary);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border-color);
        }

        .case-row {
            display: grid;
            grid-template-columns: 40px 70px 85px 1.3fr 1.3fr 120px 90px 45px 30px;
            gap: 12px;
            padding: 14px 20px;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
            cursor: pointer;
            transition: background 0.15s;
            font-size: 0.9rem;
        }

        /* Admin mode: show Created By column */
        .admin-mode .table-header, .admin-mode .case-row {
            grid-template-columns: 40px 70px 100px 85px 1.2fr 1.2fr 100px 90px 45px 30px;
        }
        .created-by-col { display: none; }
        .admin-mode .created-by-col { display: block; }
        .created-by-cell {
            display: flex;
            align-items: center;
            gap: 6px;
            overflow: hidden;
        }
        .creator-avatar {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--accent-gradient);
            color: white;
            font-size: 0.6rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .creator-name {
            font-size: 0.8rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .case-row:nth-child(even) { background: var(--bg-tertiary); }
        .case-row:hover { background: rgba(14, 165, 233, 0.08); }
        .dark .case-row:hover { background: rgba(14, 165, 233, 0.15); }
        .case-row:last-child { border-bottom: none; }

        /* Sortable column headers */
        .sortable-header {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            user-select: none;
            transition: color 0.15s;
        }
        .sortable-header:hover { color: var(--accent-primary); }
        .sortable-header.active { color: var(--accent-primary); }
        .sortable-header .sort-icon { font-size: 0.65rem; opacity: 0.5; }
        .sortable-header.active .sort-icon { opacity: 1; }

        /* Pagination */
        .pagination-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 12px;
        }
        .pagination-info { font-size: 0.85rem; color: var(--text-muted); }
        .pagination-controls { display: flex; align-items: center; gap: 8px; }
        .pagination-btn {
            width: 36px;
            height: 36px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }
        .pagination-btn:hover:not(:disabled) { background: var(--bg-tertiary); border-color: var(--accent-primary); color: var(--accent-primary); }
        .pagination-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .pagination-btn.active { background: var(--accent-primary); border-color: var(--accent-primary); color: white; }
        .page-size-select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.85rem;
            cursor: pointer;
        }
        .page-numbers { display: flex; gap: 4px; }

        .job-id { font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--accent-primary); }

        .cell-truncate { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .channel-badge, .status-badge {
            display: inline-flex;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .channel-badge.agency { background: rgba(14, 165, 233, 0.15); color: var(--accent-primary); }
        .channel-badge.broker { background: rgba(139, 92, 246, 0.15); color: var(--purple); }
        .channel-badge.banca { background: rgba(16, 185, 129, 0.15); color: var(--success); }

        .status-badge.pending { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .status-badge.completed { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .status-badge.escalated { background: rgba(139, 92, 246, 0.15); color: var(--purple); }

        .follow-up-count { display: inline-flex; align-items: center; gap: 4px; color: var(--text-muted); font-size: 0.85rem; }

        /* Search highlight */
        mark {
            background: rgba(250, 204, 21, 0.4);
            color: inherit;
            padding: 1px 2px;
            border-radius: 2px;
        }
        .dark mark {
            background: rgba(250, 204, 21, 0.3);
        }

        /* Hidden field match indicators */
        .match-header {
            text-align: center;
            color: var(--text-muted);
        }
        .match-cell {
            display: flex;
            justify-content: center;
        }
        .match-indicators {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .match-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 0.6rem;
            cursor: help;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }
        .match-icon:hover {
            transform: scale(1.15);
        }
        /* Tel icon - Blue */
        .match-icon.fa-phone {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }
        .match-icon.fa-phone:hover {
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.4);
        }
        /* Agent icon - Purple */
        .match-icon.fa-id-badge {
            background: rgba(139, 92, 246, 0.15);
            color: #8b5cf6;
        }
        .match-icon.fa-id-badge:hover {
            box-shadow: 0 0 8px rgba(139, 92, 246, 0.4);
        }
        /* Ticket icon - Amber */
        .match-icon.fa-ticket-alt {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }
        .match-icon.fa-ticket-alt:hover {
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.4);
        }
        /* Dark mode adjustments */
        .dark .match-icon.fa-phone {
            background: rgba(59, 130, 246, 0.25);
            color: #60a5fa;
        }
        .dark .match-icon.fa-id-badge {
            background: rgba(139, 92, 246, 0.25);
            color: #a78bfa;
        }
        .dark .match-icon.fa-ticket-alt {
            background: rgba(245, 158, 11, 0.25);
            color: #fbbf24;
        }

        /* Form Container */
        .form-container { display: none; }
        .form-container.active { display: block; }

        .form-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-lg); overflow: visible; }

        .form-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .form-header h2 { font-size: 1.2rem; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .form-body { padding: 24px; }

        /* Form Grid */
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .form-group { display: flex; flex-direction: column; gap: 6px; min-width: 0; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group.two-third { grid-column: 1 / -1; }

        /* Ensure date/time/number inputs don't overflow */
        input[type="date"], input[type="time"], input[type="number"] {
            -webkit-appearance: none;
            appearance: none;
            min-width: 0;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .form-label { font-size: 0.85rem; font-weight: 500; color: var(--text-secondary); display: flex; align-items: center; gap: 6px; }
        .form-label .required { color: var(--danger); }

        .form-input, .form-select, .form-textarea {
            padding: 12px 14px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .form-input:disabled, .form-select:disabled, .form-textarea:disabled {
            background: var(--bg-tertiary);
            color: var(--text-muted);
            cursor: not-allowed;
        }

        /* Uppercase input but normal placeholder */
        .form-input.uppercase-input { text-transform: uppercase; }
        .form-input.uppercase-input::placeholder { text-transform: none; }

        .form-textarea { min-height: 100px; resize: vertical; }

        /* Section Divider */
        .form-section-divider {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 10px 0;
        }

        .form-section-divider span {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .form-section-divider::after { content: ''; flex: 1; height: 1px; background: var(--border-color); }

        .form-section-divider .classification-helper-btn {
            order: 1;
            margin-left: auto;
        }
        .form-section-divider::after {
            order: 0;
        }

        /* Templates */
        .templates-inline { grid-column: 1 / -1; display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }

        .template-chip {
            padding: 8px 14px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-tertiary);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.15s;
        }

        .template-chip:hover { border-color: var(--accent-primary); background: rgba(14, 165, 233, 0.1); }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            border: none;
        }

        .btn-primary { background: var(--accent-gradient); color: white; }
        .btn-primary:hover { box-shadow: 0 4px 12px rgba(14, 165, 233, 0.4); transform: translateY(-1px); }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background: var(--border-color); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger-outline { background: transparent; color: var(--danger); border: 1px solid var(--danger); }
        .btn-danger-outline:hover { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-group { display: flex; gap: 12px; margin-top: 20px; }
        .btn-group.centered { justify-content: center; }

        /* Case Detail */
        .case-detail-container { display: none; }
        .case-detail-container.active { display: block; }

        .case-detail-header { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; flex-wrap: wrap; }

        .back-btn {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-primary);
        }

        .back-btn:hover { background: var(--bg-tertiary); color: var(--accent-primary); }

        .case-detail-title { flex: 1; }
        .case-detail-title h2 { font-size: 1.4rem; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .case-detail-title p { color: var(--text-muted); font-size: 0.9rem; }

        .detail-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }

        .detail-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-lg); overflow: hidden; }

        .detail-card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .detail-card-header-left { display: flex; align-items: center; gap: 10px; }
        .detail-card-body { padding: 20px; transition: background-color 0.3s ease; }
        .detail-card-body.flash {
            animation: flashHighlight 0.6s ease;
        }
        @keyframes flashHighlight {
            0% { background-color: rgba(14, 165, 233, 0.2); }
            100% { background-color: transparent; }
        }

        .detail-row { display: flex; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
        .detail-row:last-child { border-bottom: none; }
        .detail-label { width: 140px; font-size: 0.85rem; color: var(--text-muted); flex-shrink: 0; }
        .detail-value { flex: 1; font-weight: 500; white-space: pre-wrap; word-break: break-word; }
        /* Time display color coding */
        .time-date { color: var(--text-primary); }
        .time-period { color: #14B8A6; font-weight: 600; }
        .time-duration { color: var(--text-primary); font-size: 0.9em; }
        /* Clickable phone number - clickable only on mobile */
        .tel-link { color: var(--accent-primary); text-decoration: none; pointer-events: none; }
        @media (max-width: 768px) {
            .tel-link { text-decoration: underline; text-underline-offset: 2px; pointer-events: auto; }
        }

        /* Timeline */
        .timeline { position: relative; padding-left: 24px; }
        .timeline::before { content: ''; position: absolute; left: 7px; top: 0; bottom: 0; width: 2px; background: var(--border-color); }
        .timeline-item { position: relative; padding-bottom: 20px; cursor: pointer; }
        .timeline-item:last-child { padding-bottom: 0; }
        .timeline-dot { position: absolute; left: -20px; top: 4px; width: 16px; height: 16px; border-radius: 50%; background: var(--accent-primary); border: 3px solid var(--bg-secondary); }
        .timeline-item.original .timeline-dot { background: var(--success); }
        .timeline-content { background: var(--bg-tertiary); border-radius: var(--radius-md); padding: 14px; transition: all 0.2s; }
        .timeline-content:hover { background: var(--border-color); }
        .timeline-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
        .timeline-job-id { font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--accent-primary); }
        .timeline-date { font-size: 0.8rem; color: var(--text-muted); }
        .timeline-desc { font-size: 0.9rem; color: var(--text-secondary); }

        /* Mobile Timeline Drawer */
        .timeline-drawer {
            display: none;
        }
        .timeline-drawer-tab {
            display: none;
        }

        @media (max-width: 1024px) {
            .timeline-drawer {
                display: block;
                position: fixed;
                top: 0;
                right: 0;
                width: 85%;
                max-width: 360px;
                height: 100vh;
                background: var(--bg-secondary);
                border-left: 1px solid var(--border-color);
                box-shadow: var(--shadow-lg);
                z-index: 200;
                transform: translateX(0);
                transition: transform 0.3s ease;
                overflow-y: auto;
                padding: 16px;
            }
            .timeline-drawer.collapsed {
                transform: translateX(100%);
            }
            .timeline-drawer-tab {
                display: flex;
                align-items: center;
                justify-content: center;
                position: fixed;
                right: 0;
                top: 50%;
                transform: translateY(-50%);
                width: 28px;
                height: 100px;
                background: var(--accent-primary);
                color: white;
                border-radius: var(--radius-md) 0 0 var(--radius-md);
                cursor: pointer;
                z-index: 201;
                writing-mode: vertical-rl;
                text-orientation: mixed;
                font-size: 0.75rem;
                font-weight: 600;
                letter-spacing: 1px;
                box-shadow: var(--shadow-md);
                transition: opacity 0.3s ease, right 0.3s ease;
                opacity: 0;
                pointer-events: none;
            }
            .timeline-drawer-tab.visible {
                opacity: 1;
                pointer-events: auto;
            }
            .timeline-drawer-tab i {
                margin-bottom: 6px;
            }
            .timeline-drawer-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 16px;
                padding-bottom: 12px;
                border-bottom: 1px solid var(--border-color);
            }
            .timeline-drawer-header h3 {
                font-size: 1rem;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .timeline-drawer-close {
                width: 32px;
                height: 32px;
                border: none;
                background: var(--bg-tertiary);
                border-radius: var(--radius-sm);
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--text-secondary);
                transition: all 0.2s;
            }
            .timeline-drawer-close:hover {
                background: var(--border-color);
                color: var(--text-primary);
            }
            .timeline-drawer-overlay {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.4);
                z-index: 199;
            }
            .timeline-drawer-overlay.visible {
                display: block;
            }
            /* Hide the original timeline in detail-grid on mobile */
            .detail-grid > div:last-child {
                display: none;
            }
        }

        /* Follow-up Info */
        .follow-up-info { background: var(--bg-tertiary); border-radius: var(--radius-md); padding: 14px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }
        .follow-up-info i { color: var(--accent-primary); font-size: 1.2rem; }
        .follow-up-info p { font-size: 0.9rem; color: var(--text-secondary); }
        .follow-up-info strong { color: var(--text-primary); }

        /* Toast */
        .toast { position: fixed; bottom: 24px; right: 24px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 14px 20px; box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: 12px; z-index: 300; transform: translateX(calc(100% + 24px)); transition: transform 0.3s ease; }
        .toast.show { transform: translateX(0); }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.warning { border-left: 4px solid var(--warning); }
        .toast i { font-size: 1.2rem; }
        .toast.success i { color: var(--success); }
        .toast.error i { color: var(--danger); }
        .toast.warning i { color: var(--warning); }

        /* Confirm Modal */
        .confirm-overlay { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 250; align-items: center; justify-content: center; padding: 20px; }
        .confirm-overlay.active { display: flex; }
        .confirm-modal { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-lg); max-width: 400px; width: 100%; box-shadow: var(--shadow-lg); }
        .confirm-modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 12px; }
        .confirm-modal-header i { color: var(--warning); font-size: 1.3rem; }
        .confirm-modal-header h3 { font-size: 1.1rem; font-weight: 600; }
        .confirm-modal-body { padding: 20px 24px; }
        .confirm-modal-body p { color: var(--text-secondary); line-height: 1.6; }
        .confirm-modal-footer { padding: 16px 24px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px; }

        /* Empty State */
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
        .empty-state i { font-size: 3rem; margin-bottom: 16px; opacity: 0.5; }
        .empty-state h3 { font-size: 1.2rem; color: var(--text-secondary); margin-bottom: 8px; }

        /* Channel Selector */
        .channel-selector { display: flex; gap: 12px; }
        .channel-option {
            flex: 1;
            padding: 14px 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-primary);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .channel-option:hover { border-color: var(--text-muted); }
        .channel-option.selected { border-color: var(--accent-primary); background: rgba(14, 165, 233, 0.1); }
        .channel-option.selected.agency { border-color: var(--accent-primary); background: rgba(14, 165, 233, 0.15); }
        .channel-option.selected.broker { border-color: var(--purple); background: rgba(139, 92, 246, 0.15); }
        .channel-option.selected.banca { border-color: var(--success); background: rgba(16, 185, 129, 0.15); }
        .channel-option i { font-size: 1.5rem; }
        .channel-option.agency i { color: var(--accent-primary); }
        .channel-option.broker i { color: var(--purple); }
        .channel-option.banca i { color: var(--success); }
        .channel-option span { font-size: 0.8rem; font-weight: 600; color: var(--text-secondary); }
        .channel-option.selected span { color: var(--text-primary); }

        /* Common field indicator (fields shared across follow-ups) */
        .form-group.common-field {
            background: rgba(139, 92, 246, 0.08);
            border-left: 3px solid var(--purple);
            padding: 12px;
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
            margin-left: -12px;
            padding-left: 12px;
        }
        .form-group.common-field .form-label::after {
            content: '(shared)';
            font-size: 0.7rem;
            color: var(--purple);
            margin-left: 6px;
            font-weight: 400;
        }

        /* Fixed form buttons footer */
        .form-buttons-fixed {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            z-index: 100;
            display: none;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
        }
        .form-buttons-fixed.show {
            display: flex;
        }
        .form-buttons-fixed .btn {
            min-width: 140px;
        }
        /* Add padding to form body to account for fixed footer */
        .form-container.active .form-body {
            padding-bottom: 100px;
        }
        @media (max-width: 768px) {
            .form-buttons-fixed {
                padding: 12px 16px;
            }
            .form-buttons-fixed .btn {
                min-width: 120px;
                flex: 1;
            }
        }
        @media (max-width: 480px) {
            .form-buttons-fixed {
                padding: 12px;
            }
            .form-buttons-fixed .btn {
                min-width: 100px;
            }
        }

        /* 3-button confirm modal */
        .confirm-modal-footer.three-buttons { flex-wrap: wrap; gap: 8px; }
        .confirm-modal-footer.three-buttons .btn { flex: 1; min-width: 100px; }

        /* Timeline selected state */
        .timeline-item.selected .timeline-content {
            background: rgba(139, 92, 246, 0.1);
            border: 2px solid var(--purple);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15);
        }
        .timeline-item.selected .timeline-dot { background: var(--purple); transform: scale(1.2); }
        .timeline-item.selected .timeline-job-id { color: var(--purple); font-weight: 700; }
        .timeline-item.selected .timeline-date { color: var(--text-primary); }
        .timeline-item.selected .timeline-desc { color: var(--text-primary); font-weight: 500; }

        /* Ticket Badge */
        .ticket-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
            margin-left: 8px;
        }

        /* FAB */
        .fab { position: fixed; bottom: 24px; right: 24px; width: 60px; height: 60px; border-radius: 50%; background: var(--accent-gradient); color: white; border: none; font-size: 1.5rem; cursor: pointer; box-shadow: var(--shadow-lg); display: flex; align-items: center; justify-content: center; transition: transform 0.2s, box-shadow 0.2s; z-index: 50; }
        .fab:hover { transform: scale(1.1); box-shadow: 0 8px 30px rgba(14, 165, 233, 0.4); }

        /* Bulk Action Bar */
        .bulk-action-bar {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: var(--shadow-lg);
            z-index: 100;
            transition: transform 0.3s ease;
        }
        .bulk-action-bar.show { transform: translateX(-50%) translateY(0); }
        .bulk-action-bar .selected-count { font-weight: 600; color: var(--text-primary); white-space: nowrap; }
        .bulk-action-bar .btn { padding: 8px 16px; font-size: 0.85rem; }

        /* Checkbox styling */
        .case-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent-primary);
        }
        .checkbox-cell { display: flex; align-items: center; justify-content: center; }

        /* Autocomplete */
        .autocomplete-wrapper { position: relative; }
        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #ffffff;
            border: 2px solid var(--accent-primary);
            border-top: none;
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }
        .dark .autocomplete-list {
            background: #1e293b;
            border-color: var(--accent-primary);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
        }
        .autocomplete-list.show { display: block; }
        .autocomplete-item {
            padding: 10px 14px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
            transition: background 0.15s;
        }
        .dark .autocomplete-item {
            color: #e2e8f0;
            border-bottom-color: #334155;
        }
        .autocomplete-item:last-child { border-bottom: none; }
        .autocomplete-item:hover, .autocomplete-item.active {
            background: #eff6ff;
            color: #1e40af;
        }
        .dark .autocomplete-item:hover, .dark .autocomplete-item.active {
            background: #334155;
            color: #93c5fd;
        }
        .autocomplete-item mark {
            background: rgba(14, 165, 233, 0.3);
            color: inherit;
            padding: 0 2px;
            border-radius: 2px;
        }
        .autocomplete-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Admin Panel */
        .admin-header { margin-bottom: 24px; }
        .admin-header h2 { font-size: 1.5rem; margin-bottom: 4px; display: flex; align-items: center; gap: 10px; }
        .admin-subtitle { color: var(--text-muted); font-size: 0.9rem; }

        .admin-tabs { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .admin-tab {
            padding: 10px 20px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        .admin-tab:hover { background: var(--bg-tertiary); }
        .admin-tab.active { background: var(--accent-primary); color: white; border-color: var(--accent-primary); }

        .admin-tab-content { display: none; }
        .admin-tab-content.active { display: block; }

        .admin-actions { margin-bottom: 16px; }

        .admin-table {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .admin-table-header {
            display: grid;
            grid-template-columns: 1fr 1.5fr 80px 80px 80px 80px 100px;
            padding: 14px 20px;
            background: var(--bg-tertiary);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border-color);
        }

        .admin-user-row {
            display: grid;
            grid-template-columns: 1fr 1.5fr 80px 80px 80px 80px 100px;
            padding: 14px 20px;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
            font-size: 0.9rem;
        }
        .admin-user-row:last-child { border-bottom: none; }
        .admin-user-row:hover { background: var(--bg-tertiary); }

        .admin-user-row .user-name { font-weight: 500; }
        .admin-user-row .user-email { color: var(--text-secondary); font-size: 0.85rem; }

        .role-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .role-badge.admin { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .role-badge.user { background: rgba(14, 165, 233, 0.15); color: var(--accent-primary); }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .status-dot.active { background: var(--success); }
        .status-dot.inactive { background: var(--danger); }

        .admin-actions-cell { display: flex; gap: 8px; }
        .admin-actions-cell .btn { padding: 6px 10px; font-size: 0.8rem; }

        .reports-placeholder {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }
        .reports-placeholder h3 { margin: 16px 0 8px; color: var(--text-primary); }

        /* Admin Helpdesk Cases */
        .admin-helpdesk-controls { margin-bottom: 16px; }
        .admin-filter-row {
            display: flex;
            align-items: flex-end;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        .colleague-filter, .admin-period-filter {
            display: flex;
            flex-direction: column;
            gap: 6px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 10px 14px;
        }
        .colleague-filter label, .admin-period-filter label {
            font-weight: 500;
            color: var(--text-muted);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .colleague-filter select, .admin-period-filter select {
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            min-width: 160px;
        }
        .admin-load-btn { align-self: flex-end; }
        .admin-refresh-btn { align-self: flex-end; padding: 8px 12px; }
        .admin-cache-status {
            align-self: flex-end;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        .admin-cache-status i { color: var(--accent-primary); }
        .admin-stats-summary {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .admin-stat-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border-radius: var(--radius-md);
            font-size: 0.85rem;
            font-weight: 600;
        }
        .admin-stat-chip.total { background: rgba(14, 165, 233, 0.15); color: var(--accent-primary); }
        .admin-stat-chip.pending { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .admin-stat-chip.escalated { background: rgba(139, 92, 246, 0.15); color: var(--purple); }
        .admin-stat-chip.resolved { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .admin-cases-table {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: 16px;
        }
        .admin-cases-header {
            display: grid;
            grid-template-columns: 100px 120px 90px 1fr 150px 100px;
            padding: 14px 16px;
            background: var(--bg-tertiary);
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-color);
        }
        .admin-case-row {
            display: grid;
            grid-template-columns: 100px 120px 90px 1fr 150px 100px;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.15s;
        }
        .admin-case-row:hover { background: var(--bg-tertiary); }
        .admin-case-row:last-child { border-bottom: none; }
        .admin-case-row .case-creator {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.85rem;
        }
        .admin-case-row .case-creator-initials {
            display: inline-block;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--accent-gradient);
            color: white;
            font-size: 0.65rem;
            font-weight: 600;
            text-align: center;
            line-height: 24px;
            margin-right: 6px;
        }
        .admin-empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }
        .admin-empty-state i { font-size: 3rem; margin-bottom: 16px; }
        .admin-empty-state p { font-size: 0.95rem; }
        .admin-pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
        }
        @media (max-width: 768px) {
            .admin-filter-row { flex-direction: column; align-items: stretch; }
            .colleague-filter, .admin-period-filter { width: 100%; }
            .admin-load-btn { flex: 1; }
            .admin-refresh-btn { flex: 0 0 auto; }
            .admin-cache-status { flex: 1; justify-content: center; }
            .admin-cases-header { display: none; }
            .admin-case-row {
                display: flex;
                flex-direction: column;
                gap: 6px;
                padding: 14px;
            }
            .admin-case-row > div::before {
                content: attr(data-label);
                font-weight: 500;
                color: var(--text-muted);
                font-size: 0.75rem;
                text-transform: uppercase;
                margin-right: 8px;
            }
            .admin-pagination { flex-direction: column; gap: 12px; }
        }

        /* Admin User Summary */
        .admin-user-summary {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            margin-bottom: 16px;
            overflow: hidden;
        }
        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            background: var(--bg-tertiary);
            cursor: pointer;
            transition: background 0.15s;
        }
        .summary-header:hover { background: var(--bg-secondary); }
        .summary-header h3 {
            margin: 0;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .summary-header h3 i { color: var(--accent-primary); }
        .summary-toggle {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            transition: transform 0.2s;
        }
        .summary-toggle.collapsed { transform: rotate(-90deg); }
        .summary-content {
            padding: 16px;
            border-top: 1px solid var(--border-color);
        }
        .summary-content.collapsed { display: none; }
        .summary-table {
            overflow-x: auto;
        }
        .summary-table-header {
            display: grid;
            grid-template-columns: 140px repeat(8, 1fr);
            padding: 10px 12px;
            background: var(--bg-tertiary);
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-radius: var(--radius-md) var(--radius-md) 0 0;
            min-width: 700px;
        }
        .summary-table-row {
            display: grid;
            grid-template-columns: 140px repeat(8, 1fr);
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
            min-width: 700px;
        }
        .summary-table-row:nth-child(even) { background: var(--bg-tertiary); }
        .summary-table-row:last-child { border-bottom: none; }
        .summary-table-row:hover { background: rgba(14, 165, 233, 0.08); }
        .dark .summary-table-row:hover { background: rgba(14, 165, 233, 0.15); }
        .summary-table-row.totals-row {
            background: var(--bg-tertiary);
            font-weight: 600;
            border-radius: 0 0 var(--radius-md) var(--radius-md);
        }
        .summary-table-row .colleague-name {
            font-weight: 500;
            color: var(--text-primary);
        }
        .summary-table-row.inactive-user {
            opacity: 0.7;
        }
        .inactive-badge {
            font-size: 0.7rem;
            color: var(--text-secondary);
            font-weight: 400;
            font-style: italic;
        }
        .text-center { text-align: center; }
        .summary-value { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; }
        .summary-value.highlight { color: var(--accent-primary); font-weight: 600; }
        @media (max-width: 768px) {
            .summary-table { font-size: 0.8rem; }
            .summary-table-header, .summary-table-row {
                grid-template-columns: 100px repeat(8, 50px);
                min-width: 500px;
            }
        }

        /* User Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        .modal-overlay.show { display: flex; }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            max-width: 480px;
            width: 100%;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .modal-header h3 { display: flex; align-items: center; gap: 10px; font-size: 1.1rem; }
        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 4px;
        }
        .modal-close:hover { color: var(--text-primary); }

        .modal-body { padding: 24px; }
        .modal-body .form-group { margin-bottom: 16px; }
        .modal-body .form-group:last-child { margin-bottom: 0; }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        @media (max-width: 768px) {
            .admin-table-header { display: none; }
            .admin-user-row {
                display: flex;
                flex-direction: column;
                gap: 8px;
                padding: 16px;
            }
            .admin-user-row > div::before {
                content: attr(data-label);
                font-weight: 600;
                font-size: 0.75rem;
                color: var(--text-muted);
                text-transform: uppercase;
                margin-right: 8px;
            }
            .admin-actions-cell { justify-content: flex-start; margin-top: 8px; }
        }

        /* Responsive */
        @media (max-width: 1024px) { .detail-grid { grid-template-columns: 1fr; } }

        @media (max-width: 1024px) {
            .stats-grid { flex-wrap: wrap; }
            .stat-card { min-width: calc(50% - 6px); }
        }

        /* iPad fix - increase gap and ensure no overlap */
        @media (min-width: 769px) and (max-width: 1024px) {
            .form-grid { gap: 14px 24px; grid-template-columns: repeat(2, minmax(0, 1fr)); overflow: visible; }
            .form-group { min-width: 0; overflow: visible; max-width: 100%; flex-shrink: 1; }
            .form-input, .form-select { min-width: 0; width: 100%; max-width: 100%; box-sizing: border-box; padding: 10px 12px; font-size: 14px; }
            /* Force date/time/number inputs to be same size as selects - override iOS Safari defaults */
            .form-grid input[type="date"],
            .form-grid input[type="time"],
            .form-grid input[type="number"] {
                -webkit-appearance: none;
                -moz-appearance: textfield;
                appearance: none;
                min-width: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
                box-sizing: border-box !important;
                padding: 10px 10px !important;
                font-size: 14px !important;
                background: var(--bg-secondary);
                border: 1px solid var(--border-color);
                border-radius: var(--radius-md);
                color: var(--text-primary);
                flex-shrink: 1;
            }
            /* Hide spinner buttons on number inputs */
            .form-grid input[type="number"]::-webkit-inner-spin-button,
            .form-grid input[type="number"]::-webkit-outer-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }
            .duration-input-wrapper { width: 100%; max-width: 100%; overflow: hidden; }
            .duration-input-wrapper input { width: 100% !important; max-width: 100% !important; }
        }

        @media (max-width: 768px) {
            .main-content { padding: 12px; }
            .form-grid { grid-template-columns: 1fr; gap: 14px; }
            .form-group.two-third { grid-column: 1; }
            .form-body { padding: 16px; }
            .form-header { padding: 14px 16px; }
            .table-header, .case-row { grid-template-columns: 22px 42px 50px 1fr 62px; gap: 12px; font-size: 0.75rem; padding: 8px 6px; }
            .table-header > *:nth-child(4), .case-row > *:nth-child(4) { display: none; } /* Hide Category */
            .table-header > *:nth-child(5), .case-row > *:nth-child(5) { display: none; } /* Hide Subcategory */
            .table-header > *:nth-child(8), .case-row > *:nth-child(8) { display: none; } /* Hide F/U */
            .table-header > *:nth-child(9), .case-row > *:nth-child(9) { display: none; } /* Hide Match */
            .status-badge { font-size: 0.6rem; padding: 2px 5px; }
            .channel-badge { font-size: 0.6rem; padding: 2px 5px; }
            .filter-bar { flex-wrap: wrap; gap: 8px; }
            .search-box { width: 100%; max-width: none; }
            .pagination-container { flex-direction: column; align-items: stretch; text-align: center; }
            .pagination-controls { justify-content: center; }
            .dashboard-controls { flex-direction: column; gap: 8px; }
            .filter-controls { flex-direction: row; align-items: stretch; gap: 8px; flex-wrap: wrap; }
            .date-filter { flex-direction: column; align-items: flex-start; padding: 8px 12px; min-width: auto; flex: 1; }
            .date-filter label { font-size: 0.7rem; }
            .date-filter select { font-size: 0.85rem; width: 100%; }
            .date-filter input[type="month"], .date-filter input[type="date"] { width: 100%; max-width: 100%; box-sizing: border-box; }
            .channel-filter { flex-direction: row; align-items: center; gap: 6px; padding: 8px 12px; }
            .channel-filter label { display: none; }
            .channel-toggle { padding: 6px 8px; }
            .channel-toggle .channel-label { display: none; }
            .channel-toggle .check-icon { display: none; }
            .channel-toggle .channel-icon { font-size: 0.9rem; }
            .channel-toggle:not(.active) { opacity: 0.4 !important; }
            .channel-toggle.active { opacity: 1 !important; }
            .stats-grid { gap: 8px; }
            .stat-card { padding: 10px; gap: 8px; min-width: calc(50% - 4px); }
            .stat-icon { width: 32px; height: 32px; font-size: 0.9rem; }
            .stat-info h3 { font-size: 1.1rem; }
            .stat-info p { font-size: 0.65rem; }
            /* Header tabs for tablet */
            .header-tabs { gap: 2px; padding: 3px; }
            .header-tab { padding: 6px 10px; font-size: 0.8rem; }
            .btn-group { flex-direction: column; gap: 10px; }
            .btn-group .btn { width: 100%; }
            .templates-inline { gap: 8px; }
            .template-chip { padding: 6px 10px; font-size: 0.8rem; }
        }

        @media (max-width: 480px) {
            .main-content { padding: 10px; }
            .header { gap: 12px; padding: 8px 10px; }
            .logo-text { display: none; }
            .logo-icon { width: 30px; height: 30px; font-size: 0.9rem; }
            .header-tabs { flex: 1; }
            .header-tab { padding: 6px 0; font-size: 0.85rem; flex: 1 1 0; min-width: 0; justify-content: center; }
            .tab-text { display: none; }
            .header-right { gap: 6px; }
            .theme-toggle { width: 30px; height: 30px; font-size: 0.85rem; }
            .user-avatar { width: 28px; height: 28px; font-size: 0.7rem; }
            .user-menu { padding: 2px 4px; gap: 4px; }
            .stats-grid { gap: 6px; }
            .stat-card { padding: 8px; gap: 6px; min-width: calc(50% - 3px); }
            .stat-icon { width: 28px; height: 28px; font-size: 0.8rem; }
            .stat-info h3 { font-size: 1rem; }
            .stat-info p { font-size: 0.6rem; }
            .user-name { display: none; }
            .form-body { padding: 12px; }
            .form-header { padding: 12px; }
            .form-header h2 { font-size: 1rem; flex-wrap: wrap; }
            .form-input, .form-select, .form-textarea { padding: 10px 12px; font-size: 16px; }
            #jobIdHeader { margin-top: 8px; }
            .case-detail-header { flex-wrap: nowrap; gap: 8px; margin-bottom: 12px; }
            .case-detail-header .back-btn { width: 32px; height: 32px; flex-shrink: 0; }
            .case-detail-header .case-detail-title { min-width: 0; }
            .case-detail-header .case-detail-title h2 { font-size: 0.85rem; gap: 6px; }
            .case-detail-header .case-detail-title p { font-size: 0.75rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
            .case-detail-header .job-id { font-size: 0.8rem; }
            .case-detail-header .channel-badge, .case-detail-header .status-badge, .case-detail-header .ticket-badge { font-size: 0.6rem; padding: 2px 6px; }
            .case-detail-header .btn { padding: 6px 10px; font-size: 0.7rem; white-space: nowrap; }
            .case-detail-header .btn i { margin-right: 0; }
            .case-detail-header .btn span.btn-text { display: none; }
            .detail-row { flex-direction: column; gap: 4px; }
            .detail-label { width: 100%; font-weight: 600; }
            .follow-up-info { flex-direction: column; text-align: center; }
        }

        /* Prevent horizontal overflow but allow dropdown options to show */
        .form-card { max-width: 100%; overflow: visible; }
        .form-body, .form-grid { max-width: 100%; overflow: visible; }
        .form-group { overflow: visible; }
        .form-input, .form-select, .form-textarea { width: 100%; max-width: 100%; box-sizing: border-box; }
        input[type="date"], input[type="time"] { min-width: 0; }

        /* Duration input wrapper with warning */
        .duration-input-wrapper { position: relative; }
        .duration-warning, .others-warning { display: flex; align-items: center; gap: 4px; margin-top: 4px; padding: 4px 8px; background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(245, 158, 11, 0.08)); border: 1px solid var(--warning); border-radius: 6px; color: var(--warning); font-size: 0.75rem; font-weight: 500; animation: pulse-warning 2s ease-in-out infinite; }
        @keyframes pulse-warning { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .dark .duration-warning, .dark .others-warning { background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1)); }

        /* Date range display - responsive */
        .date-cell { white-space: nowrap; }
        .date-range-mobile { display: none; color: var(--text-muted); }
        .date-range-mobile::before { content: ''; }
        @media (max-width: 600px) {
            .date-range-desktop { display: none; }
            .date-range-mobile { display: inline; }
        }

        /* Custom Dropdown Styles (iOS Safari fix) */
        .custom-dropdown {
            position: relative;
            width: 100%;
        }
        .custom-dropdown-selected {
            padding: 12px 14px;
            padding-right: 36px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .custom-dropdown-selected::after {
            content: '';
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            border: 5px solid transparent;
            border-top-color: var(--text-secondary);
        }
        .custom-dropdown-selected:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }
        .custom-dropdown-selected.placeholder {
            color: var(--text-muted);
        }
        .custom-dropdown-options {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 250px;
            overflow-y: auto;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            margin-top: 4px;
        }
        .custom-dropdown.open .custom-dropdown-options {
            display: block;
        }
        .custom-dropdown-option {
            padding: 10px 14px;
            cursor: pointer;
            transition: background 0.15s;
            font-size: 1rem;
        }
        .custom-dropdown-option:hover {
            background: var(--bg-tertiary);
        }
        .custom-dropdown-option.selected {
            background: var(--accent-primary);
            color: white;
        }
        /* Dropup variant - opens upward for dropdowns near bottom of page */
        .custom-dropdown.dropup .custom-dropdown-options {
            top: auto;
            bottom: 100%;
            margin-top: 0;
            margin-bottom: 4px;
        }
        .custom-dropdown.dropup .custom-dropdown-selected::after {
            border-top-color: transparent;
            border-bottom-color: var(--text-secondary);
            transform: translateY(-50%);
        }
        @media (max-width: 768px) {
            .custom-dropdown-selected, .custom-dropdown-option {
                padding: 10px 12px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="login-logo"><i class="fas fa-headset"></i></div>
            <h1 class="login-title">Helpdesk Logger</h1>
            <p class="login-subtitle">Sign in to access your cases</p>
            <div id="googleSignInButton" style="display:flex;justify-content:center;"></div>
            <div id="loginStatus" style="margin-top: 16px; display: none;"></div>
            <div id="loginSpinner" style="margin-top: 20px; display: none; text-align: center; color: var(--text-muted);">
                <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem;"></i>
                <p style="margin-top: 8px; font-size: 0.9rem;">Verifying access...</p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appContainer">
        <header class="header">
            <div class="logo"><div class="logo-icon"><i class="fas fa-headset"></i></div><span class="logo-text">Helpdesk Logger</span></div>
            <div class="header-tabs">
                <button class="header-tab active" onclick="navigateTo('dashboard')"><i class="fas fa-chart-pie"></i> <span class="tab-text">Dashboard</span></button>
                <button class="header-tab" onclick="navigateTo('newCase')"><i class="fas fa-plus"></i> <span class="tab-text">New Case</span></button>
                <button class="header-tab" id="adminTab" onclick="navigateTo('admin')" style="display: none;"><i class="fas fa-cog"></i> <span class="tab-text">Admin</span></button>
            </div>
            <div class="header-right">
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme"><i class="fas fa-moon" id="themeIcon"></i></button>
                <div class="user-menu" onclick="logout()">
                    <div class="user-avatar" id="userAvatar">PC</div>
                    <span class="user-name" id="userName">Peter Chan</span>
                    <i class="fas fa-sign-out-alt" style="color: var(--text-muted); margin-left: 4px;"></i>
                </div>
            </div>
        </header>

        <main class="main-content">

            <!-- Dashboard View -->
            <div id="dashboardView" class="view-container">
                <div class="dashboard-controls">
                    <div class="filter-controls">
                        <div class="date-filter">
                            <label><i class="fas fa-calendar-alt"></i> Period</label>
                            <button class="period-button" id="periodButton" onclick="showPeriodModal()">
                                <i class="fas fa-calendar-alt"></i>
                                <span id="periodButtonText">Last 30 Days</span>
                                <i class="fas fa-exclamation-triangle period-warning-icon" id="periodWarningIcon" style="display:none;" title="Some spreadsheets are missing"></i>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <input type="hidden" id="dateFilter" value="30days">
                            <div class="data-loaded-range" id="dataLoadedRange"></div>
                        </div>
                        <div class="channel-filter">
                            <label><i class="fas fa-building"></i> Channel</label>
                            <div class="channel-toggles">
                                <button class="channel-toggle agency active" data-channel="Agency" onclick="toggleChannel(this)" title="Agency"><i class="fas fa-building channel-icon"></i><i class="fas fa-check check-icon"></i><span class="channel-label">Agency</span></button>
                                <button class="channel-toggle broker active" data-channel="Broker" onclick="toggleChannel(this)" title="Broker"><i class="fas fa-handshake channel-icon"></i><i class="fas fa-check check-icon"></i><span class="channel-label">Broker</span></button>
                                <button class="channel-toggle banca active" data-channel="Banca" onclick="toggleChannel(this)" title="Banca"><i class="fas fa-university channel-icon"></i><i class="fas fa-check check-icon"></i><span class="channel-label">Banca</span></button>
                            </div>
                        </div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card" onclick="filterByStat('total')" id="statCardTotal">
                            <div class="stat-icon blue"><i class="fas fa-phone-alt"></i></div>
                            <div class="stat-info"><h3 id="statTotal">0</h3><p>Total Cases</p></div>
                        </div>
                        <div class="stat-card" onclick="filterByStat('pending')" id="statCardPending">
                            <div class="stat-icon orange"><i class="fas fa-clock"></i></div>
                            <div class="stat-info"><h3 id="statPending">0</h3><p>Pending</p></div>
                        </div>
                        <div class="stat-card" onclick="filterByStat('escalated')" id="statCardEscalated">
                            <div class="stat-icon purple"><i class="fas fa-arrow-up"></i></div>
                            <div class="stat-info"><h3 id="statEscalated">0</h3><p>Escalated</p></div>
                        </div>
                        <div class="stat-card" onclick="filterByStat('resolved')" id="statCardResolved">
                            <div class="stat-icon green"><i class="fas fa-check-circle"></i></div>
                            <div class="stat-info"><h3 id="statResolved">0</h3><p>Resolved</p></div>
                        </div>
                    </div>
                </div>

                <div class="filter-bar">
                    <div class="colleague-filter-container" id="colleagueFilterContainer" style="display: none;">
                        <select id="dashboardColleagueFilter" onchange="handleDashboardColleagueChange()">
                            <option value="all">All Helpdesk</option>
                        </select>
                    </div>
                    <div class="search-box" id="searchBox">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search contact, tel, ticket, agent..." id="searchInput" oninput="handleSearchInput()">
                        <i class="fas fa-times search-clear" onclick="clearSearch()" title="Clear search"></i>
                    </div>
                </div>

                <div class="cases-table" id="casesTable">
                    <div class="table-header">
                        <div class="checkbox-cell"><input type="checkbox" class="case-checkbox" id="selectAllCases" onchange="toggleSelectAll(this)"></div>
                        <div class="sortable-header active" onclick="sortByColumn('date')" data-column="date">Date <i class="fas fa-sort-down sort-icon" id="sort-date-icon"></i></div>
                        <div class="sortable-header created-by-col" id="createdByHeader" onclick="sortByColumn('createdBy')" data-column="createdBy" style="display: none;">Created By <i class="fas fa-sort sort-icon" id="sort-createdBy-icon"></i></div>
                        <div class="sortable-header" onclick="sortByColumn('channel')" data-column="channel">Channel <i class="fas fa-sort sort-icon" id="sort-channel-icon"></i></div>
                        <div class="sortable-header" onclick="sortByColumn('category')" data-column="category">Category <i class="fas fa-sort sort-icon" id="sort-category-icon"></i></div>
                        <div class="sortable-header" onclick="sortByColumn('subcategory')" data-column="subcategory">Subcategory <i class="fas fa-sort sort-icon" id="sort-subcategory-icon"></i></div>
                        <div class="sortable-header" onclick="sortByColumn('contact')" data-column="contact">Contact <i class="fas fa-sort sort-icon" id="sort-contact-icon"></i></div>
                        <div class="sortable-header" onclick="sortByColumn('status')" data-column="status">Status <i class="fas fa-sort sort-icon" id="sort-status-icon"></i></div>
                        <div>F/U</div>
                        <div class="match-header" title="Search matches in hidden fields"><i class="fas fa-search"></i></div>
                    </div>
                    <div id="casesList"></div>
                    <div class="table-loading-overlay" id="tableLoadingOverlay" style="display: none;">
                        <div class="table-loading-spinner"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
                    </div>
                    <div class="pagination-container" id="paginationContainer">
                        <div class="pagination-info">
                            <span>Show </span>
                            <select class="page-size-select" id="pageSizeSelect" onchange="changePageSize(this.value)">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                            <span> per page | Showing <span id="showingRange">0-0</span> of <span id="totalCases">0</span> cases</span>
                        </div>
                        <div class="pagination-controls">
                            <button class="pagination-btn" id="prevPageBtn" onclick="goToPage(currentPage - 1)" disabled><i class="fas fa-chevron-left"></i></button>
                            <div class="page-numbers" id="pageNumbers"></div>
                            <button class="pagination-btn" id="nextPageBtn" onclick="goToPage(currentPage + 1)" disabled><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                </div>

                <!-- Bulk Action Bar -->
                <div class="bulk-action-bar" id="bulkActionBar">
                    <span class="selected-count"><span id="selectedCount">0</span> selected</span>
                    <button class="btn btn-success" onclick="bulkCloseCases()"><i class="fas fa-check"></i> Close Selected</button>
                    <button class="btn btn-secondary" onclick="clearSelection()"><i class="fas fa-times"></i> Cancel</button>
                </div>
            </div>

            <!-- New Case Form -->
            <div id="newCaseView" class="form-container">
                <div class="form-card">
                    <div class="form-header">
                        <button type="button" class="back-btn" id="formBackBtn" onclick="goBackFromEdit()" style="display: none;"><i class="fas fa-arrow-left"></i></button>
                        <h2><i class="fas fa-plus-circle" style="color: var(--accent-primary)" id="formIcon"></i><span id="formTitle">Create New Case</span><span id="jobIdHeader" style="margin-left: 12px; padding: 4px 12px; background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 20px; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem;">-</span></h2>
                    </div>
                    <div class="form-body">
                        <div class="follow-up-info" id="followUpInfo" style="display: none;">
                            <i class="fas fa-link"></i>
                            <p>Creating follow-up for: <strong id="followUpJobId">-</strong></p>
                        </div>
                        <div class="follow-up-info" id="clonedFromInfo" style="display: none; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(139, 92, 246, 0.05)); border-color: var(--purple);">
                            <i class="fas fa-clone" style="color: var(--purple);"></i>
                            <p>Cloned from: <strong id="clonedFromJobId">-</strong> <span style="color: var(--text-muted); font-weight: normal;">(This will be a new original case)</span></p>
                        </div>
                        <form id="caseForm" onsubmit="saveCase(event)">
                            <input type="hidden" id="isNewJob" value="Y">
                            <input type="hidden" id="originalJobId" value="">
                            <input type="hidden" id="editingCaseId" value="">
                            <div class="form-grid">
                                <div class="form-group"><label class="form-label">Call Date <span class="required">*</span></label><input type="date" class="form-input" id="callDate" required></div>
                                <div class="form-group"><label class="form-label">Start Time <span class="required">*</span></label><input type="time" class="form-input" id="startTime" required onchange="onStartTimeChange()"></div>
                                <div class="form-group"><label class="form-label">End Time <span class="required">*</span></label><input type="time" class="form-input" id="endTime" required onchange="onEndTimeChange()"></div>
                                <div class="form-group"><label class="form-label">Duration (min) <span class="required">*</span></label><div class="duration-input-wrapper"><input type="number" class="form-input" id="duration" min="1" value="1" required onchange="onDurationChange()"><span class="duration-warning" id="durationWarning" style="display:none;"><i class="fas fa-exclamation-triangle"></i> Over 1 hour</span></div></div>
                                <div class="form-group"><label class="form-label">Source <span class="required">*</span></label><input type="hidden" id="source" required><div class="custom-dropdown" id="sourceDropdown"><div class="custom-dropdown-selected placeholder" tabindex="0" onclick="toggleCustomDropdown('source')" onkeydown="handleDropdownKey(event, 'source')">Select...</div><div class="custom-dropdown-options"></div></div></div>
                                <div class="form-group full-width">
                                    <label class="form-label">Channel <span class="required">*</span></label>
                                    <input type="hidden" id="channel" required>
                                    <div class="channel-selector">
                                        <div class="channel-option agency" onclick="selectChannel('Agency')"><i class="fas fa-building"></i><span>Agency</span></div>
                                        <div class="channel-option broker" onclick="selectChannel('Broker')"><i class="fas fa-handshake"></i><span>Broker</span></div>
                                        <div class="channel-option banca" onclick="selectChannel('Banca')"><i class="fas fa-university"></i><span>Banca</span></div>
                                    </div>
                                </div>
                                <div class="form-section-divider"><span>Contact Information</span></div>
                                <div class="form-group"><label class="form-label">Contact Person</label><input type="text" class="form-input" id="contactPerson" placeholder="e.g. Mr. John Cheung" onblur="formatContactPerson(this)"></div>
                                <div class="form-group"><label class="form-label">Tel No. <span class="required">*</span></label><input type="tel" class="form-input" id="telNo" placeholder="e.g. 9876-5432" maxlength="9" required onblur="formatTelNo(this)" oninput="formatTelNoInput(this)"></div>
                                <div class="form-group"><label class="form-label">Agent Code</label><input type="text" class="form-input uppercase-input" id="agentCode" placeholder="e.g. Z0S123" maxlength="6"></div>
                                <div class="form-group"><label class="form-label">Location (if on-site)</label><select class="form-select" id="location"><option value="">Not required</option><option value="MU Tower">MU Tower</option><option value="Harbour Front">Harbour Front</option><option value="Gateway">Gateway</option><option value="Other">Other</option></select></div>
                                <div class="form-section-divider"><span>Case Classification</span><button type="button" class="classification-helper-btn" onclick="showClassificationWizard()"><i class="fas fa-magic"></i> Helper</button></div>
                                <div class="templates-inline" id="templatesSection">
                                    <span class="template-chip" onclick="applyTemplate('login')"><i class="fas fa-key" style="color: var(--accent-primary)"></i> Login Issue</span>
                                    <span class="template-chip" onclick="applyTemplate('app')"><i class="fas fa-mobile-alt" style="color: var(--purple)"></i> App Error</span>
                                    <span class="template-chip" onclick="applyTemplate('training')"><i class="fas fa-graduation-cap" style="color: var(--success)"></i> Training</span>
                                    <span class="template-chip" onclick="applyTemplate('device')"><i class="fas fa-laptop" style="color: var(--warning)"></i> Device</span>
                                    <span class="template-chip" onclick="applyTemplate('google')"><i class="fas fa-envelope" style="color: #4285F4"></i> Google</span>
                                    <span class="template-chip" onclick="applyTemplate('print')"><i class="fas fa-print" style="color: var(--text-secondary)"></i> Print</span>
                                    <span class="template-chip" onclick="applyTemplate('network')"><i class="fas fa-wifi" style="color: var(--info)"></i> Network</span>
                                </div>
                                <div class="form-group"><label class="form-label">Case Type <span class="required">*</span></label><input type="hidden" id="caseType" required><div class="custom-dropdown" id="caseTypeDropdown"><div class="custom-dropdown-selected placeholder" tabindex="0" onclick="toggleCustomDropdown('caseType')" onkeydown="handleDropdownKey(event, 'caseType')">Select...</div><div class="custom-dropdown-options"></div></div></div>
                                <div class="form-group"><label class="form-label">Category <span class="required">*</span></label><input type="hidden" id="category" required><div class="custom-dropdown" id="categoryDropdown"><div class="custom-dropdown-selected placeholder" tabindex="0" onclick="toggleCustomDropdown('category')" onkeydown="handleDropdownKey(event, 'category')">Select...</div><div class="custom-dropdown-options"></div></div></div>
                                <div class="form-group"><label class="form-label">Subcategory <span class="required">*</span></label><input type="hidden" id="subcategory" required><div class="custom-dropdown" id="subcategoryDropdown"><div class="custom-dropdown-selected placeholder" tabindex="0" onclick="toggleCustomDropdown('subcategory')" onkeydown="handleDropdownKey(event, 'subcategory')">Select...</div><div class="custom-dropdown-options"></div></div><span class="others-warning" id="subcategoryOthersWarning" style="display:none;"><i class="fas fa-exclamation-triangle"></i> "Others" is not recommended. Please select a more specific option if possible.</span></div>
                                <div class="form-group"><label class="form-label">Subject <span class="required">*</span></label><input type="hidden" id="subject" required><div class="custom-dropdown" id="subjectDropdown"><div class="custom-dropdown-selected placeholder" tabindex="0" onclick="toggleCustomDropdown('subject')" onkeydown="handleDropdownKey(event, 'subject')">Select...</div><div class="custom-dropdown-options"></div></div><span class="others-warning" id="subjectOthersWarning" style="display:none;"><i class="fas fa-exclamation-triangle"></i> "Others" is not recommended. Please select a more specific option if possible.</span></div>
                                <div class="form-group full-width"><label class="form-label">Symptom / Description <span class="required">*</span></label><div class="autocomplete-wrapper"><textarea class="form-textarea" id="symptom" placeholder="Describe the issue in detail..." required oninput="showAutocomplete('symptom', this.value)" onkeydown="handleAutocompleteKey(event, 'symptom')" onfocus="showAutocomplete('symptom', this.value)"></textarea><div class="autocomplete-list" id="symptom-autocomplete"></div></div><div class="autocomplete-hint"><i class="fas fa-lightbulb"></i> Start typing to see suggestions from previous cases</div></div>
                                <div class="form-section-divider"><span>Resolution</span></div>
                                <div class="form-group two-third"><label class="form-label">Action Taken</label><div class="autocomplete-wrapper"><textarea class="form-textarea" id="actionDetail" placeholder="What actions were taken..." oninput="showAutocomplete('actionDetail', this.value)" onkeydown="handleAutocompleteKey(event, 'actionDetail')" onfocus="showAutocomplete('actionDetail', this.value)"></textarea><div class="autocomplete-list" id="actionDetail-autocomplete"></div></div><div class="autocomplete-hint"><i class="fas fa-lightbulb"></i> Start typing to see suggestions</div></div>
                                <div class="form-group" id="escalateField"><label class="form-label">Escalate Ticket No.</label><input type="text" class="form-input uppercase-input" id="escalateTicket" placeholder="Incident / Service Now Ticket No."></div>
                                <div class="form-group" id="actionResultGroup"><label class="form-label">Case Status <span class="required">*</span></label><input type="hidden" id="actionResult" required><div class="custom-dropdown dropup" id="actionResultDropdown"><div class="custom-dropdown-selected placeholder" tabindex="0" onclick="toggleCustomDropdown('actionResult')" onkeydown="handleDropdownKey(event, 'actionResult')">Select...</div><div class="custom-dropdown-options"></div></div></div>
                            </div>
                        </form>
                    </div>
                </div>
                <!-- Fixed button footer for form -->
                <div class="form-buttons-fixed" id="formButtonGroup">
                    <button type="button" class="btn btn-secondary" id="clearCancelBtn" onclick="handleClearCancel()"><i class="fas fa-times" id="clearCancelIcon"></i> <span id="clearCancelText">Clear</span></button>
                    <button type="submit" form="caseForm" class="btn btn-primary"><i class="fas fa-save"></i> Save Case</button>
                </div>
            </div>

            <!-- Case Detail View -->
            <div id="caseDetailView" class="case-detail-container">
                <div class="case-detail-header">
                    <button class="back-btn" onclick="showView('dashboard')"><i class="fas fa-arrow-left"></i></button>
                    <div class="case-detail-title">
                        <h2><span class="job-id" id="detailJobId">-</span><span class="channel-badge" id="detailChannel">-</span><span class="status-badge" id="detailStatus">-</span><span class="ticket-badge" id="detailTicket" style="display:none;"><i class="fas fa-ticket-alt"></i> <span id="detailTicketNo">-</span></span></h2>
                        <p id="detailSubject">-</p>
                    </div>
                    <button class="btn btn-success" onclick="closeCase()" id="closeBtn" style="display:none;"><i class="fas fa-check"></i> <span class="btn-text">Close Case</span></button>
                    <button class="btn btn-primary" onclick="createFollowUp()" id="followUpBtn"><i class="fas fa-plus"></i> <span class="btn-text">Follow-up</span></button>
                </div>
                <div class="detail-grid">
                    <div><div class="detail-card"><div class="detail-card-header"><div class="detail-card-header-left"><i class="fas fa-info-circle" style="color: var(--accent-primary)"></i> Case Details<button class="btn btn-danger-outline" onclick="confirmDeleteCase()" id="deleteBtn" style="padding: 6px 10px; font-size: 0.8rem; margin-left: 12px;" title="Delete Case"><i class="fas fa-trash-alt"></i></button></div><div style="display: flex; gap: 8px;"><button class="btn btn-secondary" onclick="confirmCloneCase()" id="cloneBtn" style="padding: 8px 16px; font-size: 0.85rem;"><i class="fas fa-clone"></i> Clone</button><button class="btn btn-primary" onclick="editCase()" id="editBtn" style="padding: 8px 16px; font-size: 0.85rem;"><i class="fas fa-edit"></i> Edit</button></div></div><div class="detail-card-body" id="caseDetails"></div></div></div>
                    <div><div class="detail-card"><div class="detail-card-header"><div class="detail-card-header-left"><i class="fas fa-history" style="color: var(--purple)"></i> Timeline</div></div><div class="detail-card-body"><div class="timeline" id="caseTimeline"></div></div></div></div>
                </div>

                <!-- Mobile Timeline Drawer -->
                <div class="timeline-drawer-overlay" id="timelineDrawerOverlay" onclick="toggleTimelineDrawer()"></div>
                <div class="timeline-drawer" id="timelineDrawer">
                    <div class="timeline-drawer-header">
                        <h3><i class="fas fa-history" style="color: var(--purple)"></i> Timeline</h3>
                        <button class="timeline-drawer-close" onclick="toggleTimelineDrawer()"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="timeline" id="mobileTimeline"></div>
                </div>
                <div class="timeline-drawer-tab" id="timelineDrawerTab" onclick="toggleTimelineDrawer()">
                    <i class="fas fa-history"></i> Timeline
                </div>
            </div>

            <!-- Admin View -->
            <div id="adminView" class="form-container">
                <div class="admin-header">
                    <h2><i class="fas fa-cog" style="color: var(--warning);"></i> Admin Panel</h2>
                    <p class="admin-subtitle">Manage users and view reports</p>
                </div>

                <div class="admin-tabs">
                    <button class="admin-tab active" onclick="showAdminTab('users')"><i class="fas fa-users"></i> User Management</button>
                    <button class="admin-tab" onclick="showAdminTab('helpdeskCases')"><i class="fas fa-headset"></i> Helpdesk Cases</button>
                    <button class="admin-tab" onclick="showAdminTab('reports')"><i class="fas fa-chart-bar"></i> Reports</button>
                </div>

                <!-- User Management Tab -->
                <div id="adminUsersTab" class="admin-tab-content active">
                    <div class="admin-actions">
                        <button class="btn btn-primary" onclick="showAddUserModal()"><i class="fas fa-plus"></i> Add User</button>
                    </div>
                    <div class="admin-table">
                        <div class="admin-table-header">
                            <div>Name</div>
                            <div>Email</div>
                            <div>Role</div>
                            <div>Worksheet</div>
                            <div>Status</div>
                            <div>Helpdesk</div>
                            <div>Actions</div>
                        </div>
                        <div id="adminUserList"></div>
                    </div>
                </div>

                <!-- Helpdesk Cases Tab -->
                <div id="adminHelpdeskTab" class="admin-tab-content">
                    <div class="admin-helpdesk-controls">
                        <div class="admin-filter-row">
                            <div class="admin-period-filter">
                                <label><i class="fas fa-calendar-alt"></i> Period</label>
                                <button class="period-button" id="adminPeriodButton" onclick="showPeriodModal('admin')">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span id="adminPeriodButtonText">Last 30 Days</span>
                                    <i class="fas fa-exclamation-triangle period-warning-icon" id="adminPeriodWarningIcon" style="display:none;" title="Some spreadsheets are missing"></i>
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                <input type="hidden" id="adminPeriodFilter" value="30days">
                                <div class="data-loaded-range" id="adminDataLoadedRange"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Per-User Summary Section (Team Breakdown) -->
                    <div class="admin-user-summary" id="adminUserSummary" style="display: block;">
                        <div class="summary-header">
                            <h3><i class="fas fa-users"></i> Team Breakdown</h3>
                        </div>
                        <div class="summary-content" id="summaryContent">
                            <div class="summary-table">
                                <div class="summary-table-header">
                                    <div>Colleague</div>
                                    <div class="text-center">Total</div>
                                    <div class="text-center">Agency</div>
                                    <div class="text-center">Broker</div>
                                    <div class="text-center">Banca</div>
                                    <div class="text-center">Pending</div>
                                    <div class="text-center">Escalated</div>
                                    <div class="text-center">Closed</div>
                                    <div class="text-center">Avg Min</div>
                                </div>
                                <div id="summaryTableBody">
                                    <div class="admin-empty-state" style="padding: 40px;">
                                        <i class="fas fa-chart-bar"></i>
                                        <p>No data available for the selected period</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Tab -->
                <div id="adminReportsTab" class="admin-tab-content">
                    <div class="reports-placeholder">
                        <i class="fas fa-chart-line" style="font-size: 3rem; color: var(--text-muted);"></i>
                        <h3>Management Reports</h3>
                        <p>Coming soon - View team statistics and generate reports</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit User Modal -->
    <div class="modal-overlay" id="userModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userModalTitle"><i class="fas fa-user-plus"></i> Add User</h3>
                <button class="modal-close" onclick="closeUserModal()"><i class="fas fa-times"></i></button>
            </div>
            <form id="userForm" onsubmit="saveUser(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Full Name <span class="required">*</span></label>
                        <input type="text" class="form-input" id="userNameInput" placeholder="e.g. Peter Chan" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email <span class="required">*</span></label>
                        <input type="email" class="form-input" id="userEmailInput" placeholder="e.g. peter.chan@company.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Initials <span class="required">*</span></label>
                        <input type="text" class="form-input" id="userInitialsInput" placeholder="e.g. PC" maxlength="3" style="text-transform: uppercase;" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Worksheet <span class="required">*</span></label>
                        <select class="form-select" id="userWorksheetInput" required>
                            <option value="">Select worksheet...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role <span class="required">*</span></label>
                        <select class="form-select" id="userRoleInput" required>
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="userStatusInput">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Is Helpdesk</label>
                        <select class="form-select" id="userIsHelpdeskInput">
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                        </select>
                        <small style="color: var(--text-muted); font-size: 0.75rem; margin-top: 4px; display: block;">Helpdesk users can create and manage cases</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeUserModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save</button>
                </div>
                <input type="hidden" id="editingUserEmail" value="">
            </form>
        </div>
    </div>

    <!-- Full Period Modal -->
    <div class="modal-overlay" id="periodModal">
        <div class="modal-content period-modal">
            <div class="modal-header">
                <h2><i class="fas fa-calendar-alt"></i> Select Period</h2>
                <button class="modal-close" onclick="hidePeriodModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <!-- Preset Period Buttons -->
                <div class="period-presets">
                    <button class="period-preset-btn" data-period="today" onclick="selectPeriodPreset('today')">
                        <i class="fas fa-calendar-day"></i> Today
                    </button>
                    <button class="period-preset-btn" data-period="7days" onclick="selectPeriodPreset('7days')">
                        <i class="fas fa-calendar-week"></i> Last 7 Days
                    </button>
                    <button class="period-preset-btn active" data-period="30days" onclick="selectPeriodPreset('30days')">
                        <i class="fas fa-calendar"></i> Last 30 Days
                    </button>
                    <button class="period-preset-btn" data-period="thisMonth" onclick="selectPeriodPreset('thisMonth')">
                        <i class="fas fa-calendar-alt"></i> This Month
                    </button>
                    <button class="period-preset-btn" data-period="lastMonth" onclick="selectPeriodPreset('lastMonth')">
                        <i class="fas fa-calendar-minus"></i> Last Month
                    </button>
                    <button class="period-preset-btn" data-period="thisYear" onclick="selectPeriodPreset('thisYear')">
                        <i class="fas fa-calendar-check"></i> This Year
                    </button>
                    <button class="period-preset-btn" data-period="lastYear" onclick="selectPeriodPreset('lastYear')">
                        <i class="fas fa-history"></i> Last Year
                    </button>
                </div>

                <!-- Custom Period Section -->
                <div class="period-divider">Custom</div>

                <div class="period-custom-tabs">
                    <button class="period-custom-tab active" data-tab="month" onclick="switchPeriodCustomTab('month')">Month</button>
                    <button class="period-custom-tab" data-tab="year" onclick="switchPeriodCustomTab('year')">Year</button>
                    <button class="period-custom-tab" data-tab="date" onclick="switchPeriodCustomTab('date')">Date</button>
                    <button class="period-custom-tab" data-tab="range" onclick="switchPeriodCustomTab('range')">Range</button>
                </div>

                <div class="period-custom-content">
                    <div class="period-custom-panel active" id="periodPanelMonth">
                        <label>Select Month</label>
                        <input type="month" id="periodMonthPicker" onchange="activateCustomTab('month')">
                    </div>
                    <div class="period-custom-panel" id="periodPanelYear">
                        <label>Select Year</label>
                        <select id="periodYearPicker" onchange="activateCustomTab('year')"></select>
                    </div>
                    <div class="period-custom-panel" id="periodPanelDate">
                        <label>Select Date</label>
                        <input type="date" id="periodDatePicker" onchange="activateCustomTab('date')">
                    </div>
                    <div class="period-custom-panel" id="periodPanelRange">
                        <label>Select Date Range <span class="range-hint">(max 1 year)</span></label>
                        <div class="date-range-inputs">
                            <input type="date" id="periodRangeStart" placeholder="Start" onchange="activateCustomTab('range')">
                            <span class="range-separator">to</span>
                            <input type="date" id="periodRangeEnd" placeholder="End" onchange="activateCustomTab('range')">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hidePeriodModal()">Cancel</button>
                <button type="button" class="btn btn-primary" id="periodApplyBtn" onclick="applyPeriodSelection()"><i class="fas fa-check"></i> Apply</button>
            </div>
        </div>
    </div>

    <!-- Classification Wizard Modal -->
    <div class="modal-overlay" id="classificationWizardModal">
        <div class="modal-content classification-wizard">
            <div class="modal-header">
                <h2><i class="fas fa-magic"></i> Classification Helper</h2>
                <button class="modal-close" onclick="hideClassificationWizard()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <!-- Progress Steps with Labels (dynamically rendered) -->
                <div class="wizard-progress" id="wizardProgress"></div>

                <!-- Wizard Content (dynamically rendered) -->
                <div id="wizardContent"></div>

                <!-- Navigation -->
                <div class="wizard-nav">
                    <button class="btn btn-back" id="wizardBackBtn" onclick="wizardGoBack()" style="display: none;">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <button class="btn btn-secondary" onclick="hideClassificationWizard()">Cancel</button>
                    <button class="btn btn-primary" id="wizardNextBtn" onclick="wizardGoNext()" disabled>
                        Next <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast & Modal -->
    <div class="toast" id="toast"><i class="fas fa-check-circle"></i><span id="toastMessage">Saved!</span></div>
    <div class="confirm-overlay" id="confirmOverlay">
        <div class="confirm-modal">
            <div class="confirm-modal-header"><i class="fas fa-exclamation-triangle"></i><h3 id="confirmTitle">Confirm</h3></div>
            <div class="confirm-modal-body"><p id="confirmMessage">Are you sure?</p></div>
            <div class="confirm-modal-footer" id="confirmFooter"><button class="btn btn-secondary" onclick="closeConfirm()">Cancel</button><button class="btn btn-danger" onclick="executeConfirm()">Confirm</button></div>
        </div>
    </div>

<script>
// Google Apps Script API URL
const API_URL = 'https://script.google.com/macros/s/AKfycbwxWL6kuXGE8KC0TWeN_ThD9f-z62cDvMDdpcI-SngbjSL0Li9uC8_noj_ytJx0cdqO/exec';

// Google OAuth Client ID
const GOOGLE_CLIENT_ID = '891866104091-i9fkn42vbnrd368imrnq186mlb6m00sn.apps.googleusercontent.com';

// Google credential token - set after sign-in, sent with every API call
var googleCredential = null;

// User management - will be loaded from API
let USERS = [];

// Available worksheets - will be loaded from API
let WORKSHEETS = [];

// Loading state
let isLoading = false;

// Dropdown options constants - defined here to ensure consistent ordering across the app
const CASE_TYPES = ["Service", "Incident", "Enquiry"];
const CATEGORIES = ["Business Usage / Training", "Infra / Device", "User Login / Authentication", "Application Functionality / Data Issue", "Staff Service Requests", "Non-Helpdesk Requests"];
const SOURCES = ["Hotline", "WhatsApp", "Private Contact", "Voice Message", "Request from IT"];
const ACTION_RESULTS = ["Pending Follow-up", "Completed"];
const SUBCATEGORIES = ["Digital - AWB", "Digital - SunSmart V8", "Digital - SunSmart (iPad)", "Digital - SunSmart (Web SI)", "Digital - SunSmart MPF", "Digital - SunOffice", "Digital - SunSurf", "Digital - eRecruitment", "Digital - eLearning", "Digital - SunVisual", "Digital - Client App", "GIT - Hardware", "GIT - Printing", "GIT - Google Services", "GIT - Network", "Others"];

const SUBJECTS = {
    general: ["Login / Authentication Issue", "User Access Issue", "Access / Connectivity Issue", "System Performance Issue", "Application Functionality / Data Issue", "Data Sync / Update Issue", "Printing Issue", "Email Issue", "Installation / Update", "Device Setup / Configuration", "Payment Issue", "Application Error / Crash", "Training / How-To Inquiry", "Others"],
    hardware: ["Hardware - Advisor Personal Device", "Hardware - Proposal PC", "Hardware - MFP Printer", "Hardware - Desk Phone", "Others"],
    printing: ["Printing - Printer Driver", "Printing - Print Queue", "Printing - Print Authentication", "Printing - Printing Services", "Others"],
    google: ["Google - Gmail Send / Receive Issue", "Google - Gmail Capacity Issue", "Google - Other Application Services", "Google Authentication (ID & PW / 2FA)", "Others"],
    network: ["Network - Office Wi-Fi", "Network - Personal Device", "Network - Authentication", "Others"]
};

const TEMPLATES = {
    login: { category: "User Login / Authentication", subcategory: "", subject: "Login / Authentication Issue", caseType: "Incident", symptom: "User unable to login to " },
    app: { category: "Application Functionality / Data Issue", subcategory: "", subject: "Application Error / Crash", caseType: "Incident", symptom: "Application showing error: " },
    training: { category: "Business Usage / Training", subcategory: "", subject: "Training / How-To Inquiry", caseType: "Enquiry", symptom: "User enquiring about how to " },
    device: { category: "Infra / Device", subcategory: "GIT - Hardware", subject: "", caseType: "Service", symptom: "Device service request: " },
    google: { category: "Infra / Device", subcategory: "GIT - Google Services", subject: "", caseType: "Service", symptom: "Google service request: " },
    print: { category: "Infra / Device", subcategory: "GIT - Printing", subject: "", caseType: "Service", symptom: "Printing service request: " },
    network: { category: "Infra / Device", subcategory: "GIT - Network", subject: "", caseType: "Service", symptom: "Network service request: " }
};

// Cases will be loaded from API after login
let cases = [];

// Shared helper: Format date as YYYY-MM-DD using LOCAL timezone (not UTC)
// This avoids timezone issues where toISOString() would give wrong date near midnight
function formatLocalDate(date) {
    var year = date.getFullYear();
    var month = String(date.getMonth() + 1).padStart(2, '0');
    var day = String(date.getDate()).padStart(2, '0');
    return year + '-' + month + '-' + day;
}

// Shared helper: Normalize actionResult for consistent handling
// When SAVING to Google Sheet: "Pending Follow-up" -> "Follow"
// When READING from Google Sheet: anything except "Completed" -> "Pending Follow-up"
function normalizeActionResultForSave(actionResult) {
    // Map "Pending Follow-up" to "Follow" for saving
    if (actionResult === 'Pending Follow-up') {
        return 'Follow';
    }
    return actionResult;
}

function normalizeActionResultForDisplay(actionResult) {
    // Map anything except "Completed" to "Pending Follow-up" for display
    if (actionResult === 'Completed') {
        return 'Completed';
    }
    return 'Pending Follow-up';
}

let currentUser = null, currentCaseId = null, confirmCallback = null, activeFilters = { stat: null }, isDarkMode = false;
let selectedChannels = ['Agency', 'Broker', 'Banca'];
// Valid channels - SINGLE SOURCE OF TRUTH for channel filtering across Dashboard and Admin
const VALID_CHANNELS = ['Agency', 'Broker', 'Banca'];
// Admin state
let isAdmin = false;
let helpdeskUsers = [];
let adminCases = [];
let selectedColleague = 'all'; // 'all' or specific worksheet name
let adminCachedStartDate = null;
let adminCachedEndDate = null;
let adminCustomDateRange = null;
// Sorting state - default: date descending (newest first)
let sortColumn = 'date', sortDirection = 'desc';
// Pagination state
let currentPage = 1, pageSize = 10, filteredCases = [];
// Data change tracking - refresh dashboard only when needed
let dataChanged = true; // Start as true to load on first view
let dashboardInitialized = false;
// Search debounce
let searchTimeout = null;
function handleSearchInput() {
    const searchBox = document.getElementById('searchBox');
    const searchInput = document.getElementById('searchInput');
    if (searchBox && searchInput) {
        if (searchInput.value.trim()) {
            searchBox.classList.add('has-value');
        } else {
            searchBox.classList.remove('has-value');
        }
    }
    applyFilters();
}
function clearSearch() {
    const searchInput = document.getElementById('searchInput');
    const searchBox = document.getElementById('searchBox');
    if (searchInput) searchInput.value = '';
    if (searchBox) searchBox.classList.remove('has-value');
    applyFilters();
}

function escapeRegex(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function highlightMatch(text, search) {
    if (!search || !text) return text || '';
    const textStr = String(text);
    const escaped = escapeRegex(search);
    const regex = new RegExp(`(${escaped})`, 'gi');
    return textStr.replace(regex, '<mark>$1<\/mark>');
}

function checkHiddenFieldMatch(search, caseData, relatedCases) {
    if (!search) return { tel: false, agent: false, ticket: false };
    const searchLower = search.toLowerCase();

    // Check Tel No
    const telMatch = [caseData.telNo].concat(relatedCases.map(c => c.telNo))
        .some(val => val && String(val).toLowerCase().includes(searchLower));

    // Check Agent Code
    const agentMatch = [caseData.agentCode].concat(relatedCases.map(c => c.agentCode))
        .some(val => val && String(val).toLowerCase().includes(searchLower));

    // Check Ticket No
    const ticketMatch = [caseData.escalateTicket].concat(relatedCases.map(c => c.escalateTicket))
        .some(val => val && String(val).toLowerCase().includes(searchLower));

    return { tel: telMatch, agent: agentMatch, ticket: ticketMatch };
}

function getMatchIndicatorsHtml(matches, caseData, relatedCases) {
    const icons = [];
    if (matches.tel) {
        const telVal = caseData.telNo || relatedCases.find(c => c.telNo)?.telNo || '';
        icons.push(`<i class="fas fa-phone match-icon" title="Tel: ${telVal}"><\/i>`);
    }
    if (matches.agent) {
        const agentVal = caseData.agentCode || relatedCases.find(c => c.agentCode)?.agentCode || '';
        icons.push(`<i class="fas fa-id-badge match-icon" title="Agent: ${agentVal}"><\/i>`);
    }
    if (matches.ticket) {
        const ticketVal = caseData.escalateTicket || relatedCases.find(c => c.escalateTicket)?.escalateTicket || '';
        icons.push(`<i class="fas fa-ticket-alt match-icon" title="Ticket: ${ticketVal}"><\/i>`);
    }
    return icons.length > 0 ? `<span class="match-indicators">${icons.join('')}<\/span>` : '';
}
let isEditMode = false, editingJobId = null, originalFormData = null;
let threeOptionSaveCallback = null, threeOptionDiscardCallback = null;

async function init() {
    initGoogleSignIn();
}

var gisRetryCount = 0;
var GIS_MAX_RETRIES = 25; // 25 x 200ms = 5 seconds

function initGoogleSignIn() {
    // Check if Client ID is still the placeholder
    if (!GOOGLE_CLIENT_ID || GOOGLE_CLIENT_ID === 'REPLACE_WITH_YOUR_CLIENT_ID.apps.googleusercontent.com') {
        console.error('GOOGLE_CLIENT_ID is not configured. Please replace the placeholder with your actual Client ID.');
        showLoginError('Google Sign-In is not configured. Please set the Client ID in the app code.');
        return;
    }

    // Wait for GIS library to load (with timeout)
    if (typeof google === 'undefined' || !google.accounts) {
        gisRetryCount++;
        if (gisRetryCount > GIS_MAX_RETRIES) {
            console.error('Google Identity Services library failed to load after ' + (GIS_MAX_RETRIES * 200) + 'ms');
            showLoginError('Could not load Google Sign-In. Check your internet connection and try refreshing the page.');
            return;
        }
        setTimeout(initGoogleSignIn, 200);
        return;
    }

    try {
        google.accounts.id.initialize({
            client_id: GOOGLE_CLIENT_ID,
            callback: handleGoogleSignIn
        });
        google.accounts.id.renderButton(
            document.getElementById('googleSignInButton'),
            { theme: 'outline', size: 'large', shape: 'rectangular', text: 'signin_with', width: 300 }
        );
        console.log('Google Sign-In initialized successfully');
    } catch (err) {
        console.error('Google Sign-In initialization error:', err);
        showLoginError('Google Sign-In failed to initialize. Please check the Client ID and try again.');
    }
}

async function handleGoogleSignIn(response) {
    // Show spinner while verifying
    var signInBtn = document.getElementById('googleSignInButton');
    var spinner = document.getElementById('loginSpinner');
    var statusEl = document.getElementById('loginStatus');
    signInBtn.style.display = 'none';
    spinner.style.display = 'block';
    statusEl.style.display = 'none';

    try {
        // Store the Google credential token for API calls
        googleCredential = response.credential;

        // Decode the JWT to get user info
        var payload = JSON.parse(atob(response.credential.split('.')[1]));
        var email = payload.email;

        // Now load users and worksheets from API (token is required)
        showLoadingOverlay('Verifying access...');
        await loadUsersFromAPI();
        await loadWorksheetsFromAPI();
        initAllDropdowns();
        hideLoadingOverlay();

        // Check if user is in the Master Spreadsheet and active
        var user = USERS.find(function(u) {
            return u.email.toLowerCase() === email.toLowerCase();
        });

        if (!user) {
            googleCredential = null;
            showLoginError('Access denied. Your Google account (' + email + ') is not registered in the Helpdesk Logger. Please contact the administrator.');
            return;
        }

        if (!user.isActive) {
            googleCredential = null;
            showLoginError('Your account (' + email + ') is inactive. Please contact the administrator.');
            return;
        }

        if (!user.worksheet) {
            googleCredential = null;
            showLoginError('No worksheet assigned to your account. Please contact the administrator.');
            return;
        }

        if (!WORKSHEETS.includes(user.worksheet)) {
            googleCredential = null;
            showLoginError('Worksheet "' + user.worksheet + '" not found. Please contact the administrator.');
            return;
        }

        // Authentication successful - login as the user
        loginAs(email);

    } catch (err) {
        googleCredential = null;
        hideLoadingOverlay();
        showLoginError('Authentication failed. Please try again.');
    }
}

function showLoginError(message) {
    var signInBtn = document.getElementById('googleSignInButton');
    var spinner = document.getElementById('loginSpinner');
    var statusEl = document.getElementById('loginStatus');
    spinner.style.display = 'none';
    signInBtn.style.display = 'flex';
    statusEl.style.display = 'block';
    statusEl.innerHTML = '<div style="padding: 12px 16px; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); border-radius: 8px; color: var(--danger); font-size: 0.85rem; text-align: center;"><i class="fas fa-exclamation-circle"><\/i> ' + message + '<\/div>';
}

// API Helper functions
async function apiGet(action, params = {}) {
    const url = new URL(API_URL);
    if (googleCredential) url.searchParams.append('token', googleCredential);
    url.searchParams.append('action', action);
    Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));

    const response = await fetch(url.toString(), {
        method: 'GET',
        redirect: 'follow'
    });
    var result = await response.json();
    if (result && result.error === 'Token expired') {
        handleSessionExpired();
        throw new Error('Session expired');
    }
    return result;
}

async function apiPost(action, data, params = {}) {
    // Google Apps Script has CORS issues with POST from different origins
    // Use GET with data encoded in URL as a workaround
    const url = new URL(API_URL);
    if (googleCredential) url.searchParams.append('token', googleCredential);
    url.searchParams.append('action', action);
    Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
    url.searchParams.append('postData', JSON.stringify(data));

    const response = await fetch(url.toString(), {
        method: 'GET',
        redirect: 'follow'
    });
    var result = await response.json();
    if (result && result.error === 'Token expired') {
        handleSessionExpired();
        throw new Error('Session expired');
    }
    return result;
}

function handleSessionExpired() {
    googleCredential = null;
    showToast('Your session has expired. Please sign in again.', 'error');
    setTimeout(function() { logout(); }, 2000);
}

function showLoadingOverlay(message) {
    if (message === undefined) message = 'Loading...';
    var overlay = document.getElementById('loadingOverlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'loadingOverlay';
        overlay.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"><\/i><span>' + message + '<\/span><\/div>';
        overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
        overlay.querySelector('.loading-spinner').style.cssText = 'background:var(--bg-secondary);padding:24px 40px;border-radius:12px;display:flex;align-items:center;gap:12px;font-size:1rem;color:var(--text-primary);';
        document.body.appendChild(overlay);
    } else {
        var spanEl = overlay.querySelector('span');
        if (spanEl && spanEl.textContent !== message) {
            spanEl.textContent = message;
        }
        if (overlay.style.display !== 'flex') {
            overlay.style.display = 'flex';
        }
    }
}

function hideLoadingOverlay() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) overlay.style.display = 'none';
}

function showTableLoading() {
    const overlay = document.getElementById('tableLoadingOverlay');
    if (overlay) overlay.style.display = 'flex';
}

function hideTableLoading() {
    const overlay = document.getElementById('tableLoadingOverlay');
    if (overlay) overlay.style.display = 'none';
}

async function loadUsersFromAPI(retryCount = 0) {
    try {
        const result = await apiGet('getUsers');
        if (result.success) {
            USERS = result.users;
        } else {
            console.error('Failed to load users:', result.error);
            showToast('Failed to load users: ' + result.error, 'error');
        }
    } catch (error) {
        // Retry once on network failure (common in iframe environments)
        if (retryCount < 1) {
            await new Promise(r => setTimeout(r, 500));
            return loadUsersFromAPI(retryCount + 1);
        }
        console.error('API error loading users:', error);
        showToast('Failed to connect to server', 'error');
    }
}

async function loadWorksheetsFromAPI(retryCount = 0) {
    try {
        const result = await apiGet('getWorksheets');
        if (result.success) {
            WORKSHEETS = result.worksheets;
        } else {
            console.error('Failed to load worksheets:', result.error);
        }
    } catch (error) {
        // Retry once on network failure (common in iframe environments)
        if (retryCount < 1) {
            await new Promise(r => setTimeout(r, 500));
            return loadWorksheetsFromAPI(retryCount + 1);
        }
        console.error('API error loading worksheets:', error);
    }
}

/**
 * Unified function to load cases for both admin and non-admin users.
 * Uses QUERY method via API with date range filtering.
 *
 * @param {Object} options - Loading options
 * @param {string} options.startDate - Start date in YYYY-MM-DD format
 * @param {string} options.endDate - End date in YYYY-MM-DD format
 * @param {Array} options.worksheets - Array of {worksheet, userName} objects to load (admin) or single worksheet string (regular user)
 * @param {boolean} options.showProgress - Whether to show loading progress (default: true)
 * @param {string} options.progressPrefix - Prefix for progress message (default: 'Loading cases...')
 * @returns {Promise<Array>} Array of case objects
 */
async function loadCases(options) {
    var startDate = options.startDate;
    var endDate = options.endDate;
    var worksheets = options.worksheets;
    var showProgress = options.showProgress !== false;
    var progressPrefix = options.progressPrefix || 'Loading cases...';

    try {
        var allCases = [];
        var actualStartDate = null;
        var actualEndDate = null;

        // Normalize worksheets to array format
        var worksheetList = [];
        if (typeof worksheets === 'string') {
            // Single worksheet (regular user)
            worksheetList = [{ worksheet: worksheets, userName: currentUser ? currentUser.name : '' }];
        } else if (Array.isArray(worksheets)) {
            worksheetList = worksheets;
        } else {
            console.error('Invalid worksheets parameter');
            return { cases: [], actualStartDate: null, actualEndDate: null };
        }

        var totalWorksheets = worksheetList.length;

        // Show loading overlay once at start (avoid repeated updates which cause flashing)
        if (showProgress) {
            if (totalWorksheets > 1) {
                showLoadingOverlay(progressPrefix + ' (0 of ' + totalWorksheets + ' colleagues)');
            } else {
                showLoadingOverlay(progressPrefix);
            }
        }

        for (var i = 0; i < worksheetList.length; i++) {
            var ws = worksheetList[i];

            // Update progress message less frequently to reduce DOM updates
            if (showProgress && totalWorksheets > 1) {
                updateLoadingMessage(progressPrefix + ' (' + (i + 1) + ' of ' + totalWorksheets + ')');
            }

            try {
                var params = { worksheet: ws.worksheet };
                if (startDate) params.startDate = startDate;
                if (endDate) params.endDate = endDate;

                var result = await apiGet('getCases', params);

                if (result.success) {
                    // Track actual date range from API response
                    if (result.actualStartDate && (!actualStartDate || result.actualStartDate < actualStartDate)) {
                        actualStartDate = result.actualStartDate;
                    }
                    if (result.actualEndDate && (!actualEndDate || result.actualEndDate > actualEndDate)) {
                        actualEndDate = result.actualEndDate;
                    }

                    // Add worksheet and userName metadata to each case
                    // Normalize actionResult for display (single source of truth)
                    if (result.cases && result.cases.length > 0) {
                        result.cases.forEach(function(c) {
                            c.worksheet = ws.worksheet;
                            c.userName = ws.userName;
                            c.actionResult = normalizeActionResultForDisplay(c.actionResult);
                        });
                        allCases = allCases.concat(result.cases);
                    }

                }
            } catch (err) {
                console.error('Error loading cases for ' + ws.userName + ':', err);
            }
        }

        if (showProgress) {
            hideLoadingOverlay();
        }

        return { cases: allCases, actualStartDate: actualStartDate, actualEndDate: actualEndDate };
    } catch (error) {
        hideLoadingOverlay();
        console.error('API error loading cases:', error);
        showToast('Failed to connect to server', 'error');
        return { cases: [], actualStartDate: null, actualEndDate: null };
    }
}

/**
 * Show toast notification for missing spreadsheet months
 * Different message for admin vs regular users
 * @param {Array} missingMonths - Array of { month, year } objects
 */
function showMissingMonthsToast(missingMonths) {
    if (!missingMonths || missingMonths.length === 0) return;

    // Format month names
    var monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    var formattedMonths = missingMonths.map(function(m) {
        return monthNames[m.month - 1] + ' ' + m.year;
    }).join(', ');

    // Different messages for admin vs regular users
    var message;
    if (isAdmin) {
        message = 'No spreadsheet configured for: ' + formattedMonths + '. Please add to Master Spreadsheet.';
    } else {
        message = 'Data for ' + formattedMonths + ' is not available. Please contact your administrator.';
    }

    // Use warning type with longer duration (6 seconds) for better visibility
    showToast(message, 'warning', 6000);
}

/**
 * Check for missing spreadsheets for the currently selected period
 * Calls the API to verify spreadsheet configuration and updates the warning indicator
 */
async function checkMissingMonthsForCurrentPeriod() {
    // Hide warning immediately at start (will show again if needed after API response)
    hidePeriodWarning();

    try {
        var dateRange = getDateRange();
        if (!dateRange || !dateRange.start || !dateRange.end) {
            return;
        }

        var startDate = formatLocalDate(dateRange.start);
        var endDate = formatLocalDate(dateRange.end);

        var result = await apiGet('checkMissingMonths', {
            startDate: startDate,
            endDate: endDate
        });

        if (result.success && result.missingMonths && result.missingMonths.length > 0) {
            showPeriodWarning(result.missingMonths);
        }
    } catch (err) {
        console.error('Error checking missing months:', err);
        // Silently fail - warning already hidden at start
    }
}

/**
 * Show the period warning indicator with missing months info
 * @param {Array} missingMonths - Array of { month, year } objects
 */
function showPeriodWarning(missingMonths) {
    var button = document.getElementById('periodButton');
    var warningIcon = document.getElementById('periodWarningIcon');

    if (!button || !warningIcon) return;

    // Format month names
    var monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    var formattedMonths = missingMonths.map(function(m) {
        return monthNames[m.month - 1] + ' ' + m.year;
    }).join(', ');

    // Set tooltip text based on user role
    var tooltipText;
    if (isAdmin) {
        tooltipText = 'Spreadsheet not configured for: ' + formattedMonths + '. Please add to Master Spreadsheet.';
    } else {
        tooltipText = 'Data not available for: ' + formattedMonths + '. Please contact your administrator.';
    }

    warningIcon.title = tooltipText;
    button.classList.add('has-warning');
    warningIcon.style.display = 'inline';
}

/**
 * Hide the period warning indicator
 */
function hidePeriodWarning() {
    var button = document.getElementById('periodButton');
    var warningIcon = document.getElementById('periodWarningIcon');

    if (button) button.classList.remove('has-warning');
    if (warningIcon) warningIcon.style.display = 'none';
}

/**
 * Update the data loaded range display
 * Shows the CACHED date range (data loaded into memory)
 * This range expands as delta loads occur but never shrinks during the session
 * Format: "3 Jan - 2 Feb 2026" (same year) or "1 Nov 2025 - 2 Feb 2026" (different years)
 */
function updateDataLoadedRange() {
    var rangeEl = document.getElementById('dataLoadedRange');
    if (!rangeEl) return;

    // Use the cached date range (data that has been loaded into memory)
    if (!adminCachedStartDate || !adminCachedEndDate) {
        rangeEl.innerHTML = '';
        return;
    }

    // Parse the cached dates (they are in YYYY-MM-DD format)
    var startDate = new Date(adminCachedStartDate + 'T00:00:00');
    var endDate = new Date(adminCachedEndDate + 'T00:00:00');

    var monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    var startDay = startDate.getDate();
    var startMonth = monthNames[startDate.getMonth()];
    var startYear = startDate.getFullYear();

    var endDay = endDate.getDate();
    var endMonth = monthNames[endDate.getMonth()];
    var endYear = endDate.getFullYear();

    var rangeText;
    if (startYear === endYear) {
        // Same year: "3 Jan - 2 Feb 2026"
        if (startMonth === endMonth && startDay === endDay) {
            // Same exact date
            rangeText = startDay + ' ' + startMonth + ' ' + startYear;
        } else {
            rangeText = startDay + ' ' + startMonth + ' - ' + endDay + ' ' + endMonth + ' ' + endYear;
        }
    } else {
        // Different years: "1 Nov 2025 - 2 Feb 2026"
        rangeText = startDay + ' ' + startMonth + ' ' + startYear + ' - ' + endDay + ' ' + endMonth + ' ' + endYear;
    }

    rangeEl.innerHTML = '<i class="fas fa-database" title="Data loaded in memory"><\/i> ' + rangeText;
}

// Update just the message text in loading overlay (minimal DOM update)
function updateLoadingMessage(message) {
    var overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        var spanEl = overlay.querySelector('span');
        if (spanEl) {
            spanEl.textContent = message;
        }
    }
}

/**
 * Helper function to get worksheets to load based on user role
 * @returns {Array} Array of {worksheet, userName} objects
 */
function getWorksheetsToLoad() {
    if (isAdmin) {
        // Admin: load ALL helpdesk users' worksheets (including inactive)
        // This allows viewing historical data for users who have left
        // IsActive only controls login access, not historical data visibility
        var allHelpdeskUsers = USERS.filter(function(u) { return u.isHelpdesk; });
        return allHelpdeskUsers.map(function(u) {
            return { worksheet: u.worksheet, userName: u.name, initials: u.initials, isActive: u.isActive };
        });
    } else {
        // Regular user: load only their worksheet
        return [{ worksheet: currentUser.worksheet, userName: currentUser.name, initials: currentUser.initials }];
    }
}

/**
 * Calculate initial date range (Last 30 days)
 * @returns {Object} { startDate, endDate } in YYYY-MM-DD format
 */
function getInitialDateRange() {
    var now = new Date();
    var thirtyDaysAgo = new Date(now);
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

    // Use shared formatLocalDate helper (single source of truth for date formatting)
    return {
        startDate: formatLocalDate(thirtyDaysAgo),
        endDate: formatLocalDate(now)
    };
}

// Legacy wrapper for backward compatibility
// Returns just the cases array for backward compatibility
async function loadCasesFromAPI(worksheet, startDate, endDate) {
    if (startDate === undefined) startDate = null;
    if (endDate === undefined) endDate = null;
    var result = await loadCases({
        worksheets: worksheet,
        startDate: startDate,
        endDate: endDate,
        showProgress: true,
        progressPrefix: 'Loading cases...'
    });
    return result.cases;
}

function renderUserList() {
    // Kept for admin user management - no longer used for login
}

async function loginAs(email) {
    const user = USERS.find(u => u.email === email);

    // Check if user exists and is active
    if (!user) {
        showToast('User not found. Please contact administrator.', 'error');
        return;
    }

    if (!user.isActive) {
        showToast('Your account is inactive. Please contact administrator.', 'error');
        return;
    }

    // Check worksheet mapping
    if (!user.worksheet) {
        showToast('No worksheet assigned. Please contact administrator.', 'error');
        return;
    }

    // Check if worksheet exists
    if (!WORKSHEETS.includes(user.worksheet)) {
        showToast(`Worksheet "${user.worksheet}" not found. Please contact administrator.`, 'error');
        return;
    }

    currentUser = { name: user.name, initials: user.initials, email: user.email, role: user.role, worksheet: user.worksheet };
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('appContainer').classList.add('show');
    document.getElementById('userAvatar').textContent = user.initials;
    document.getElementById('userName').textContent = user.name;

    // Initialize all custom dropdowns
    initAllDropdowns();

    // Set admin state and get helpdesk users
    isAdmin = user.role === 'admin';
    const currentUserIsHelpdesk = user.isHelpdesk === true || user.isHelpdesk === 'TRUE';
    currentUser.isHelpdesk = currentUserIsHelpdesk;

    // Get helpdesk users list (used for dropdown and loading)
    // Include ALL helpdesk users (active and inactive) for historical data
    // IsActive only controls login access, not data visibility for admin
    helpdeskUsers = USERS.filter(u => u.isHelpdesk).map(u => ({
        name: u.name,
        initials: u.initials,
        worksheet: u.worksheet,
        isActive: u.isActive
    }));

    // Show admin tab if user is admin
    updateAdminAccess();

    // Update UI based on admin permissions
    updateAdminUIRestrictions();

    // Populate colleague filter for admin
    if (isAdmin) {
        populateDashboardColleagueFilter();
    }

    // Load cases using unified function - same logic for both admin and non-admin
    // Initial load: Last 30 days for all users using QUERY method
    const dateRange = getInitialDateRange();
    const worksheetsToLoad = getWorksheetsToLoad();

    var loadResult = await loadCases({
        startDate: dateRange.startDate,
        endDate: dateRange.endDate,
        worksheets: worksheetsToLoad,
        showProgress: true,
        progressPrefix: 'Loading cases...'
    });
    cases = loadResult.cases;

    // Store cache metadata using ACTUAL dates from existing spreadsheets (not requested dates)
    // This ensures the data loaded message shows the true range of available data
    adminCachedStartDate = loadResult.actualStartDate || dateRange.startDate;
    adminCachedEndDate = loadResult.actualEndDate || dateRange.endDate;
    adminCacheTimestamp = Date.now();
    adminCachePeriod = '30days';

    // Keep adminCases in sync for admin users
    if (isAdmin) {
        adminCases = cases;
    }

    // Update the data loaded range display
    updateDataLoadedRange();

    setCurrentDateTime(); applyFilters(); updateStats();
    document.getElementById('userSelectModal').classList.remove('show');
}

function updateAdminAccess() {
    const adminTab = document.getElementById('adminTab');
    if (adminTab) {
        adminTab.style.display = currentUser && currentUser.role === 'admin' ? 'flex' : 'none';
    }
}

function updateAdminUIRestrictions() {
    const dashboardView = document.getElementById('dashboardView');
    const casesTable = document.getElementById('casesTable');

    if (!isAdmin) {
        // Not admin - show normal UI
        document.getElementById('colleagueFilterContainer').style.display = 'none';
        document.getElementById('createdByHeader').style.display = 'none';
        if (dashboardView) dashboardView.classList.remove('admin-mode');
        if (casesTable) casesTable.classList.remove('admin-mode');
        return;
    }

    // Admin - add admin-mode class for CSS styling
    if (dashboardView) dashboardView.classList.add('admin-mode');
    if (casesTable) casesTable.classList.add('admin-mode');

    // Admin - show colleague filter
    document.getElementById('colleagueFilterContainer').style.display = 'flex';
    document.getElementById('createdByHeader').style.display = 'block';
    populateDashboardColleagueFilter();

    // Handle New Case tab visibility based on isHelpdesk
    const newCaseTab = document.querySelectorAll('.header-tab')[1];
    if (newCaseTab) {
        if (currentUser.isHelpdesk) {
            newCaseTab.style.display = 'flex';
        } else {
            newCaseTab.style.display = 'none';
        }
    }
}

function populateDashboardColleagueFilter() {
    const select = document.getElementById('dashboardColleagueFilter');
    if (!select) return;

    select.innerHTML = '<option value="all">All Helpdesk<\/option>';

    // Add helpdesk users to dropdown sorted by name
    // Include inactive users with visual indicator for historical data access
    const sortedUsers = helpdeskUsers.slice().sort((a, b) => a.name.localeCompare(b.name));
    sortedUsers.forEach(u => {
        const option = document.createElement('option');
        option.value = u.worksheet;
        // Show "(inactive)" suffix for users who are no longer active
        option.textContent = u.isActive ? u.name : u.name + ' (inactive)';
        select.appendChild(option);
    });

    select.value = selectedColleague;
}

function handleDashboardColleagueChange() {
    selectedColleague = document.getElementById('dashboardColleagueFilter').value;
    applyFilters();
}

// Helper functions to update cases in memory (no API reload needed)
// This is faster and more reliable than reloading from API
// Note: For admin users, adminCases === cases (same reference), so we only need to update once

function addCaseToMemory(newCase) {
    // Add metadata for the new case (same as loadCases adds)
    newCase.createdByName = currentUser.name;
    newCase.createdByInitials = currentUser.initials;
    newCase._worksheetSource = currentUser.worksheet;
    newCase.worksheet = currentUser.worksheet;  // Required for admin colleague filter
    newCase.userName = currentUser.name;  // Required for Team Breakdown grouping
    // Normalize actionResult for display (single source of truth)
    newCase.actionResult = normalizeActionResultForDisplay(newCase.actionResult);

    // Add to cases array (adminCases points to same array for admin, so no need to add twice)
    cases.push(newCase);

    // Rebuild Team Breakdown if admin
    if (isAdmin) {
        buildAdminSummaryFromCases();
    }
}

function updateCaseInMemory(jobId, updates, skipRebuild) {
    // Normalize actionResult if being updated (single source of truth)
    if (updates.actionResult !== undefined) {
        updates.actionResult = normalizeActionResultForDisplay(updates.actionResult);
    }

    // Find and update in cases array (adminCases points to same array for admin)
    const index = cases.findIndex(c => c.jobId === jobId);
    if (index !== -1) {
        cases[index] = Object.assign({}, cases[index], updates);
    }

    // Rebuild Team Breakdown if admin (unless skipped for batch updates)
    if (isAdmin && !skipRebuild) {
        buildAdminSummaryFromCases();
    }
}

function updateMultipleCasesInMemory(jobIds, updates) {
    // Update all cases without rebuilding each time
    jobIds.forEach(jobId => updateCaseInMemory(jobId, updates, true));
    // Rebuild once at the end
    if (isAdmin) {
        buildAdminSummaryFromCases();
    }
}

function deleteCaseFromMemory(jobId, deleteAll) {
    if (deleteAll) {
        // Delete entire case group (main + all follow-ups)
        const caseToDelete = cases.find(c => c.jobId === jobId);
        if (caseToDelete) {
            const rootJobId = caseToDelete.followUpJobId || caseToDelete.jobId;
            // Create new filtered array and reassign both
            const filtered = cases.filter(c => c.jobId !== rootJobId && c.followUpJobId !== rootJobId);
            cases = filtered;
            if (isAdmin) {
                adminCases = filtered;
            }
        }
    } else {
        // Delete single case only - reassign both to same filtered array
        const filtered = cases.filter(c => c.jobId !== jobId);
        cases = filtered;
        if (isAdmin) {
            adminCases = filtered;
        }
    }

    // Rebuild Team Breakdown if admin
    if (isAdmin) {
        buildAdminSummaryFromCases();
    }
}
function logout() {
    showConfirm('Logout', 'Are you sure you want to logout?', function() {
        // Reset all state variables
        currentUser = null;
        currentCaseId = null;
        isAdmin = false;

        // Reset cases data
        cases = [];
        adminCases = [];
        filteredCases = [];
        adminFilteredCases = [];
        helpdeskUsers = [];

        // Reset cache metadata
        adminCachedStartDate = null;
        adminCachedEndDate = null;
        adminCacheTimestamp = null;
        adminCachePeriod = null;
        updateDataLoadedRange();

        // Reset custom date ranges
        customDateRange = null;
        adminCustomDateRange = null;

        // Reset filters
        selectedColleague = 'all';
        selectedChannels = ['Agency', 'Broker', 'Banca'];
        activeFilters = { stat: null };

        // Reset sorting
        sortColumn = 'date';
        sortDirection = 'desc';

        // Reset pagination
        currentPage = 1;
        adminCurrentPage = 1;
        pageSize = 10;
        adminPageSize = 20;

        // Reset other state
        dataChanged = true;
        dashboardInitialized = false;
        isEditMode = false;
        editingJobId = null;
        originalFormData = null;
        adminSummary = {};

        // Reset stat boxes to 0
        var statTotal = document.getElementById('statTotal');
        var statPending = document.getElementById('statPending');
        var statEscalated = document.getElementById('statEscalated');
        var statResolved = document.getElementById('statResolved');
        if (statTotal) statTotal.textContent = '0';
        if (statPending) statPending.textContent = '0';
        if (statEscalated) statEscalated.textContent = '0';
        if (statResolved) statResolved.textContent = '0';

        // Reset Period filter values
        var dateFilter = document.getElementById('dateFilter');
        if (dateFilter) dateFilter.value = '30days';
        var adminPeriodFilter = document.getElementById('adminPeriodFilter');
        if (adminPeriodFilter) adminPeriodFilter.value = '30days';

        // Reset search inputs
        var searchInput = document.getElementById('searchInput');
        if (searchInput) searchInput.value = '';
        var adminSearchInput = document.getElementById('adminSearchInput');
        if (adminSearchInput) adminSearchInput.value = '';

        // Reset period buttons text
        var periodButtonText = document.getElementById('periodButtonText');
        if (periodButtonText) periodButtonText.textContent = 'Last 30 Days';
        var adminPeriodButtonText = document.getElementById('adminPeriodButtonText');
        if (adminPeriodButtonText) adminPeriodButtonText.textContent = 'Last 30 Days';

        // Reset colleague filter dropdown
        var dashboardColleagueFilter = document.getElementById('dashboardColleagueFilter');
        if (dashboardColleagueFilter) {
            dashboardColleagueFilter.innerHTML = '<option value="all">All Helpdesk<\/option>';
            dashboardColleagueFilter.value = 'all';
        }
        var colleagueFilter = document.getElementById('colleagueFilter');
        if (colleagueFilter) {
            colleagueFilter.innerHTML = '<option value="all">All Helpdesk<\/option>';
            colleagueFilter.value = 'all';
        }

        // Hide colleague filter container
        var colleagueFilterContainer = document.getElementById('colleagueFilterContainer');
        if (colleagueFilterContainer) colleagueFilterContainer.style.display = 'none';

        // Clear case list display
        var casesList = document.getElementById('casesList');
        if (casesList) casesList.innerHTML = '';
        var adminCasesList = document.getElementById('adminCasesList');
        if (adminCasesList) adminCasesList.innerHTML = '';

        // Reset pagination display
        var paginationContainer = document.getElementById('paginationContainer');
        if (paginationContainer) {
            var pageInfo = paginationContainer.querySelector('.page-info');
            if (pageInfo) pageInfo.textContent = 'Showing 0-0 of 0';
        }

        // Reset page size dropdown
        var pageSizeSelect = document.getElementById('pageSizeSelect');
        if (pageSizeSelect) pageSizeSelect.value = '10';

        // Reset channel toggles to all active
        document.querySelectorAll('.channel-toggle').forEach(function(btn) {
            btn.classList.add('active');
        });

        // Reset stat cards (remove active selection)
        document.querySelectorAll('.stat-card').forEach(function(c) {
            c.classList.remove('active');
        });

        // Reset Team Breakdown table
        var userSummaryBody = document.getElementById('userSummaryBody');
        if (userSummaryBody) userSummaryBody.innerHTML = '';

        // Reset admin cache status
        var adminCacheStatus = document.getElementById('adminCacheStatus');
        if (adminCacheStatus) adminCacheStatus.style.display = 'none';

        // Hide any open modals/drawers
        var timelineDrawer = document.getElementById('timelineDrawer');
        if (timelineDrawer) timelineDrawer.classList.remove('open');
        var caseDetailModal = document.getElementById('caseDetailModal');
        if (caseDetailModal) caseDetailModal.classList.remove('show');

        // Revoke Google sign-in session
        if (typeof google !== 'undefined' && google.accounts && google.accounts.id) {
            google.accounts.id.disableAutoSelect();
        }
        googleCredential = null;
        gisRetryCount = 0;

        // Reset login screen UI
        var signInBtn = document.getElementById('googleSignInButton');
        var spinner = document.getElementById('loginSpinner');
        var statusEl = document.getElementById('loginStatus');
        if (signInBtn) signInBtn.style.display = 'flex';
        if (spinner) spinner.style.display = 'none';
        if (statusEl) statusEl.style.display = 'none';

        // Show login screen
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('appContainer').classList.remove('show');

        // Switch to dashboard view
        showView('dashboard');
    });
}

function toggleTheme() {
    isDarkMode = !isDarkMode;
    document.documentElement.classList.toggle('dark', isDarkMode);
    document.getElementById('themeIcon').className = isDarkMode ? 'fas fa-sun' : 'fas fa-moon';
}

// Mobile Timeline Drawer
let timelineDrawerTimeout = null;

function initMobileTimelineDrawer() {
    // Only initialize on mobile screens
    if (window.innerWidth > 1024) return;

    const drawer = document.getElementById('timelineDrawer');
    const tab = document.getElementById('timelineDrawerTab');
    const overlay = document.getElementById('timelineDrawerOverlay');

    if (!drawer || !tab) return;

    // Reset drawer state - show it initially
    drawer.classList.remove('collapsed');
    tab.classList.remove('visible');
    overlay.classList.remove('visible');

    // Clear any existing timeout
    if (timelineDrawerTimeout) clearTimeout(timelineDrawerTimeout);

    // Auto-collapse after 2.5 seconds
    timelineDrawerTimeout = setTimeout(() => {
        drawer.classList.add('collapsed');
        tab.classList.add('visible');
    }, 2500);
}

function toggleTimelineDrawer() {
    const drawer = document.getElementById('timelineDrawer');
    const tab = document.getElementById('timelineDrawerTab');
    const overlay = document.getElementById('timelineDrawerOverlay');

    if (!drawer || !tab) return;

    // Clear auto-collapse timeout if user interacts
    if (timelineDrawerTimeout) {
        clearTimeout(timelineDrawerTimeout);
        timelineDrawerTimeout = null;
    }

    const isCollapsed = drawer.classList.contains('collapsed');

    if (isCollapsed) {
        // Expand drawer
        drawer.classList.remove('collapsed');
        tab.classList.remove('visible');
        overlay.classList.add('visible');
    } else {
        // Collapse drawer
        drawer.classList.add('collapsed');
        tab.classList.add('visible');
        overlay.classList.remove('visible');
    }
}

function navigateTo(viewName) {
    // Check if we're leaving the new case form with unsaved changes
    const isOnNewCaseForm = document.getElementById('newCaseView').classList.contains('active');
    const isNavigatingAway = viewName !== 'newCase' || (viewName === 'newCase' && isEditMode);

    if (isOnNewCaseForm && isNavigatingAway && hasFormChanged()) {
        const targetView = viewName;
        showThreeOptionConfirm(
            'Unsaved Changes',
            'You have unsaved changes. What would you like to do?',
            () => { document.getElementById('caseForm').dispatchEvent(new Event('submit', { cancelable: true })); },
            () => { exitEditMode(); showView(targetView); }
        );
    } else {
        showView(viewName);
    }
}

function showView(viewName, skipReset = false) {
    document.getElementById('dashboardView').style.display = 'none';
    document.getElementById('newCaseView').classList.remove('active');
    document.getElementById('caseDetailView').classList.remove('active');
    document.getElementById('adminView').classList.remove('active');
    document.getElementById('formButtonGroup').classList.remove('show');
    document.querySelectorAll('.header-tab').forEach(t => t.classList.remove('active'));
    switch(viewName) {
        case 'dashboard':
            document.getElementById('dashboardView').style.display = 'block';
            document.querySelectorAll('.header-tab')[0].classList.add('active');
            // Only refresh if data changed or first time
            if (dataChanged || !dashboardInitialized) {
                applyFilters();
                dashboardInitialized = true;
                dataChanged = false;
            }
            break;
        case 'newCase': document.getElementById('newCaseView').classList.add('active'); document.getElementById('formButtonGroup').classList.add('show'); if (!skipReset) { document.querySelectorAll('.header-tab')[1].classList.add('active'); resetNewCaseForm(); } break;
        case 'caseDetail': document.getElementById('caseDetailView').classList.add('active'); break;
        case 'admin':
            document.getElementById('adminView').classList.add('active');
            document.getElementById('adminTab').classList.add('active');
            // Sync adminCases with cases for shared data
            adminCases = cases;
            renderAdminUserList();
            break;
    }
}

let customDateRange = null;

/**
 * Current period modal mode: 'dashboard' or 'admin'
 */
var periodModalMode = 'dashboard';
var selectedPeriodPreset = '30days';
var periodCustomTab = 'month';

// Track last selected values for restoring when modal opens
// Separate tracking for Dashboard and Admin
var lastDashboardSelection = { type: 'preset', preset: '30days', customTab: null, customValue: null };
var lastAdminSelection = { type: 'preset', preset: '30days', customTab: null, customValue: null };

/**
 * Show the Period modal
 * @param {string} mode - 'admin' for admin view, otherwise dashboard
 */
function showPeriodModal(mode) {
    periodModalMode = mode === 'admin' ? 'admin' : 'dashboard';
    var modal = document.getElementById('periodModal');
    var now = new Date();

    // Get the last selection for this mode
    var lastSelection = periodModalMode === 'admin' ? lastAdminSelection : lastDashboardSelection;

    // Populate year picker (current year + last 4 years)
    var yearPicker = document.getElementById('periodYearPicker');
    var currentYear = now.getFullYear();
    yearPicker.innerHTML = '';
    for (var y = currentYear; y >= currentYear - 4; y--) {
        yearPicker.innerHTML += '<option value="' + y + '">' + y + '<\/option>';
    }

    // Set default values for custom inputs
    document.getElementById('periodMonthPicker').value = now.toISOString().slice(0, 7);
    document.getElementById('periodDatePicker').value = now.toISOString().slice(0, 10);

    // Default range: last 30 days
    var thirtyDaysAgo = new Date(now);
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    document.getElementById('periodRangeStart').value = thirtyDaysAgo.toISOString().slice(0, 10);
    document.getElementById('periodRangeEnd').value = now.toISOString().slice(0, 10);

    // Clear all custom input highlights first
    clearCustomInputHighlights();

    // Restore previous selection
    if (lastSelection.type === 'preset' && lastSelection.preset) {
        // Preset was selected - highlight it
        updatePresetButtonsHighlight(lastSelection.preset);
        selectedPeriodPreset = lastSelection.preset;
        periodCustomTab = null;
        // Show month panel but DON'T clear preset highlight - just show the panel
        showCustomPanelOnly('month');
    } else if (lastSelection.type === 'custom' && lastSelection.customTab) {
        // Custom selection - switch to the correct tab and restore value
        updatePresetButtonsHighlight(null); // Clear preset highlight
        selectedPeriodPreset = null;
        periodCustomTab = lastSelection.customTab;
        switchPeriodCustomTab(lastSelection.customTab);

        // Restore the custom value and highlight the input
        if (lastSelection.customValue) {
            switch (lastSelection.customTab) {
                case 'month':
                    document.getElementById('periodMonthPicker').value = lastSelection.customValue;
                    document.getElementById('periodMonthPicker').classList.add('highlighted');
                    break;
                case 'year':
                    document.getElementById('periodYearPicker').value = lastSelection.customValue;
                    document.getElementById('periodYearPicker').classList.add('highlighted');
                    break;
                case 'date':
                    document.getElementById('periodDatePicker').value = lastSelection.customValue;
                    document.getElementById('periodDatePicker').classList.add('highlighted');
                    break;
                case 'range':
                    if (lastSelection.customValue.start && lastSelection.customValue.end) {
                        document.getElementById('periodRangeStart').value = lastSelection.customValue.start;
                        document.getElementById('periodRangeEnd').value = lastSelection.customValue.end;
                        document.getElementById('periodRangeStart').classList.add('highlighted');
                        document.getElementById('periodRangeEnd').classList.add('highlighted');
                    }
                    break;
            }
        }
    } else {
        // Default: highlight current filter value or 30days
        var filterInput = document.getElementById(periodModalMode === 'admin' ? 'adminPeriodFilter' : 'dateFilter');
        var currentValue = filterInput ? filterInput.value : '30days';
        updatePresetButtonsHighlight(currentValue);
        showCustomPanelOnly('month');
    }

    modal.classList.add('show');
}

/**
 * Hide the Period modal
 */
function hidePeriodModal() {
    var modal = document.getElementById('periodModal');
    modal.classList.remove('show');
}

/* =============================================
   Classification Wizard Functions
   ============================================= */

// Wizard state
var wizardState = {
    currentStep: 1,
    area: null,           // Step 1 selection
    subcategory: null,    // Step 2 selection (system or specific GIT item)
    nature: null,         // Step 3 selection (problem/training/service)
    subject: null,        // Step 4 selection (specific problem/service)
    isInternalStaff: false, // Toggle in summary
    // Derived values
    caseType: null,
    category: null
};

// Wizard configuration data
const WIZARD_CONFIG = {
    // Step 1: Area options
    areas: [
        { id: 'digital', icon: '', title: 'Digital System', desc: 'SunSmart, AWB, SunOffice, or other apps' },
        { id: 'hardware', icon: '', title: 'Hardware', desc: 'PC, phone, printer device issues', subcategory: 'GIT - Hardware' },
        { id: 'printing', icon: '', title: 'Printing', desc: 'Printer driver, queue, or print services', subcategory: 'GIT - Printing' },
        { id: 'network', icon: '', title: 'Network', desc: 'WiFi, connectivity problems', subcategory: 'GIT - Network' },
        { id: 'google', icon: '', title: 'Google Services', desc: 'Gmail, Google apps issues', subcategory: 'GIT - Google Services' },
        { id: 'notHelpdesk', icon: '', title: 'Not Helpdesk Scope', desc: 'Product features, underwriting rules, etc.' }
    ],

    // Step 2: Digital systems
    digitalSystems: [
        { id: 'awb', title: 'AWB', subcategory: 'Digital - AWB' },
        { id: 'sunsmart-v8', title: 'SunSmart V8', subcategory: 'Digital - SunSmart V8' },
        { id: 'sunsmart-ipad', title: 'SunSmart (iPad)', subcategory: 'Digital - SunSmart (iPad)' },
        { id: 'sunsmart-websi', title: 'SunSmart (Web SI)', subcategory: 'Digital - SunSmart (Web SI)' },
        { id: 'sunsmart-mpf', title: 'SunSmart MPF', subcategory: 'Digital - SunSmart MPF' },
        { id: 'sunoffice', title: 'SunOffice', subcategory: 'Digital - SunOffice' },
        { id: 'sunsurf', title: 'SunSurf', subcategory: 'Digital - SunSurf' },
        { id: 'erecruitment', title: 'eRecruitment', subcategory: 'Digital - eRecruitment' },
        { id: 'elearning', title: 'eLearning', subcategory: 'Digital - eLearning' },
        { id: 'sunvisual', title: 'SunVisual', subcategory: 'Digital - SunVisual' },
        { id: 'clientapp', title: 'Client App', subcategory: 'Digital - Client App' },
        { id: 'others', title: 'Others', subcategory: 'Others' }
    ],

    // Step 2: GIT-specific items (sets Subject directly)
    gitHardware: [
        { id: 'hw-personal', title: "Advisor's personal device", desc: 'Laptop/phone', subject: 'Hardware - Advisor Personal Device' },
        { id: 'hw-proposal', title: 'Proposal PC', subject: 'Hardware - Proposal PC' },
        { id: 'hw-mfp', title: 'MFP Printer', desc: 'The device itself', subject: 'Hardware - MFP Printer' },
        { id: 'hw-phone', title: 'Desk Phone', subject: 'Hardware - Desk Phone' },
        { id: 'hw-other', title: 'Other', subject: 'Others' }
    ],
    gitPrinting: [
        { id: 'pr-driver', title: 'Printer driver problem', subject: 'Printing - Printer Driver' },
        { id: 'pr-queue', title: 'Print job stuck in queue', subject: 'Printing - Print Queue' },
        { id: 'pr-auth', title: 'Card/ID authentication', subject: 'Printing - Print Authentication' },
        { id: 'pr-services', title: 'Copy/Print/Fax/Scan services', subject: 'Printing - Printing Services' },
        { id: 'pr-other', title: 'Other', subject: 'Others' }
    ],
    gitNetwork: [
        { id: 'nw-office', title: 'Office WiFi connection', subject: 'Network - Office Wi-Fi' },
        { id: 'nw-personal', title: 'Personal device network/WiFi', subject: 'Network - Personal Device' },
        { id: 'nw-auth', title: 'Network authentication', subject: 'Network - Authentication' },
        { id: 'nw-other', title: 'Other', subject: 'Others' }
    ],
    gitGoogle: [
        { id: 'gg-send', title: "Can't send or receive Gmail", subject: 'Google - Gmail Send / Receive Issue' },
        { id: 'gg-capacity', title: 'Gmail storage full', subject: 'Google - Gmail Capacity Issue' },
        { id: 'gg-auth', title: 'Google account login (ID/password/2FA)', subject: 'Google Authentication (ID & PW / 2FA)' },
        { id: 'gg-apps', title: 'Other Google apps', desc: 'Drive, Calendar, etc.', subject: 'Google - Other Application Services' },
        { id: 'gg-other', title: 'Other', subject: 'Others' }
    ],

    // Step 3: Nature of request (Digital)
    digitalNature: [
        { id: 'problem', icon: '', title: 'Report a problem', desc: 'System error, can\'t login, data issue', caseType: 'Incident' },
        { id: 'training', icon: '', title: 'Training / How-to', desc: 'Learn how to use the system', caseType: 'Enquiry', subject: 'Training / How-To Inquiry', category: 'Business Usage / Training' },
        { id: 'service', icon: '', title: 'Request a service', desc: 'Setup, grant access, install', caseType: 'Service' }
    ],

    // Step 3: Nature of request (GIT)
    gitNature: [
        { id: 'broken', icon: '', title: 'Something is broken', desc: 'Not working, error, can\'t connect', caseType: 'Incident', category: 'Infra / Device' },
        { id: 'guidance', icon: '', title: 'Need guidance', desc: 'How to use or configure', caseType: 'Enquiry', category: 'Business Usage / Training' },
        { id: 'gitservice', icon: '', title: 'Setup / Service request', desc: 'Install, configure, do something for them', caseType: 'Service', category: 'Infra / Device' }
    ],

    // Step 4: Digital Incident problems
    digitalProblems: [
        { id: 'access', title: 'Function / Product access issue', subject: 'User Access Issue', category: 'Application Functionality / Data Issue' },
        { id: 'login', title: "Can't login / authentication error", subject: 'Login / Authentication Issue', category: 'User Login / Authentication' },
        { id: 'performance', title: 'System slow or unresponsive', subject: 'System Performance Issue', category: 'Application Functionality / Data Issue' },
        { id: 'functionality', title: 'Feature not working correctly', subject: 'Application Functionality / Data Issue', category: 'Application Functionality / Data Issue' },
        { id: 'sync', title: 'Data not syncing or missing', subject: 'Data Sync / Update Issue', category: 'Application Functionality / Data Issue' },
        { id: 'crash', title: 'App crashes or shows error', subject: 'Application Error / Crash', category: 'Application Functionality / Data Issue' },
        { id: 'payment', title: 'Payment processing issue', subject: 'Payment Issue', category: 'Application Functionality / Data Issue' },
        { id: 'other', title: 'Other', subject: 'Others', category: 'Application Functionality / Data Issue' }
    ],

    // Step 4: Digital Service requests
    digitalServices: [
        { id: 'install', title: 'Install or update application', subject: 'Installation / Update' },
        { id: 'setup', title: 'Setup or configure device/app', subject: 'Device Setup / Configuration' },
        { id: 'grantaccess', title: 'Grant function / product access', subject: 'User Access Issue' },
        { id: 'other', title: 'Other', subject: 'Others' }
    ]
};

/**
 * Show the Classification Wizard modal
 * Restores previous wizard selections or syncs with form field values
 */
function showClassificationWizard() {
    // Check if form already has values (user selected manually or from previous wizard)
    var formCaseType = document.getElementById('caseType').value;
    var formCategory = document.getElementById('category').value;
    var formSubcategory = document.getElementById('subcategory').value;
    var formSubject = document.getElementById('subject').value;

    // If wizard was used before and form values match, keep wizard state
    var formValuesMatch = wizardState.caseType === formCaseType &&
                          wizardState.category === formCategory &&
                          wizardState.subcategory === formSubcategory &&
                          wizardState.subject === formSubject;

    if (formValuesMatch && wizardState.area) {
        // Previous wizard selections match form - restore wizard to summary
        wizardState.currentStep = needsStep4() ? 5 : 4;
    } else if (formCaseType || formCategory || formSubcategory || formSubject) {
        // Form has values but they don't match wizard - check if combination can be displayed in wizard
        if (checkWizardMatch(formCaseType, formCategory, formSubcategory, formSubject)) {
            // Combination can be represented in wizard - sync from form
            syncWizardFromForm(formCaseType, formCategory, formSubcategory, formSubject);
        } else {
            // Combination cannot be represented in wizard - start fresh from step 1
            wizardState = {
                currentStep: 1,
                area: null,
                subcategory: null,
                nature: null,
                subject: null,
                gitItem: null,
                isInternalStaff: false,
                caseType: null,
                category: null
            };
        }
    } else {
        // No previous selections - start fresh
        wizardState = {
            currentStep: 1,
            area: null,
            subcategory: null,
            nature: null,
            subject: null,
            gitItem: null,
            isInternalStaff: false,
            caseType: null,
            category: null
        };
    }

    // Show modal
    var modal = document.getElementById('classificationWizardModal');
    modal.classList.add('show');

    // Render current step
    renderWizardStep();
}

/**
 * Sync wizard state from form field values
 * Only pre-fills if ALL form values can be fully matched to wizard options
 * Otherwise starts fresh from Step 1
 */
function syncWizardFromForm(caseType, category, subcategory, subject) {
    // First, check if form values can be fully matched to wizard options
    var canFullyMatch = checkWizardMatch(caseType, category, subcategory, subject);

    if (!canFullyMatch) {
        // Cannot fully match - start fresh from Step 1
        wizardState = {
            currentStep: 1,
            area: null,
            subcategory: null,
            nature: null,
            subject: null,
            gitItem: null,
            isInternalStaff: false,
            caseType: null,
            category: null
        };
        return;
    }

    // Can fully match - proceed with syncing
    wizardState.caseType = caseType || null;
    wizardState.category = category || null;
    wizardState.subcategory = subcategory || null;
    wizardState.subject = subject || null;
    wizardState.gitItem = null;
    wizardState.isInternalStaff = category === 'Staff Service Requests';

    // Determine area from subcategory
    if (subcategory) {
        if (subcategory.startsWith('Digital -')) {
            wizardState.area = 'digital';
        } else if (subcategory === 'GIT - Hardware') {
            wizardState.area = 'hardware';
        } else if (subcategory === 'GIT - Printing') {
            wizardState.area = 'printing';
        } else if (subcategory === 'GIT - Network') {
            wizardState.area = 'network';
        } else if (subcategory === 'GIT - Google Services') {
            wizardState.area = 'google';
        } else if (category === 'Non-Helpdesk Requests') {
            wizardState.area = 'notHelpdesk';
        }
    }

    // For GIT areas, determine gitItem from subject
    if (wizardState.area && wizardState.area !== 'digital' && wizardState.area !== 'notHelpdesk' && subject) {
        var gitConfigs = {
            'hardware': WIZARD_CONFIG.gitHardware,
            'printing': WIZARD_CONFIG.gitPrinting,
            'network': WIZARD_CONFIG.gitNetwork,
            'google': WIZARD_CONFIG.gitGoogle
        };
        var items = gitConfigs[wizardState.area] || [];
        var matchedItem = items.find(function(item) { return item.subject === subject; });
        if (matchedItem) {
            wizardState.gitItem = matchedItem.id;
        }
    }

    // Determine nature from caseType
    if (caseType) {
        if (wizardState.area === 'digital') {
            if (caseType === 'Incident') wizardState.nature = 'problem';
            else if (caseType === 'Enquiry') wizardState.nature = 'training';
            else if (caseType === 'Service') wizardState.nature = 'service';
        } else {
            if (caseType === 'Incident') wizardState.nature = 'broken';
            else if (caseType === 'Enquiry') wizardState.nature = 'guidance';
            else if (caseType === 'Service') wizardState.nature = 'gitservice';
        }
    }

    // Go to summary step since we have full match
    wizardState.currentStep = needsStep4() ? 5 : 4;
}

/**
 * Check if form values can be fully matched to wizard options
 * Category must match what the wizard would set for that area
 * Subject must be CONSISTENT with Case Type for Digital areas
 */
function checkWizardMatch(caseType, category, subcategory, subject) {
    // Must have all required fields
    if (!caseType || !category || !subcategory || !subject) return false;

    // Must have valid caseType
    if (!['Incident', 'Enquiry', 'Service'].includes(caseType)) return false;

    // Determine area from subcategory
    var area = null;
    if (subcategory.startsWith('Digital -')) {
        area = 'digital';
    } else if (subcategory === 'GIT - Hardware') {
        area = 'hardware';
    } else if (subcategory === 'GIT - Printing') {
        area = 'printing';
    } else if (subcategory === 'GIT - Network') {
        area = 'network';
    } else if (subcategory === 'GIT - Google Services') {
        area = 'google';
    } else if (category === 'Non-Helpdesk Requests') {
        area = 'notHelpdesk';
    }

    // If area couldn't be determined (e.g., subcategory = "Others"), can't match
    if (!area) return false;

    // Category must match what the wizard would set for that area
    // GIT areas (hardware, printing, network, google)  Category must be "Infra / Device"
    // Non-Helpdesk  Category must be "Non-Helpdesk Requests"
    // Digital  Category is determined by digitalSystem config
    if (area === 'hardware' || area === 'printing' || area === 'network' || area === 'google') {
        if (category !== 'Infra / Device') return false;
    } else if (area === 'notHelpdesk') {
        if (category !== 'Non-Helpdesk Requests') return false;
    }

    // For Digital area, check if subcategory exists AND subject is consistent with caseType
    if (area === 'digital') {
        var digitalSystem = WIZARD_CONFIG.digitalSystems.find(function(s) {
            return s.subcategory === subcategory;
        });
        if (!digitalSystem) return false;

        // Category must match what the wizard sets for this digital system
        if (digitalSystem.category && category !== digitalSystem.category) return false;

        // Subject must be consistent with Case Type
        // Incident  Subject from digitalProblems
        // Enquiry  Subject is "Training / How-To Inquiry"
        // Service  Subject from digitalServices
        if (caseType === 'Incident') {
            var problemMatch = WIZARD_CONFIG.digitalProblems.find(function(p) { return p.subject === subject; });
            if (!problemMatch) return false;
        } else if (caseType === 'Enquiry') {
            if (subject !== 'Training / How-To Inquiry') return false;
        } else if (caseType === 'Service') {
            var serviceMatch = WIZARD_CONFIG.digitalServices.find(function(s) { return s.subject === subject; });
            if (!serviceMatch) return false;
        }
    }

    // For GIT areas, check if subject matches any GIT item
    // (GIT areas: subject is set in Step 2, Case Type is set in Step 3 independently)
    if (area !== 'digital' && area !== 'notHelpdesk') {
        var gitConfigs = {
            'hardware': WIZARD_CONFIG.gitHardware,
            'printing': WIZARD_CONFIG.gitPrinting,
            'network': WIZARD_CONFIG.gitNetwork,
            'google': WIZARD_CONFIG.gitGoogle
        };
        var items = gitConfigs[area] || [];
        var gitItemMatch = items.find(function(item) { return item.subject === subject; });
        if (!gitItemMatch) return false;
    }

    // All checks passed
    return true;
}

/**
 * Hide the Classification Wizard modal
 */
function hideClassificationWizard() {
    var modal = document.getElementById('classificationWizardModal');
    modal.classList.remove('show');
}

/**
 * Render the current wizard step
 */
function renderWizardStep() {
    var content = document.getElementById('wizardContent');
    var backBtn = document.getElementById('wizardBackBtn');
    var nextBtn = document.getElementById('wizardNextBtn');

    // Update progress indicators
    updateWizardProgress();

    // Show/hide back button
    backBtn.style.display = wizardState.currentStep > 1 ? 'block' : 'none';

    var html = '';

    switch (wizardState.currentStep) {
        case 1:
            html = renderStep1Area();
            nextBtn.innerHTML = 'Next <i class="fas fa-arrow-right"><\/i>';
            break;
        case 2:
            html = renderStep2Specific();
            nextBtn.innerHTML = 'Next <i class="fas fa-arrow-right"><\/i>';
            break;
        case 3:
            html = renderStep3Nature();
            nextBtn.innerHTML = 'Next <i class="fas fa-arrow-right"><\/i>';
            break;
        case 4:
            if (needsStep4()) {
                html = renderStep4Detail();
                nextBtn.innerHTML = 'Next <i class="fas fa-arrow-right"><\/i>';
            } else {
                html = renderSummary();
                nextBtn.innerHTML = '<i class="fas fa-check"><\/i> Apply';
            }
            break;
        case 5:
            html = renderSummary();
            nextBtn.innerHTML = '<i class="fas fa-check"><\/i> Apply';
            break;
    }

    content.innerHTML = html;

    // Update next button state
    updateNextButtonState();
}

/**
 * Check if Step 4 (detail selection) is needed
 */
function needsStep4() {
    // Only for Digital area with problem or service nature
    if (wizardState.area !== 'digital') return false;
    return wizardState.nature === 'problem' || wizardState.nature === 'service';
}

/**
 * Update wizard progress indicators with step labels
 */
function updateWizardProgress() {
    var progressContainer = document.getElementById('wizardProgress');
    var currentStep = wizardState.currentStep;
    var totalSteps = needsStep4() ? 5 : 4;

    // Get labels for each step based on selections
    var stepLabels = getWizardStepLabels();

    var html = '';
    for (var i = 1; i <= 4; i++) {
        var isActive = i === currentStep;
        var isCompleted = i < currentStep;
        var dotClass = isActive ? ' active' : (isCompleted ? ' completed' : '');
        var labelClass = isActive ? ' active' : (isCompleted ? ' completed' : '');
        var clickable = isCompleted ? ' clickable' : '';
        var clickHandler = isCompleted ? ' onclick="wizardGoToStep(' + i + ')"' : '';

        html += '<div class="wizard-step-item' + clickable + '"' + clickHandler + '>';
        html += '<div class="wizard-step-dot' + dotClass + '">';
        if (isCompleted) {
            html += '<i class="fas fa-check"><\/i>';
        } else if (i === 4) {
            html += '';
        } else {
            html += i;
        }
        html += '<\/div>';
        html += '<div class="wizard-step-label' + labelClass + '">' + (stepLabels[i] || '') + '<\/div>';
        html += '<\/div>';

        if (i < 4) {
            var lineClass = i < currentStep ? ' completed' : '';
            html += '<div class="wizard-step-line' + lineClass + '"><\/div>';
        }
    }

    progressContainer.innerHTML = html;
}

/**
 * Jump to a specific wizard step
 */
function wizardGoToStep(step) {
    // Only allow jumping to completed steps
    if (step < wizardState.currentStep) {
        wizardState.currentStep = step;
        renderWizardStep();
    }
}

/**
 * Get labels for wizard steps based on current selections
 */
function getWizardStepLabels() {
    var labels = { 1: 'Area', 2: 'Details', 3: 'Type', 4: 'Summary' };

    // Step 1 label
    if (wizardState.area) {
        var areaConfig = WIZARD_CONFIG.areas.find(function(a) { return a.id === wizardState.area; });
        if (areaConfig) {
            labels[1] = areaConfig.title;
        }
    }

    // Step 2 label
    if (wizardState.area === 'digital' && wizardState.subcategory) {
        // Extract system name from subcategory
        var systemName = wizardState.subcategory.replace('Digital - ', '');
        labels[2] = systemName;
    } else if (wizardState.subject && wizardState.area !== 'digital') {
        // For GIT areas, show abbreviated subject
        var subj = wizardState.subject;
        if (subj.startsWith('Hardware')) labels[2] = subj.replace('Hardware  ', '');
        else if (subj.startsWith('Printing')) labels[2] = subj.replace('Printing  ', '');
        else if (subj.startsWith('Network')) labels[2] = subj.replace('Network  ', '').replace('Network - ', '');
        else if (subj.startsWith('Google')) labels[2] = subj.replace('Google - ', '').replace('Google ', '');
        else labels[2] = subj.substring(0, 12) + (subj.length > 12 ? '...' : '');
    }

    // Step 3 label
    if (wizardState.nature) {
        var natureLabels = {
            'problem': 'Problem',
            'training': 'Training',
            'service': 'Service',
            'broken': 'Broken',
            'guidance': 'Guidance',
            'gitservice': 'Service'
        };
        labels[3] = natureLabels[wizardState.nature] || 'Type';
    }

    return labels;
}

/**
 * Render Step 1: Area selection
 */
function renderStep1Area() {
    var html = '<div class="wizard-question">';
    html += '<h3>What is this request about?<\/h3>';
    html += '<p>Select the area this request relates to<\/p>';
    html += '<\/div>';

    html += '<div class="wizard-options">';
    WIZARD_CONFIG.areas.forEach(function(area) {
        var selected = wizardState.area === area.id ? ' selected' : '';
        html += '<div class="wizard-option' + selected + '" onclick="selectWizardOption(\'area\', \'' + area.id + '\')">';
        html += '<div class="wizard-option-icon">' + area.icon + '<\/div>';
        html += '<div class="wizard-option-content">';
        html += '<div class="wizard-option-title">' + area.title + '<\/div>';
        html += '<div class="wizard-option-desc">' + area.desc + '<\/div>';
        html += '<\/div>';
        html += '<div class="wizard-option-check"><i class="fas fa-check"><\/i><\/div>';
        html += '<\/div>';
    });
    html += '<\/div>';

    return html;
}

/**
 * Render Step 2: Specific item selection
 */
function renderStep2Specific() {
    var html = '<div class="wizard-question">';

    if (wizardState.area === 'digital') {
        html += '<h3>Which digital system?<\/h3>';
        html += '<p>Select the system this request involves<\/p>';
        html += '<\/div>';

        html += '<div class="wizard-options grid-layout">';
        WIZARD_CONFIG.digitalSystems.forEach(function(system) {
            var selected = wizardState.subcategory === system.subcategory ? ' selected' : '';
            html += '<div class="wizard-option' + selected + '" onclick="selectWizardOption(\'subcategory\', \'' + system.subcategory + '\')">';
            html += '<div class="wizard-option-icon"><\/div>';
            html += '<div class="wizard-option-content">';
            html += '<div class="wizard-option-title">' + system.title + '<\/div>';
            html += '<\/div>';
            html += '<div class="wizard-option-check"><i class="fas fa-check"><\/i><\/div>';
            html += '<\/div>';
        });
        html += '<\/div>';
    } else {
        // GIT areas - show specific items that set Subject
        var items, title, icon;
        switch (wizardState.area) {
            case 'hardware':
                items = WIZARD_CONFIG.gitHardware;
                title = 'What hardware issue?';
                icon = '';
                break;
            case 'printing':
                items = WIZARD_CONFIG.gitPrinting;
                title = 'What printing issue?';
                icon = '';
                break;
            case 'network':
                items = WIZARD_CONFIG.gitNetwork;
                title = 'What network issue?';
                icon = '';
                break;
            case 'google':
                items = WIZARD_CONFIG.gitGoogle;
                title = 'What Google issue?';
                icon = '';
                break;
        }

        html += '<h3>' + title + '<\/h3>';
        html += '<p>Select what this request involves<\/p>';
        html += '<\/div>';

        html += '<div class="wizard-options">';
        items.forEach(function(item) {
            var selected = (wizardState.gitItem === item.id || wizardState.subject === item.subject) ? ' selected' : '';
            html += '<div class="wizard-option' + selected + '" onclick="selectWizardOption(\'gitItem\', \'' + item.id + '\', \'' + escapeHtml(item.subject) + '\')">';
            html += '<div class="wizard-option-icon">' + icon + '<\/div>';
            html += '<div class="wizard-option-content">';
            html += '<div class="wizard-option-title">' + item.title + '<\/div>';
            if (item.desc) {
                html += '<div class="wizard-option-desc">' + item.desc + '<\/div>';
            }
            html += '<\/div>';
            html += '<div class="wizard-option-check"><i class="fas fa-check"><\/i><\/div>';
            html += '<\/div>';
        });
        html += '<\/div>';
    }

    return html;
}

/**
 * Render Step 3: Nature of request
 */
function renderStep3Nature() {
    var html = '<div class="wizard-question">';
    html += '<h3>What does the requester need?<\/h3>';
    html += '<p>Select the type of help needed<\/p>';
    html += '<\/div>';

    var items = wizardState.area === 'digital' ? WIZARD_CONFIG.digitalNature : WIZARD_CONFIG.gitNature;

    html += '<div class="wizard-options">';
    items.forEach(function(item) {
        var selected = wizardState.nature === item.id ? ' selected' : '';
        html += '<div class="wizard-option' + selected + '" onclick="selectWizardOption(\'nature\', \'' + item.id + '\')">';
        html += '<div class="wizard-option-icon">' + item.icon + '<\/div>';
        html += '<div class="wizard-option-content">';
        html += '<div class="wizard-option-title">' + item.title + '<\/div>';
        html += '<div class="wizard-option-desc">' + item.desc + '<\/div>';
        html += '<\/div>';
        html += '<div class="wizard-option-check"><i class="fas fa-check"><\/i><\/div>';
        html += '<\/div>';
    });
    html += '<\/div>';

    return html;
}

/**
 * Render Step 4: Detail selection (Digital problem or service)
 */
function renderStep4Detail() {
    var html = '<div class="wizard-question">';

    if (wizardState.nature === 'problem') {
        html += '<h3>What kind of problem?<\/h3>';
        html += '<p>Select what best describes the problem<\/p>';
        html += '<\/div>';

        html += '<div class="wizard-options">';
        WIZARD_CONFIG.digitalProblems.forEach(function(item) {
            var selected = wizardState.subject === item.subject ? ' selected' : '';
            html += '<div class="wizard-option' + selected + '" onclick="selectWizardOption(\'problem\', \'' + item.id + '\', \'' + escapeHtml(item.subject) + '\', \'' + escapeHtml(item.category) + '\')">';
            html += '<div class="wizard-option-icon"><\/div>';
            html += '<div class="wizard-option-content">';
            html += '<div class="wizard-option-title">' + item.title + '<\/div>';
            html += '<\/div>';
            html += '<div class="wizard-option-check"><i class="fas fa-check"><\/i><\/div>';
            html += '<\/div>';
        });
        html += '<\/div>';
    } else if (wizardState.nature === 'service') {
        html += '<h3>What service is needed?<\/h3>';
        html += '<p>Select the service the requester needs<\/p>';
        html += '<\/div>';

        html += '<div class="wizard-options">';
        WIZARD_CONFIG.digitalServices.forEach(function(item) {
            var selected = wizardState.subject === item.subject ? ' selected' : '';
            html += '<div class="wizard-option' + selected + '" onclick="selectWizardOption(\'service\', \'' + item.id + '\', \'' + escapeHtml(item.subject) + '\')">';
            html += '<div class="wizard-option-icon"><\/div>';
            html += '<div class="wizard-option-content">';
            html += '<div class="wizard-option-title">' + item.title + '<\/div>';
            html += '<\/div>';
            html += '<div class="wizard-option-check"><i class="fas fa-check"><\/i><\/div>';
            html += '<\/div>';
        });
        html += '<\/div>';
    }

    return html;
}

/**
 * Render Summary step
 */
function renderSummary() {
    // Calculate final values
    calculateFinalClassification();

    var html = '<div class="wizard-question">';
    html += '<h3>Review Classification<\/h3>';
    html += '<p>Confirm the classification below<\/p>';
    html += '<\/div>';

    // Internal Staff toggle (only show for Service type)
    if (wizardState.caseType === 'Service') {
        html += '<div class="wizard-toggle-row">';
        html += '<div>';
        html += '<div class="wizard-toggle-label">Internal Staff Request?<\/div>';
        html += '<div class="wizard-toggle-hint">Turn on if requester is a company employee<\/div>';
        html += '<\/div>';
        html += '<div class="wizard-toggle' + (wizardState.isInternalStaff ? ' active' : '') + '" onclick="toggleInternalStaff()"><\/div>';
        html += '<\/div>';
    }

    html += '<div class="wizard-summary">';
    html += '<div class="wizard-summary-row">';
    html += '<span class="wizard-summary-label">Case Type<\/span>';
    html += '<span class="wizard-summary-value">' + wizardState.caseType + '<\/span>';
    html += '<\/div>';
    html += '<div class="wizard-summary-row">';
    html += '<span class="wizard-summary-label">Category<\/span>';
    html += '<span class="wizard-summary-value">' + wizardState.category + '<\/span>';
    html += '<\/div>';
    html += '<div class="wizard-summary-row">';
    html += '<span class="wizard-summary-label">Subcategory<\/span>';
    html += '<span class="wizard-summary-value">' + wizardState.subcategory + '<\/span>';
    html += '<\/div>';
    html += '<div class="wizard-summary-row">';
    html += '<span class="wizard-summary-label">Subject<\/span>';
    html += '<span class="wizard-summary-value">' + wizardState.subject + '<\/span>';
    html += '<\/div>';
    html += '<\/div>';

    return html;
}

/**
 * Calculate final classification values based on wizard selections
 */
function calculateFinalClassification() {
    // Case Type is already set from nature selection
    // But need to determine Category based on various factors

    if (wizardState.area === 'notHelpdesk') {
        wizardState.caseType = 'Enquiry';
        wizardState.category = 'Non-Helpdesk Requests';
        wizardState.subcategory = 'Others';
        wizardState.subject = 'Others';
        return;
    }

    // For Digital area
    if (wizardState.area === 'digital') {
        if (wizardState.nature === 'training') {
            wizardState.caseType = 'Enquiry';
            wizardState.category = 'Business Usage / Training';
            wizardState.subject = 'Training / How-To Inquiry';
        } else if (wizardState.nature === 'problem') {
            wizardState.caseType = 'Incident';
            // Category is set per problem type in Step 4
        } else if (wizardState.nature === 'service') {
            wizardState.caseType = 'Service';
            // Check if internal staff
            if (wizardState.isInternalStaff) {
                wizardState.category = 'Staff Service Requests';
            } else {
                wizardState.category = 'Application Functionality / Data Issue';
            }
        }
    } else {
        // For GIT areas
        if (wizardState.nature === 'broken') {
            wizardState.caseType = 'Incident';
            wizardState.category = 'Infra / Device';
        } else if (wizardState.nature === 'guidance') {
            wizardState.caseType = 'Enquiry';
            wizardState.category = 'Business Usage / Training';
        } else if (wizardState.nature === 'gitservice') {
            wizardState.caseType = 'Service';
            if (wizardState.isInternalStaff) {
                wizardState.category = 'Staff Service Requests';
            } else {
                wizardState.category = 'Infra / Device';
            }
        }
    }
}

/**
 * Toggle internal staff flag
 */
function toggleInternalStaff() {
    wizardState.isInternalStaff = !wizardState.isInternalStaff;
    renderWizardStep();
}

/**
 * Select a wizard option
 */
function selectWizardOption(type, value, subject, category) {
    switch (type) {
        case 'area':
            wizardState.area = value;
            // Reset subsequent selections
            wizardState.subcategory = null;
            wizardState.nature = null;
            wizardState.subject = null;
            wizardState.category = null;

            // Set subcategory for GIT areas
            var areaConfig = WIZARD_CONFIG.areas.find(function(a) { return a.id === value; });
            if (areaConfig && areaConfig.subcategory) {
                wizardState.subcategory = areaConfig.subcategory;
            }
            break;

        case 'subcategory':
            wizardState.subcategory = value;
            break;

        case 'gitItem':
            wizardState.gitItem = value;
            wizardState.subject = subject;
            break;

        case 'nature':
            wizardState.nature = value;
            // Only reset subject for Digital flow (subject will be set in Step 4)
            // For GIT flow, subject is already set in Step 2
            if (wizardState.area === 'digital') {
                wizardState.subject = null;
            }

            // Set immediate values for training
            var natureConfig;
            if (wizardState.area === 'digital') {
                natureConfig = WIZARD_CONFIG.digitalNature.find(function(n) { return n.id === value; });
            } else {
                natureConfig = WIZARD_CONFIG.gitNature.find(function(n) { return n.id === value; });
            }
            if (natureConfig) {
                wizardState.caseType = natureConfig.caseType;
                if (natureConfig.subject) wizardState.subject = natureConfig.subject;
                if (natureConfig.category) wizardState.category = natureConfig.category;
            }
            break;

        case 'problem':
            wizardState.subject = subject;
            wizardState.category = category;
            break;

        case 'service':
            wizardState.subject = subject;
            break;
    }

    // Re-render to show selection
    renderWizardStep();
}

/**
 * Update next button state
 */
function updateNextButtonState() {
    var nextBtn = document.getElementById('wizardNextBtn');
    var canProceed = false;

    switch (wizardState.currentStep) {
        case 1:
            canProceed = wizardState.area !== null;
            break;
        case 2:
            if (wizardState.area === 'digital') {
                canProceed = wizardState.subcategory !== null;
            } else {
                canProceed = wizardState.subject !== null;
            }
            break;
        case 3:
            canProceed = wizardState.nature !== null;
            break;
        case 4:
            if (needsStep4()) {
                canProceed = wizardState.subject !== null;
            } else {
                canProceed = true; // Summary step
            }
            break;
        case 5:
            canProceed = true; // Summary step
            break;
    }

    nextBtn.disabled = !canProceed;
}

/**
 * Go to next wizard step
 */
function wizardGoNext() {
    // Handle Not Helpdesk shortcut
    if (wizardState.area === 'notHelpdesk') {
        // Skip to summary
        wizardState.currentStep = needsStep4() ? 5 : 4;
        renderWizardStep();
        return;
    }

    // Check if we're at summary step
    var summaryStep = needsStep4() ? 5 : 4;
    if (wizardState.currentStep >= summaryStep) {
        // Apply classification and close
        applyWizardClassification();
        return;
    }

    // Move to next step
    wizardState.currentStep++;

    // Skip Step 4 if not needed (e.g., training selected)
    if (wizardState.currentStep === 4 && !needsStep4()) {
        // Go to summary instead
    }

    renderWizardStep();
}

/**
 * Go to previous wizard step
 */
function wizardGoBack() {
    if (wizardState.currentStep > 1) {
        wizardState.currentStep--;

        // Skip back over Step 4 if it wasn't needed
        if (wizardState.currentStep === 4 && !needsStep4()) {
            wizardState.currentStep = 3;
        }

        renderWizardStep();
    }
}

/**
 * Apply the wizard classification to the form
 */
function applyWizardClassification() {
    // Set form values using custom dropdown functions
    setCustomDropdownValue('caseType', wizardState.caseType);
    setCustomDropdownValue('category', wizardState.category);
    updateSubcategories(false); // Update subcategory options based on category
    setCustomDropdownValue('subcategory', wizardState.subcategory);
    updateSubjects(false); // Update subject options based on subcategory
    setCustomDropdownValue('subject', wizardState.subject);

    // Close wizard
    hideClassificationWizard();

    // Show success message
    showToast('Classification applied', 'success');
}

/**
 * Helper: Escape HTML for safe insertion
 */
function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/'/g, "\\'").replace(/"/g, '&quot;');
}

/**
 * Update preset buttons highlight based on current selection
 */
function updatePresetButtonsHighlight(currentValue) {
    var presetValues = ['today', '7days', '30days', 'thisMonth', 'lastMonth', 'thisYear', 'lastYear'];
    document.querySelectorAll('.period-preset-btn').forEach(function(btn) {
        var isActive = btn.dataset.period === currentValue && presetValues.includes(currentValue);
        btn.classList.toggle('active', isActive);
    });
    selectedPeriodPreset = presetValues.includes(currentValue) ? currentValue : null;
}

/**
 * Select a preset period (called when clicking preset buttons)
 */
function selectPeriodPreset(period) {
    selectedPeriodPreset = period;

    // Clear custom selection
    periodCustomTab = null;

    // Update button highlighting
    document.querySelectorAll('.period-preset-btn').forEach(function(btn) {
        btn.classList.toggle('active', btn.dataset.period === period);
    });

    // Clear custom tab highlighting
    document.querySelectorAll('.period-custom-tab').forEach(function(btn) {
        btn.classList.remove('active');
    });

    // Clear custom input highlights
    clearCustomInputHighlights();
}

/**
 * Clear highlight class from all custom input fields
 */
function clearCustomInputHighlights() {
    document.getElementById('periodMonthPicker').classList.remove('highlighted');
    document.getElementById('periodYearPicker').classList.remove('highlighted');
    document.getElementById('periodDatePicker').classList.remove('highlighted');
    document.getElementById('periodRangeStart').classList.remove('highlighted');
    document.getElementById('periodRangeEnd').classList.remove('highlighted');
}

/**
 * Show custom panel only without changing any selection state
 * Used when preset is selected but we need to show a default panel
 */
function showCustomPanelOnly(tab) {
    // Clear custom tab highlights (no custom tab is selected when preset is active)
    document.querySelectorAll('.period-custom-tab').forEach(function(btn) {
        btn.classList.remove('active');
    });

    // Update panels
    document.querySelectorAll('.period-custom-panel').forEach(function(panel) {
        panel.classList.remove('active');
    });
    document.getElementById('periodPanel' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
}

/**
 * Activate custom tab mode when user changes a custom input value
 * This clears preset selection without switching panels (panel is already showing)
 */
function activateCustomTab(tab) {
    // Set custom tab and clear preset selection
    periodCustomTab = tab;
    selectedPeriodPreset = null;

    // Clear preset button highlights
    document.querySelectorAll('.period-preset-btn').forEach(function(btn) {
        btn.classList.remove('active');
    });

    // Highlight the corresponding custom tab button
    document.querySelectorAll('.period-custom-tab').forEach(function(btn) {
        btn.classList.toggle('active', btn.dataset.tab === tab);
    });

    // Clear all custom input highlights first
    clearCustomInputHighlights();

    // Highlight the input that was changed
    if (tab === 'month') {
        document.getElementById('periodMonthPicker').classList.add('highlighted');
    } else if (tab === 'year') {
        document.getElementById('periodYearPicker').classList.add('highlighted');
    } else if (tab === 'date') {
        document.getElementById('periodDatePicker').classList.add('highlighted');
    } else if (tab === 'range') {
        document.getElementById('periodRangeStart').classList.add('highlighted');
        document.getElementById('periodRangeEnd').classList.add('highlighted');
    }
}

/**
 * Switch between tabs in the Period custom section
 * This clears preset selection and activates the custom tab
 */
function switchPeriodCustomTab(tab) {
    periodCustomTab = tab;

    // Clear preset selection when switching to custom
    selectedPeriodPreset = null;
    document.querySelectorAll('.period-preset-btn').forEach(function(btn) {
        btn.classList.remove('active');
    });

    // Clear custom input highlights when switching tabs
    clearCustomInputHighlights();

    // Update custom tab buttons - highlight the active tab
    document.querySelectorAll('.period-custom-tab').forEach(function(btn) {
        btn.classList.toggle('active', btn.dataset.tab === tab);
    });

    // Update panels
    document.querySelectorAll('.period-custom-panel').forEach(function(panel) {
        panel.classList.remove('active');
    });
    document.getElementById('periodPanel' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
}

/**
 * Apply the selected period (preset or custom)
 */
async function applyPeriodSelection() {
    var now = new Date();
    var filterValue, displayText;
    var start, end;

    try {
        // Determine if preset or custom
        if (selectedPeriodPreset) {
            // Preset selected
            filterValue = selectedPeriodPreset;
            displayText = getPresetDisplayText(selectedPeriodPreset);
            customDateRange = null;
            if (periodModalMode === 'admin') {
                adminCustomDateRange = null;
            }
        } else if (periodCustomTab) {
            // Custom selection
            filterValue = 'custom';

            switch (periodCustomTab) {
                case 'month':
                    var monthValue = document.getElementById('periodMonthPicker').value;
                    if (!monthValue) {
                        showToast('Please select a month', 'error');
                        return;
                    }
                    var [year, month] = monthValue.split('-').map(Number);
                    start = new Date(year, month - 1, 1);
                    end = new Date(year, month, 0, 23, 59, 59);
                    displayText = start.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    break;

                case 'year':
                    var yearValue = document.getElementById('periodYearPicker').value;
                    if (!yearValue) {
                        showToast('Please select a year', 'error');
                        return;
                    }
                    var selectedYear = parseInt(yearValue);
                    start = new Date(selectedYear, 0, 1);
                    // For current/future year, end date is today
                    if (selectedYear >= now.getFullYear()) {
                        end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
                    } else {
                        end = new Date(selectedYear, 11, 31, 23, 59, 59);
                    }
                    displayText = yearValue;
                    break;

                case 'date':
                    var dateValue = document.getElementById('periodDatePicker').value;
                    if (!dateValue) {
                        showToast('Please select a date', 'error');
                        return;
                    }
                    var selected = new Date(dateValue);
                    start = new Date(selected.getFullYear(), selected.getMonth(), selected.getDate());
                    end = new Date(selected.getFullYear(), selected.getMonth(), selected.getDate(), 23, 59, 59);
                    displayText = start.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' });
                    break;

                case 'range':
                    var rangeStart = document.getElementById('periodRangeStart').value;
                    var rangeEnd = document.getElementById('periodRangeEnd').value;
                    if (!rangeStart || !rangeEnd) {
                        showToast('Please select both start and end dates', 'error');
                        return;
                    }
                    start = new Date(rangeStart);
                    end = new Date(rangeEnd);
                    end.setHours(23, 59, 59);

                    if (end < start) {
                        showToast('End date must be after start date', 'error');
                        return;
                    }

                    var diffDays = (end - start) / (1000 * 60 * 60 * 24);
                    if (diffDays > 365) {
                        showToast('Date range cannot exceed 1 year', 'error');
                        return;
                    }

                    var startText = start.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
                    var endText = end.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' });
                    displayText = startText + ' - ' + endText;
                    break;
            }

            // Store custom date range
            if (periodModalMode === 'admin') {
                adminCustomDateRange = { start, end };
            } else {
                customDateRange = { start, end };
            }
        } else {
            showToast('Please select a period', 'error');
            return;
        }

        // Save the selection for restoring when modal opens again
        var selectionToSave;
        if (selectedPeriodPreset) {
            selectionToSave = { type: 'preset', preset: selectedPeriodPreset, customTab: null, customValue: null };
        } else {
            var customValue = null;
            switch (periodCustomTab) {
                case 'month':
                    customValue = document.getElementById('periodMonthPicker').value;
                    break;
                case 'year':
                    customValue = document.getElementById('periodYearPicker').value;
                    break;
                case 'date':
                    customValue = document.getElementById('periodDatePicker').value;
                    break;
                case 'range':
                    customValue = {
                        start: document.getElementById('periodRangeStart').value,
                        end: document.getElementById('periodRangeEnd').value
                    };
                    break;
            }
            selectionToSave = { type: 'custom', preset: null, customTab: periodCustomTab, customValue: customValue };
        }

        if (periodModalMode === 'admin') {
            lastAdminSelection = selectionToSave;
        } else {
            lastDashboardSelection = selectionToSave;
        }

        // Hide modal first
        hidePeriodModal();

        // Update the appropriate filter and button
        if (periodModalMode === 'admin') {
            document.getElementById('adminPeriodFilter').value = filterValue;
            document.getElementById('adminPeriodButtonText').textContent = displayText;

            // Determine the date range for this selection
            // For custom selections, use the start/end we just calculated; for presets, calculate from filter
            var adminReqStartStr, adminReqEndStr;
            if (filterValue === 'custom' && start && end) {
                adminReqStartStr = formatLocalDate(start);
                adminReqEndStr = formatLocalDate(end);
            } else {
                var adminReqRange = getAdminRequiredDateRange(filterValue);
                adminReqStartStr = formatLocalDate(adminReqRange.start);
                adminReqEndStr = formatLocalDate(adminReqRange.end);
            }

            // Check if data is already cached and covers the requested range
            if (cases.length > 0 && isDateRangeCovered(adminReqStartStr, adminReqEndStr)) {
                // Data already available from Dashboard or previous load
                console.log('Admin: Using existing cached data for requested range');
                showToast('Using cached data', 'info');
            } else {
                // Need to load data - either delta or full
                console.log('Admin: Need to load data for range', adminReqStartStr, 'to', adminReqEndStr);
                await loadDeltaData(filterValue, true); // true = admin context
            }

            // Sync adminCases with cases (they share the same data)
            adminCases = cases;

            filterAndRenderAdminCases();
            buildAdminSummaryFromCases();
            renderUserSummary();
            updateAdminDataLoadedRange();
            await checkMissingMonthsForAdminPeriod();
        } else {
            document.getElementById('dateFilter').value = filterValue;
            document.getElementById('periodButtonText').textContent = displayText;

            // Determine the date range for this selection
            var reqStartStr, reqEndStr;
            if (filterValue === 'custom' && start && end) {
                reqStartStr = formatLocalDate(start);
                reqEndStr = formatLocalDate(end);
            } else {
                var reqRange = getRequiredDateRange(filterValue);
                reqStartStr = formatLocalDate(reqRange.start);
                reqEndStr = formatLocalDate(reqRange.end);
            }

            // Check if data is already cached and covers the requested range
            if (cases.length > 0 && isDateRangeCovered(reqStartStr, reqEndStr)) {
                // Data already available
                console.log('Dashboard: Using existing cached data for requested range');
                showToast('Using cached data', 'info');
            } else {
                // Need to load data - either delta or full
                console.log('Dashboard: Need to load data for range', reqStartStr, 'to', reqEndStr);
                await loadDeltaData(filterValue);
            }

            applyFilters();
            updateDataLoadedRange();
            updateStats();
            await checkMissingMonthsForCurrentPeriod();
        }

    } catch (err) {
        console.error('applyPeriodSelection error:', err);
        showToast('Error applying period: ' + err.message, 'error');
    }
}

/**
 * Get display text for preset periods
 */
function getPresetDisplayText(preset) {
    var texts = {
        'today': 'Today',
        '7days': 'Last 7 Days',
        '30days': 'Last 30 Days',
        'thisMonth': 'This Month',
        'lastMonth': 'Last Month',
        'thisYear': 'This Year',
        'lastYear': 'Last Year'
    };
    return texts[preset] || preset;
}

/**
 * Check if admin mode needs delta load
 * Uses date string comparison to avoid timezone issues
 */
function needsAdminDeltaLoad(filter) {
    if (!adminCachedStartDate) return false;
    var requiredRange = getAdminRequiredDateRange(filter);

    // Normalize dates to YYYY-MM-DD strings for comparison
    var requiredStartStr = formatLocalDate(requiredRange.start);
    var cachedStartStr = typeof adminCachedStartDate === 'string'
        ? adminCachedStartDate.slice(0, 10)
        : formatLocalDate(adminCachedStartDate);

    var needsLoad = requiredStartStr < cachedStartStr;
    console.log('needsAdminDeltaLoad check:', { filter, requiredStartStr, cachedStartStr, needsLoad });
    return needsLoad;
}

/**
 * Get admin required date range for a filter
 */
function getAdminRequiredDateRange(filter) {
    var now = new Date();
    var start, end = new Date(now);

    if (filter === 'custom' && adminCustomDateRange) {
        return { start: adminCustomDateRange.start, end: adminCustomDateRange.end };
    }

    switch (filter) {
        case 'today':
            start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            break;
        case '7days':
            start = new Date(now); start.setDate(start.getDate() - 7);
            break;
        case 'thisMonth':
            start = new Date(now.getFullYear(), now.getMonth(), 1);
            break;
        case '30days':
            start = new Date(now); start.setDate(start.getDate() - 30);
            break;
        case 'lastMonth':
            start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            end = new Date(now.getFullYear(), now.getMonth(), 0);
            break;
        case 'thisYear':
            start = new Date(now.getFullYear(), 0, 1);
            break;
        case 'lastYear':
            start = new Date(now.getFullYear() - 1, 0, 1);
            end = new Date(now.getFullYear() - 1, 11, 31);
            break;
        default:
            start = new Date(now); start.setDate(start.getDate() - 30);
    }
    return { start, end };
}

/**
 * Update the admin data loaded range display
 */
function updateAdminDataLoadedRange() {
    var rangeEl = document.getElementById('adminDataLoadedRange');
    if (!rangeEl) return;

    if (adminCachedStartDate && adminCachedEndDate) {
        var startDate = new Date(adminCachedStartDate);
        var endDate = new Date(adminCachedEndDate);
        var startStr = startDate.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' });
        var endStr = endDate.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' });
        rangeEl.innerHTML = '<i class="fas fa-database"><\/i> Cached: ' + startStr + ' - ' + endStr;
    } else {
        rangeEl.innerHTML = '';
    }
}

/**
 * Check missing months for admin period
 */
async function checkMissingMonthsForAdminPeriod() {
    // Similar to checkMissingMonthsForCurrentPeriod but for admin
    var warningIcon = document.getElementById('adminPeriodWarningIcon');
    var button = document.getElementById('adminPeriodButton');
    if (!warningIcon || !button) return;

    try {
        var dateRange = getAdminDateRange();
        var response = await fetch(API_URL + '?token=' + encodeURIComponent(googleCredential) + '&action=checkMissingMonths&startDate=' + dateRange.startDate + '&endDate=' + dateRange.endDate);
        var result = await response.json();

        if (result.success && result.missingMonths && result.missingMonths.length > 0) {
            warningIcon.style.display = 'inline';
            warningIcon.title = 'Missing spreadsheets: ' + result.missingMonths.join(', ');
            button.classList.add('has-warning');
        } else {
            warningIcon.style.display = 'none';
            button.classList.remove('has-warning');
        }
    } catch (err) {
        console.error('Error checking admin missing months:', err);
        warningIcon.style.display = 'none';
        button.classList.remove('has-warning');
    }
}

// Check if the selected period requires data beyond our cached window
// Compares using date-only values (ignoring time) to avoid timezone issues
function needsDeltaLoad(filter) {
    if (!adminCachedStartDate) return false;
    const requiredRange = getRequiredDateRange(filter);

    // Normalize dates to YYYY-MM-DD strings for comparison (avoid timezone issues)
    const requiredStartStr = formatLocalDate(requiredRange.start);
    const cachedStartStr = typeof adminCachedStartDate === 'string'
        ? adminCachedStartDate.slice(0, 10)
        : formatLocalDate(adminCachedStartDate);

    // Only need delta load if required start is BEFORE cached start
    const needsLoad = requiredStartStr < cachedStartStr;
    console.log('needsDeltaLoad check:', { filter, requiredStartStr, cachedStartStr, needsLoad });
    return needsLoad;
}

// Get the date range required for a filter
function getRequiredDateRange(filter) {
    const now = new Date();
    let start, end = new Date(now);
    switch (filter) {
        case 'today':
            start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            break;
        case '7days':
            start = new Date(now); start.setDate(start.getDate() - 7);
            break;
        case 'thisMonth':
            start = new Date(now.getFullYear(), now.getMonth(), 1);
            break;
        case '30days':
            start = new Date(now); start.setDate(start.getDate() - 30);
            break;
        case 'lastMonth':
            start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            end = new Date(now.getFullYear(), now.getMonth(), 0); // Last day of previous month
            break;
        case 'thisYear':
            start = new Date(now.getFullYear(), 0, 1);
            break;
        case 'lastYear':
            start = new Date(now.getFullYear() - 1, 0, 1);
            end = new Date(now.getFullYear() - 1, 11, 31); // Dec 31 of last year
            break;
        case 'custom':
            // For custom selection, use customDateRange if set
            if (customDateRange) {
                start = customDateRange.start;
                end = customDateRange.end;
            } else {
                start = new Date(now.getFullYear(), 0, 1);
            }
            break;
        default:
            start = new Date(now); start.setDate(start.getDate() - 7);
    }
    return { start, end };
}

// Load additional data for periods beyond our cached window
// Uses unified loadCases() function - same logic for both admin and non-admin
// isAdminContext parameter indicates whether this is called from admin section (uses adminCustomDateRange)
async function loadDeltaData(filter, isAdminContext = false) {
    try {
        // Use appropriate date range based on context
        var requiredRange;
        if (isAdminContext) {
            requiredRange = getAdminRequiredDateRange(filter);
        } else {
            requiredRange = getRequiredDateRange(filter);
        }

        // Parse cached start date consistently
        var cachedStartStr = typeof adminCachedStartDate === 'string'
            ? adminCachedStartDate.slice(0, 10)
            : formatLocalDate(adminCachedStartDate);
        var requiredStartStr = formatLocalDate(requiredRange.start);
        var requiredEndStr = formatLocalDate(requiredRange.end);

        // If required range is within cached range, no need to load more
        if (requiredStartStr >= cachedStartStr) {
            console.log('Delta load not needed: required start', requiredStartStr, 'is on or after cached start', cachedStartStr);
            return;
        }

        // Calculate delta end date (day before cached start)
        var cachedStartParts = cachedStartStr.split('-');
        var cachedStart = new Date(parseInt(cachedStartParts[0]), parseInt(cachedStartParts[1]) - 1, parseInt(cachedStartParts[2]));
        var deltaEndDate = new Date(cachedStart);
        deltaEndDate.setDate(deltaEndDate.getDate() - 1);

        var startDate = requiredStartStr;
        var endDate = formatLocalDate(deltaEndDate);

        console.log('Loading delta data from', startDate, 'to', endDate);

        // Use unified loadCases function - same logic for both admin and non-admin
        var worksheetsToLoad = getWorksheetsToLoad();
        console.log('Worksheets to load:', JSON.stringify(worksheetsToLoad));

        var deltaResult = await loadCases({
            startDate: startDate,
            endDate: endDate,
            worksheets: worksheetsToLoad,
            showProgress: true,
            progressPrefix: 'Loading additional data...'
        });

        console.log('Loaded delta cases:', deltaResult.cases.length);

        // Prepend delta cases to existing cases
        cases = deltaResult.cases.concat(cases);

        // Keep adminCases in sync for Team Breakdown
        if (isAdmin) {
            adminCases = cases;
        }

        // Update cached start date
        // Use actual date from loaded data if available, otherwise use requested start date
        // This ensures cache is extended even if no data exists for the period
        var newStartDate = deltaResult.actualStartDate || startDate;
        if (!adminCachedStartDate || newStartDate < adminCachedStartDate) {
            adminCachedStartDate = newStartDate;
            console.log('Updated adminCachedStartDate to:', adminCachedStartDate);
        }

        updateDataLoadedRange();
        showToast('Loaded ' + deltaResult.cases.length + ' additional cases', 'success');
    } catch (err) {
        console.error('loadDeltaData error:', err);
        hideLoadingOverlay();
        showToast('Error loading additional data: ' + err.message, 'error');
    }
}

function getDateRange() {
    const filter = document.getElementById('dateFilter').value, now = new Date(), today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

    // Return custom range if set
    if (filter === 'custom' && customDateRange) {
        return customDateRange;
    }

    let start, end;
    switch(filter) {
        case 'today':
            start = today;
            end = new Date(now.getTime() + 86400000);
            break;
        case '7days':
            start = new Date(today - 7 * 86400000);
            end = new Date(now.getTime() + 86400000);
            break;
        case '30days':
            start = new Date(today - 30 * 86400000);
            end = new Date(now.getTime() + 86400000);
            break;
        case 'thisMonth':
            start = new Date(now.getFullYear(), now.getMonth(), 1);
            end = new Date(now.getTime() + 86400000);
            break;
        case 'lastMonth':
            start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            end = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59); // Last day of previous month
            break;
        case 'thisYear':
            start = new Date(now.getFullYear(), 0, 1);
            end = new Date(now.getTime() + 86400000);
            break;
        case 'lastYear':
            start = new Date(now.getFullYear() - 1, 0, 1);
            end = new Date(now.getFullYear() - 1, 11, 31, 23, 59, 59); // Dec 31 of last year
            break;
        default:
            start = new Date(today - 30 * 86400000);
            end = new Date(now.getTime() + 86400000);
    }
    return { start, end };
}

function filterByStat(stat) {
    document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
    if (activeFilters.stat === stat) { activeFilters.stat = null; } else { activeFilters.stat = stat; document.getElementById(`statCard${stat.charAt(0).toUpperCase() + stat.slice(1)}`).classList.add('active'); }
    applyFilters();
    if (document.activeElement) document.activeElement.blur();
}

function toggleChannel(btn) {
    const channel = btn.dataset.channel;
    if (selectedChannels.includes(channel)) {
        if (selectedChannels.length === 1) { btn.blur(); return; } // Must have at least one selected
        selectedChannels = selectedChannels.filter(c => c !== channel);
        btn.classList.remove('active');
    } else {
        selectedChannels.push(channel);
        btn.classList.add('active');
    }
    applyFilters();
    btn.blur();
}

function applyFilters() {
    try {
        if (!currentUser) { hideTableLoading(); return; }
        if (!cases || cases.length === 0) { hideTableLoading(); return; }

        // Show table loading for large datasets
        if (cases.length > 100) {
            showTableLoading();
            // Use setTimeout to allow UI to update before heavy processing
            setTimeout(() => applyFiltersInternal(), 10);
            return;
        }
        applyFiltersInternal();
    } catch (e) {
        hideTableLoading();
        console.log('applyFilters error:', JSON.stringify(e.message));
    }
}

function applyFiltersInternal() {
    try {
        if (!currentUser) return;
        if (!cases || cases.length === 0) return;

        // For admin: filter by selected colleague or show all helpdesk cases
        // For helpdesk user: show all cases from their worksheet (already loaded)
        // For non-helpdesk user: show only cases they created
        let myCases;
        if (isAdmin) {
            if (selectedColleague === 'all') {
                myCases = cases.filter(c => c);
            } else {
                myCases = cases.filter(c => c && c.worksheet === selectedColleague);
            }
        } else if (currentUser.isHelpdesk) {
            // Helpdesk user: show all cases from their worksheet (already filtered by worksheet on load)
            myCases = cases.filter(c => c);
        } else {
            // Non-helpdesk user: show only cases they created
            myCases = cases.filter(c => c && c.createdBy === currentUser.name);
        }
        const range = getDateRange();
        const searchEl = document.getElementById('searchInput');
        const search = searchEl ? (searchEl.value || '').toLowerCase().trim() : '';
        const todayStr = new Date().toDateString();

        // Helper: get latest case entry and check if escalated
        function getLatestInfo(rootJobId) {
            const related = myCases.filter(c => c.followUpJobId === rootJobId || c.jobId === rootJobId);
            const latest = related[related.length - 1];
            // Check if any related case has an escalate ticket (indicates escalation)
            const isEscalated = related.some(c => c.escalateTicket && c.escalateTicket.trim() !== '');
            return { latest, isEscalated };
        }

        // Filter root cases only
        let rootCases = myCases.filter(c => c.isNewJob === 'Y');

        // Apply filters to root cases
        rootCases = rootCases.filter(root => {
            try {
                // Get all related cases (original + follow-ups)
                const relatedCases = myCases.filter(c => c.followUpJobId === root.jobId || c.jobId === root.jobId);

                // Period filter: check if ANY case in the group falls within the date range
                const anyInPeriod = relatedCases.some(c => {
                    const cDate = new Date(c.createDate);
                    return cDate >= range.start && cDate <= range.end;
                });
                if (!anyInPeriod) return false;

                // Search in multiple fields: contact person, tel no, escalate ticket, agent code, category, subcategory, job id
                // Also search in related cases (follow-ups) since fields like escalateTicket may be added later
                if (search) {
                    const relatedForSearch = relatedCases;
                    const latestForSearch = relatedForSearch[relatedForSearch.length - 1] || root;

                    const searchFields = [
                        root.contactPerson,
                        root.telNo,
                        root.agentCode,
                        root.category,
                        root.subcategory,
                        root.jobId,
                        // Also check latest case for common fields (may be synced)
                        latestForSearch.contactPerson,
                        latestForSearch.telNo,
                        latestForSearch.agentCode,
                        latestForSearch.escalateTicket
                    ]
                    // Check all related cases for key fields
                    .concat(relatedForSearch.map(c => c.escalateTicket))
                    .concat(relatedForSearch.map(c => c.telNo))
                    .concat(relatedForSearch.map(c => c.contactPerson))
                    .concat(relatedForSearch.map(c => c.agentCode))
                    // Check all related job IDs
                    .concat(relatedForSearch.map(c => c.jobId));
                    // Convert all fields to strings for comparison (handles numbers like tel no)
                    const matchesSearch = searchFields.some(field => {
                        if (field === null || field === undefined) return false;
                        const fieldStr = String(field).toLowerCase();
                        return fieldStr.includes(search);
                    });
                    if (!matchesSearch) return false;
                }

                // Channel filter (multi-select)
                if (!selectedChannels.includes(root.channel)) return false;

                // For status filters, check the LATEST entry's actionResult
                const { latest, isEscalated } = getLatestInfo(root.jobId);
                if (!latest) return false;

                // For stat card filters
                if (activeFilters.stat) {
                    if (activeFilters.stat === 'total') { /* no additional filter */ }
                    else if (activeFilters.stat === 'pending' && !(latest.actionResult === 'Pending Follow-up' && !isEscalated)) return false;
                    else if (activeFilters.stat === 'escalated' && !(isEscalated && latest.actionResult !== 'Completed')) return false;
                    else if (activeFilters.stat === 'resolved' && latest.actionResult !== 'Completed') return false;
                }
                return true;
            } catch (filterErr) {
                console.log('Filter error for case:', JSON.stringify(filterErr.message));
                return false;
            }
        });

        // Apply sorting
        rootCases = sortCases(rootCases, myCases);

        // Store filtered cases for pagination
        filteredCases = rootCases;

        // Reset to page 1 when filters change
        currentPage = 1;

        // Render with pagination
        renderPaginatedCaseList();
        updateStats();
        hideTableLoading();
    } catch (e) {
        hideTableLoading();
        console.log('applyFiltersInternal error:', JSON.stringify(e.message));
    }
}

function sortCases(rootCases, myCases) {
    return rootCases.sort((a, b) => {
        let valA, valB;

        try {
            switch (sortColumn) {
                case 'date': {
                    // Sort by latest follow-up date (includes time component)
                    // Find latest related case date for each root case
                    const relatedA = cases.filter(f => f.followUpJobId === a.jobId || f.jobId === a.jobId);
                    const relatedB = cases.filter(f => f.followUpJobId === b.jobId || f.jobId === b.jobId);
                    let latestA = new Date(a.startDateTime || a.createDate || 0);
                    let latestB = new Date(b.startDateTime || b.createDate || 0);
                    relatedA.forEach(rc => {
                        const dt = new Date(rc.startDateTime || rc.createDate);
                        if (dt > latestA) latestA = dt;
                    });
                    relatedB.forEach(rc => {
                        const dt = new Date(rc.startDateTime || rc.createDate);
                        if (dt > latestB) latestB = dt;
                    });
                    valA = latestA;
                    valB = latestB;
                    break;
                }
                case 'channel':
                    valA = (a.channel || '').toLowerCase();
                    valB = (b.channel || '').toLowerCase();
                    break;
                case 'category':
                    valA = (a.category || '').toLowerCase();
                    valB = (b.category || '').toLowerCase();
                    break;
                case 'subcategory':
                    valA = (a.subcategory || '').toLowerCase();
                    valB = (b.subcategory || '').toLowerCase();
                    break;
                case 'contact':
                    valA = (a.contactPerson || '').toLowerCase();
                    valB = (b.contactPerson || '').toLowerCase();
                    break;
                case 'status':
                    // Get latest status for comparison
                    const relatedA = myCases.filter(c => c.followUpJobId === a.jobId || c.jobId === a.jobId);
                    const relatedB = myCases.filter(c => c.followUpJobId === b.jobId || c.jobId === b.jobId);
                    const latestA = relatedA[relatedA.length - 1];
                    const latestB = relatedB[relatedB.length - 1];
                    valA = (latestA && latestA.actionResult) ? latestA.actionResult : '';
                    valB = (latestB && latestB.actionResult) ? latestB.actionResult : '';
                    break;
                default:
                    valA = new Date(a.createDate || 0);
                    valB = new Date(b.createDate || 0);
            }
        } catch (e) {
            console.log('Sort error:', JSON.stringify(e.message));
            return 0;
        }

        if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
        if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
        return 0;
    });
}

function sortByColumn(column) {
    // Toggle direction if clicking same column, otherwise default to desc for date, asc for others
    if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        sortColumn = column;
        sortDirection = column === 'date' ? 'desc' : 'asc';
    }

    // Update UI
    document.querySelectorAll('.sortable-header').forEach(h => {
        h.classList.remove('active');
        const icon = h.querySelector('.sort-icon');
        if (icon) icon.className = 'fas fa-sort sort-icon';
    });

    const activeHeader = document.querySelector(`.sortable-header[data-column="${column}"]`);
    if (activeHeader) {
        activeHeader.classList.add('active');
        const icon = activeHeader.querySelector('.sort-icon');
        if (icon) icon.className = `fas fa-sort-${sortDirection === 'asc' ? 'up' : 'down'} sort-icon`;
    }

    applyFilters();
}

function renderPaginatedCaseList() {
    const totalItems = filteredCases.length;
    const totalPages = Math.ceil(totalItems / pageSize);

    // Ensure current page is valid
    if (currentPage > totalPages) currentPage = totalPages || 1;
    if (currentPage < 1) currentPage = 1;

    // Get items for current page
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = Math.min(startIndex + pageSize, totalItems);
    const pageItems = filteredCases.slice(startIndex, endIndex);

    // Render the list
    renderCaseList(pageItems, 'casesList');

    // Update pagination UI
    updatePaginationUI(totalItems, totalPages, startIndex, endIndex);
}

function updatePaginationUI(totalItems, totalPages, startIndex, endIndex) {
    // Update info text
    document.getElementById('showingRange').textContent = totalItems > 0 ? `${startIndex + 1}-${endIndex}` : '0-0';
    document.getElementById('totalCases').textContent = totalItems;

    // Update prev/next buttons
    document.getElementById('prevPageBtn').disabled = currentPage <= 1;
    document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;

    // Generate page numbers
    const pageNumbersContainer = document.getElementById('pageNumbers');
    let pageNumbersHtml = '';

    if (totalPages <= 7) {
        // Show all pages
        for (let i = 1; i <= totalPages; i++) {
            pageNumbersHtml += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}<\/button>`;
        }
    } else {
        // Show first, last, and pages around current
        const showPages = [];
        showPages.push(1);
        if (currentPage > 3) showPages.push('...');
        for (let i = Math.max(2, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++) {
            showPages.push(i);
        }
        if (currentPage < totalPages - 2) showPages.push('...');
        showPages.push(totalPages);

        showPages.forEach(p => {
            if (p === '...') {
                pageNumbersHtml += `<span style="padding: 0 8px; color: var(--text-muted);">...<\/span>`;
            } else {
                pageNumbersHtml += `<button class="pagination-btn ${p === currentPage ? 'active' : ''}" onclick="goToPage(${p})">${p}<\/button>`;
            }
        });
    }

    pageNumbersContainer.innerHTML = pageNumbersHtml;
}

function goToPage(page) {
    const totalPages = Math.ceil(filteredCases.length / pageSize);
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    renderPaginatedCaseList();
}

function changePageSize(size) {
    pageSize = parseInt(size);
    currentPage = 1;
    renderPaginatedCaseList();
}

function updateStats() {
    if (!currentUser) return;

    // For admin: filter by selected colleague or show all helpdesk cases
    // For helpdesk user: show all cases from their worksheet (already loaded)
    // For non-helpdesk user: show only cases they created
    let myCases;
    if (isAdmin) {
        if (selectedColleague === 'all') {
            myCases = cases.filter(c => c);
        } else {
            myCases = cases.filter(c => c && c.worksheet === selectedColleague);
        }
    } else if (currentUser.isHelpdesk) {
        // Helpdesk user: show all cases from their worksheet (already filtered by worksheet on load)
        myCases = cases.filter(c => c);
    } else {
        // Non-helpdesk user: show only cases they created
        myCases = cases.filter(c => c.createdBy === currentUser.name);
    }

    const rootCases = myCases.filter(c => c.isNewJob === 'Y');
    const range = getDateRange();

    // Filter by date range using SAME logic as applyFiltersInternal and Admin filterAndRenderAdminCases
    // Check if ANY case in the group (original + follow-ups) falls within the date range
    // Also filter by selected channels - SINGLE SOURCE OF TRUTH for date filtering
    const rootsInRange = rootCases.filter(root => {
        // Channel filter
        if (!selectedChannels.includes(root.channel)) return false;

        // Period filter: check if ANY case in the group falls within the date range
        const relatedCases = myCases.filter(c => c.followUpJobId === root.jobId || c.jobId === root.jobId);
        const anyInPeriod = relatedCases.some(c => {
            const cDate = new Date(c.createDate);
            return cDate >= range.start && cDate <= range.end;
        });
        return anyInPeriod;
    });

    let pendingCount = 0, escalatedCount = 0, resolvedCount = 0;
    rootsInRange.forEach(root => {
        // Find all related cases (original + follow-ups) and get the latest one
        const related = myCases.filter(c => c.followUpJobId === root.jobId || c.jobId === root.jobId);
        const latest = related[related.length - 1];
        // Check if any related case has an escalate ticket
        const isEscalated = related.some(c => c.escalateTicket && c.escalateTicket.trim() !== '');

        if (latest.actionResult === 'Completed') resolvedCount++;
        else if (isEscalated) escalatedCount++;
        else pendingCount++;
    });

    document.getElementById('statTotal').textContent = rootsInRange.length;
    document.getElementById('statPending').textContent = pendingCount;
    document.getElementById('statEscalated').textContent = escalatedCount;
    document.getElementById('statResolved').textContent = resolvedCount;
}

function renderCaseList(list, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    if (!list || list.length === 0) { container.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"><\/i><h3>No cases found<\/h3><p>Create a new case to get started<\/p><\/div>'; clearSelection(); return; }

    // Get current search term for highlighting
    const searchEl = document.getElementById('searchInput');
    const search = searchEl ? (searchEl.value || '').trim() : '';

    try {
        container.innerHTML = list.map(c => {
            if (!c) return '';
            const relatedCases = cases.filter(f => f.followUpJobId === c.jobId || f.jobId === c.jobId);
            const followUps = relatedCases.filter(f => f.jobId !== c.jobId).length;

            // Find the latest case by date for status and date range
            let latestCase = c;
            let latestDateTime = new Date(c.startDateTime || c.createDate);
            relatedCases.forEach(rc => {
                const rcDateTime = new Date(rc.startDateTime || rc.createDate);
                if (rcDateTime > latestDateTime) {
                    latestDateTime = rcDateTime;
                    latestCase = rc;
                }
            });

            const isEscalated = relatedCases.some(f => f.escalateTicket && f.escalateTicket.trim() !== '');
            const isPending = latestCase.actionResult !== 'Completed';
            const checkboxHtml = isPending
                ? `<div class="checkbox-cell" onclick="event.stopPropagation()"><input type="checkbox" class="case-checkbox" data-jobid="${c.jobId || ''}" onchange="updateSelection()"><\/div>`
                : `<div class="checkbox-cell"><\/div>`;
            // Determine status display
            let statusClass, statusText;
            if (latestCase.actionResult === 'Completed') {
                statusClass = 'completed';
                statusText = 'Completed';
            } else if (isEscalated) {
                statusClass = 'escalated';
                statusText = 'Escalated';
            } else {
                statusClass = 'pending';
                statusText = 'Pending';
            }
            const channelVal = c.channel || '';
            const categoryVal = c.category || '';
            const subcategoryVal = c.subcategory || '';
            const contactVal = c.contactPerson || '';

            // Format date: show range if has follow-ups on different dates
            const dateDisplay = followUps > 0 ? formatDateRange(c.createDate, latestCase.createDate) : formatDate(c.createDate);

            // Apply highlighting to displayed fields
            const categoryDisplay = highlightMatch(categoryVal, search);
            const subcategoryDisplay = highlightMatch(subcategoryVal, search);
            const contactDisplay = highlightMatch(contactVal, search);

            // Check for matches in hidden fields
            const hiddenMatches = checkHiddenFieldMatch(search, c, relatedCases);
            const matchIndicators = getMatchIndicatorsHtml(hiddenMatches, c, relatedCases);

            // Created By column for admin
            let createdByHtml = '';
            if (isAdmin) {
                const creator = helpdeskUsers.find(u => u.worksheet === c.worksheet);
                const creatorName = creator ? creator.name : (c.createdBy || c.worksheet || '-');
                const creatorInitials = creator ? creator.initials : (c.createdBy ? c.createdBy.substring(0, 2).toUpperCase() : 'NA');
                createdByHtml = `<div class="created-by-cell"><span class="creator-avatar">${creatorInitials}<\/span><span class="creator-name">${creatorName}<\/span><\/div>`;
            }

            return `<div class="case-row" onclick="openCase('${c.jobId || ''}')">${checkboxHtml}<div class="date-cell">${dateDisplay}<\/div>${createdByHtml}<div><span class="channel-badge ${channelVal.toLowerCase()}">${channelVal}<\/span><\/div><div class="cell-truncate" title="${categoryVal}">${categoryDisplay}<\/div><div class="cell-truncate" title="${subcategoryVal}">${subcategoryDisplay}<\/div><div class="cell-truncate">${contactDisplay}<\/div><div><span class="status-badge ${statusClass}">${statusText}<\/span><\/div><div class="follow-up-count">${followUps > 0 ? `<i class="fas fa-reply"><\/i> ${followUps}` : '-'}<\/div><div class="match-cell">${matchIndicators}<\/div><\/div>`;
        }).join('');
        clearSelection();
    } catch (e) {
        console.log('renderCaseList error:', JSON.stringify(e.message));
        container.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"><\/i><h3>Error loading cases<\/h3><p>Please try refreshing<\/p><\/div>';
    }
}

function setCurrentDateTime() {
    const now = new Date();
    // Set date (YYYY-MM-DD)
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    document.getElementById('callDate').value = `${year}-${month}-${day}`;
    // Set start time (HH:MM)
    const hours = String(now.getHours()).padStart(2, '0');
    const mins = String(now.getMinutes()).padStart(2, '0');
    document.getElementById('startTime').value = `${hours}:${mins}`;
    // Set default duration and calculate end time
    document.getElementById('duration').value = 1;
    onDurationChange();
}

// Custom Dropdown Functions (iOS Safari fix - bypasses native select issues)
function initCustomDropdown(fieldId, options, placeholder) {
    var dropdown = document.getElementById(fieldId + 'Dropdown');
    if (!dropdown) return; // Not a custom dropdown
    var optionsContainer = dropdown.querySelector('.custom-dropdown-options');
    var selectedDiv = dropdown.querySelector('.custom-dropdown-selected');
    var hiddenInput = document.getElementById(fieldId);
    var html = '';
    for (var i = 0; i < options.length; i++) {
        html += '<div class="custom-dropdown-option" data-value="' + options[i] + '" onclick="selectCustomDropdownOption(\'' + fieldId + '\', \'' + options[i].replace(/'/g, "\\'") + '\')">' + options[i] + '<\/div>';
    }
    optionsContainer.innerHTML = html;
    // Always reset to placeholder and clear hidden input when rebuilding options
    hiddenInput.value = '';
    selectedDiv.textContent = placeholder || 'Select...';
    selectedDiv.classList.add('placeholder');
}

function toggleCustomDropdown(fieldId) {
    var dropdown = document.getElementById(fieldId + 'Dropdown');
    var isOpen = dropdown.classList.contains('open');
    // Close all other dropdowns first
    document.querySelectorAll('.custom-dropdown.open').forEach(function(d) {
        d.classList.remove('open');
    });
    if (!isOpen) {
        dropdown.classList.add('open');
        // Auto-scroll to selected option
        var optionsContainer = dropdown.querySelector('.custom-dropdown-options');
        var selectedOption = optionsContainer.querySelector('.custom-dropdown-option.selected');
        if (selectedOption) {
            // Scroll the selected option into view (centered)
            setTimeout(function() {
                selectedOption.scrollIntoView({ block: 'nearest', behavior: 'auto' });
            }, 10);
        }
    }
}

function selectCustomDropdownOption(fieldId, value) {
    var dropdown = document.getElementById(fieldId + 'Dropdown');
    var selectedDiv = dropdown.querySelector('.custom-dropdown-selected');
    var hiddenInput = document.getElementById(fieldId);

    // Update hidden input and display
    hiddenInput.value = value;
    selectedDiv.textContent = value;
    selectedDiv.classList.remove('placeholder');

    // Update selected state in options
    dropdown.querySelectorAll('.custom-dropdown-option').forEach(function(opt) {
        opt.classList.toggle('selected', opt.dataset.value === value);
    });

    // Close dropdown
    dropdown.classList.remove('open');

    // Trigger change handlers
    if (fieldId === 'category') {
        updateSubcategories(true);
    } else if (fieldId === 'subcategory') {
        updateSubjects(true);
        checkOthersWarning();
    } else if (fieldId === 'subject') {
        checkOthersWarning();
    }
}

function setCustomDropdownValue(fieldId, value) {
    var dropdown = document.getElementById(fieldId + 'Dropdown');
    if (!dropdown) return; // Not a custom dropdown
    var selectedDiv = dropdown.querySelector('.custom-dropdown-selected');
    var hiddenInput = document.getElementById(fieldId);

    hiddenInput.value = value;
    if (value) {
        selectedDiv.textContent = value;
        selectedDiv.classList.remove('placeholder');
        // Update selected state
        dropdown.querySelectorAll('.custom-dropdown-option').forEach(function(opt) {
            opt.classList.toggle('selected', opt.dataset.value === value);
        });
    } else {
        selectedDiv.textContent = 'Select...';
        selectedDiv.classList.add('placeholder');
        dropdown.querySelectorAll('.custom-dropdown-option').forEach(function(opt) {
            opt.classList.remove('selected');
        });
    }
}

function getCustomDropdownValue(fieldId) {
    return document.getElementById(fieldId).value;
}

function handleDropdownKey(event, fieldId) {
    if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        toggleCustomDropdown(fieldId);
    } else if (event.key === 'Escape') {
        document.getElementById(fieldId + 'Dropdown').classList.remove('open');
    }
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.custom-dropdown')) {
        document.querySelectorAll('.custom-dropdown.open').forEach(function(d) {
            d.classList.remove('open');
        });
    }
});

// Initialize all dropdowns
function initAllDropdowns() {
    // All custom dropdowns
    initCustomDropdown('source', SOURCES, 'Select...');
    initCustomDropdown('caseType', CASE_TYPES, 'Select...');
    initCustomDropdown('category', CATEGORIES, 'Select...');
    // Subcategory and Subject are filtered based on Category/Subcategory selection
    updateSubcategories(false);
    initCustomDropdown('actionResult', ACTION_RESULTS, 'Select...');
}

// Update Subcategory options based on Category selection
function updateSubcategories(preserveValue) {
    var category = document.getElementById('category').value;
    var currentValue = document.getElementById('subcategory').value;
    var list;

    if (category === 'Infra / Device') {
        // Only show GIT options and Others for Infra / Device
        list = SUBCATEGORIES.filter(function(s) {
            return s.startsWith('GIT') || s === 'Others';
        });
    } else {
        // Show all options for other categories
        list = SUBCATEGORIES;
    }

    initCustomDropdown('subcategory', list, 'Select...');

    // Preserve previous selection if still available
    if (preserveValue && currentValue && list.includes(currentValue)) {
        setCustomDropdownValue('subcategory', currentValue);
    } else if (preserveValue && currentValue) {
        // Previous selection not available, reset to Select...
        setCustomDropdownValue('subcategory', '');
    }

    // Also update Subject based on new Subcategory
    updateSubjects(preserveValue);
}

function initSubcategories() {
    updateSubcategories(false);
}

function updateSubjects(preserveValue) {
    var sub = document.getElementById('subcategory').value;
    var currentValue = document.getElementById('subject').value;
    var list;

    // Determine which subject list to use based on subcategory
    if (sub.startsWith('GIT - Hardware') || sub.startsWith('GIT  Hardware')) {
        list = SUBJECTS.hardware;
    } else if (sub.startsWith('GIT - Printing') || sub.startsWith('GIT  Printing')) {
        list = SUBJECTS.printing;
    } else if (sub.startsWith('GIT - Google') || sub.startsWith('GIT  Google')) {
        list = SUBJECTS.google;
    } else if (sub.startsWith('GIT - Network') || sub.startsWith('GIT  Network')) {
        list = SUBJECTS.network;
    } else {
        // For Digital subcategories or empty/Others, show general options
        list = SUBJECTS.general;
    }

    initCustomDropdown('subject', list, 'Select...');

    // Preserve previous selection if still available
    if (preserveValue && currentValue && list.includes(currentValue)) {
        setCustomDropdownValue('subject', currentValue);
    } else if (preserveValue && currentValue) {
        // Previous selection not available, reset to Select...
        setCustomDropdownValue('subject', '');
    }
}

// Convert time string (HH:MM) to minutes from midnight
function timeToMins(timeStr) {
    if (!timeStr) return null;
    const [h, m] = timeStr.split(':').map(Number);
    return h * 60 + m;
}

// Convert minutes from midnight to time string (HH:MM)
function minsToTime(mins) {
    const h = Math.floor(mins / 60) % 24;
    const m = mins % 60;
    return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
}

// Show/hide duration warning for calls over 1 hour
function updateDurationWarning() {
    const dur = parseInt(document.getElementById('duration').value) || 0;
    const warning = document.getElementById('durationWarning');
    warning.style.display = dur > 60 ? 'flex' : 'none';
}

// Show/hide warning when "Others" is selected in Subcategory or Subject
function checkOthersWarning() {
    const subcategory = document.getElementById('subcategory').value;
    const subject = document.getElementById('subject').value;
    const subcategoryWarning = document.getElementById('subcategoryOthersWarning');
    const subjectWarning = document.getElementById('subjectOthersWarning');

    subcategoryWarning.style.display = subcategory === 'Others' ? 'flex' : 'none';
    subjectWarning.style.display = subject === 'Others' ? 'flex' : 'none';
}

// When start time changes: recalculate end time based on duration
function onStartTimeChange() {
    const startTime = document.getElementById('startTime').value;
    const dur = parseInt(document.getElementById('duration').value) || 1;
    if (startTime) {
        const startMins = timeToMins(startTime);
        let endMins = startMins + dur;
        // Cap at 23:59
        if (endMins > 23 * 60 + 59) endMins = 23 * 60 + 59;
        document.getElementById('endTime').value = minsToTime(endMins);
        // Recalculate duration if capped
        const actualDur = endMins - startMins;
        if (actualDur !== dur) {
            document.getElementById('duration').value = actualDur > 0 ? actualDur : 1;
        }
    }
    updateDurationWarning();
}

// When end time changes: calculate duration (two-way sync)
// Note: We don't reset the value here - validation happens on form submit
// This allows users to type freely without interruption
function onEndTimeChange() {
    const startTime = document.getElementById('startTime').value;
    const endTime = document.getElementById('endTime').value;
    if (startTime && endTime) {
        const startMins = timeToMins(startTime);
        const endMins = timeToMins(endTime);
        // If invalid (end before start), show empty to indicate incomplete input
        const diff = endMins - startMins;
        document.getElementById('duration').value = diff > 0 ? diff : '';
    }
    updateDurationWarning();
}

// When duration changes: calculate end time (two-way sync)
function onDurationChange() {
    const startTime = document.getElementById('startTime').value;
    const dur = parseInt(document.getElementById('duration').value) || 1;
    if (dur < 1) {
        document.getElementById('duration').value = 1;
    }
    if (startTime) {
        const startMins = timeToMins(startTime);
        let endMins = startMins + dur;
        // Validate: end time cannot exceed 23:59
        if (endMins > 23 * 60 + 59) {
            endMins = 23 * 60 + 59;
            const actualDur = endMins - startMins;
            document.getElementById('duration').value = actualDur > 0 ? actualDur : 1;
            showToast('End time capped at 23:59', 'info');
        }
        document.getElementById('endTime').value = minsToTime(endMins);
    }
    updateDurationWarning();
}

function toggleEscalateField() {
    // Escalate ticket field is always visible but optional
    // Having a ticket number value indicates the case is escalated
}

function applyTemplate(name) {
    const t = TEMPLATES[name]; if (!t) return;
    const isGitTemplate = ['device', 'google', 'print', 'network'].includes(name);
    setCustomDropdownValue('caseType', t.caseType);
    setCustomDropdownValue('category', t.category);
    updateSubcategories(false); // Filter subcategory based on category
    setCustomDropdownValue('subcategory', t.subcategory);
    updateSubjects(false); // Filter subject based on subcategory
    setCustomDropdownValue('subject', t.subject);
    // Only pre-fill symptom for non-GIT templates
    if (!isGitTemplate) {
        document.getElementById('symptom').value = t.symptom;
    }
    // Focus on symptom field
    document.getElementById('symptom').focus();
    showToast(`Template "${name}" applied!`, 'success');
}

function clearForm() {
    document.getElementById('caseForm').reset(); setCurrentDateTime();
    // Reset custom dropdowns
    setCustomDropdownValue('source', '');
    setCustomDropdownValue('caseType', '');
    setCustomDropdownValue('category', '');
    setCustomDropdownValue('subcategory', '');
    setCustomDropdownValue('subject', '');
    setCustomDropdownValue('actionResult', '');
    // Re-initialize all dropdowns
    initAllDropdowns();
    document.getElementById('followUpInfo').style.display = 'none';
    document.getElementById('clonedFromInfo').style.display = 'none';
    document.getElementById('templatesSection').style.display = 'flex'; document.getElementById('isNewJob').value = 'Y';
    document.getElementById('originalJobId').value = ''; document.getElementById('editingCaseId').value = '';
    document.getElementById('formTitle').textContent = 'Create New Case'; enableAllFormFields();
    document.getElementById('channel').value = '';
    document.querySelectorAll('.channel-option').forEach(o => o.classList.remove('selected'));
    isEditMode = false; editingJobId = null; originalFormData = null;
    document.getElementById('formBackBtn').style.display = 'none';
    document.getElementById('formIcon').className = 'fas fa-plus-circle';
    document.getElementById('formIcon').style.color = 'var(--accent-primary)';
    removeCommonFieldIndicators();
    // Hide Job ID header for new cases (will be generated server-side)
    document.getElementById('jobIdHeader').style.display = 'none';
    // Reset button to Clear for new case
    updateClearCancelButton(false);
    // Clear Others warnings
    clearOthersWarnings();
}

// Clear the Others warning messages
function clearOthersWarnings() {
    document.getElementById('subcategoryOthersWarning').style.display = 'none';
    document.getElementById('subjectOthersWarning').style.display = 'none';
}

function updateClearCancelButton(isEditing) {
    const icon = document.getElementById('clearCancelIcon');
    const text = document.getElementById('clearCancelText');
    if (isEditing) {
        icon.className = 'fas fa-arrow-left';
        text.textContent = 'Cancel';
    } else {
        icon.className = 'fas fa-times';
        text.textContent = 'Clear';
    }
}

function handleClearCancel() {
    const isFollowUp = document.getElementById('isNewJob').value === 'N' && !isEditMode;
    if (isEditMode || isFollowUp) {
        // Cancel - go back without saving
        goBackFromEdit();
    } else {
        // Clear form for new case
        confirmClearForm();
    }
}

function selectChannel(value) {
    document.getElementById('channel').value = value;
    document.querySelectorAll('.channel-option').forEach(o => o.classList.remove('selected'));
    document.querySelector(`.channel-option.${value.toLowerCase()}`).classList.add('selected');
}

// Format Contact Person: Proper case, remove double/trailing spaces
function formatContactPerson(input) {
    let val = input.value.trim().replace(/\s+/g, ' ');
    val = val.replace(/\b\w+/g, word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase());
    input.value = val;
}

// Format Tel No as user types: auto-insert hyphen
function formatTelNoInput(input) {
    let val = input.value.replace(/\D/g, '');
    if (val.length > 4) {
        val = val.slice(0, 4) + '-' + val.slice(4, 8);
    }
    input.value = val;
}

// Format Tel No on blur: validate 8 digits
function formatTelNo(input) {
    let val = input.value.replace(/\D/g, '');
    if (val.length === 8) {
        input.value = val.slice(0, 4) + '-' + val.slice(4, 8);
        input.setCustomValidity('');
    } else if (val.length > 0) {
        input.setCustomValidity('Please enter 8 digits');
        input.reportValidity();
    }
}

function resetNewCaseForm() {
    clearForm();
    // Capture original form data for change detection
    setTimeout(() => { originalFormData = getFormData(); }, 50);
}

function getFormData() {
    return {
        channel: document.getElementById('channel').value,
        source: document.getElementById('source').value,
        contactPerson: document.getElementById('contactPerson').value,
        telNo: document.getElementById('telNo').value,
        agentCode: document.getElementById('agentCode').value,
        location: document.getElementById('location').value,
        caseType: document.getElementById('caseType').value,
        category: document.getElementById('category').value,
        subcategory: document.getElementById('subcategory').value,
        subject: document.getElementById('subject').value,
        symptom: document.getElementById('symptom').value,
        actionDetail: document.getElementById('actionDetail').value,
        actionResult: document.getElementById('actionResult').value,
        escalateTicket: document.getElementById('escalateTicket').value,
        callDate: document.getElementById('callDate').value,
        startTime: document.getElementById('startTime').value,
        endTime: document.getElementById('endTime').value,
        duration: document.getElementById('duration').value
    };
}

function hasFormChanged() {
    if (!originalFormData) return false;
    const current = getFormData();
    return Object.keys(originalFormData).some(key => originalFormData[key] !== current[key]);
}

function goBackFromEdit() {
    const jobToHighlight = editingJobId;
    const caseToOpen = currentCaseId;
    if (hasFormChanged()) {
        showThreeOptionConfirm(
            'Unsaved Changes',
            'You have unsaved changes. What would you like to do?',
            () => { document.getElementById('caseForm').dispatchEvent(new Event('submit', { cancelable: true })); }, // Save
            () => { exitEditMode(); openCase(caseToOpen); if (jobToHighlight) setTimeout(() => selectTimelineItem(jobToHighlight), 50); } // Discard
        );
    } else {
        exitEditMode();
        openCase(caseToOpen);
        if (jobToHighlight) setTimeout(() => selectTimelineItem(jobToHighlight), 50);
    }
}

function exitEditMode() {
    isEditMode = false; editingJobId = null; originalFormData = null;
    removeCommonFieldIndicators();
}

function markCommonFields() {
    const commonFieldIds = ['source', 'contactPerson', 'telNo', 'agentCode', 'caseType', 'category', 'subcategory', 'subject', 'escalateTicket', 'actionResult'];
    commonFieldIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.closest('.form-group')?.classList.add('common-field');
    });
    // Channel selector is special
    document.querySelector('.channel-selector')?.closest('.form-group')?.classList.add('common-field');
}

function removeCommonFieldIndicators() {
    document.querySelectorAll('.form-group.common-field').forEach(el => el.classList.remove('common-field'));
}

function showThreeOptionConfirm(title, msg, onSave, onDiscard) {
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmMessage').textContent = msg;
    threeOptionSaveCallback = onSave;
    threeOptionDiscardCallback = onDiscard;
    const footer = document.getElementById('confirmFooter');
    footer.className = 'confirm-modal-footer three-buttons';
    footer.innerHTML = `
        <button class="btn btn-secondary" onclick="closeConfirm()"><i class="fas fa-times"><\/i> Cancel<\/button>
        <button class="btn btn-danger" onclick="executeDiscard()"><i class="fas fa-trash"><\/i> Discard<\/button>
        <button class="btn btn-primary" onclick="executeThreeOptionSave()"><i class="fas fa-save"><\/i> Save<\/button>
    `;
    document.getElementById('confirmOverlay').classList.add('active');
}

function executeThreeOptionSave() {
    const callback = threeOptionSaveCallback;
    closeConfirm();
    if (callback) callback();
}

function executeDiscard() {
    const callback = threeOptionDiscardCallback;
    closeConfirm();
    if (callback) callback();
}

function enableAllFormFields() { ['channel', 'source', 'contactPerson', 'telNo', 'agentCode', 'location', 'caseType', 'category', 'subcategory', 'subject'].forEach(id => { const el = document.getElementById(id); if (el) el.disabled = false; }); }

function disableFollowUpFields() { ['channel', 'source', 'contactPerson', 'telNo', 'agentCode', 'caseType', 'category', 'subcategory', 'subject'].forEach(id => { const el = document.getElementById(id); if (el) el.disabled = true; }); }

async function saveCase(event) {
    event.preventDefault();
    const form = document.getElementById('caseForm');

    // Check channel first (custom selector, appears near top of form)
    const channelVal = document.getElementById('channel').value;
    if (!channelVal) { showToast('Please select a Channel', 'error'); return; }

    // Validate custom dropdown fields (hidden inputs don't trigger HTML5 validation)
    const sourceVal = document.getElementById('source').value;
    if (!sourceVal) { showToast('Please select a Source', 'error'); return; }

    const caseTypeVal = document.getElementById('caseType').value;
    if (!caseTypeVal) { showToast('Please select a Case Type', 'error'); return; }

    const categoryVal = document.getElementById('category').value;
    if (!categoryVal) { showToast('Please select a Category', 'error'); return; }

    const subcategoryVal = document.getElementById('subcategory').value;
    if (!subcategoryVal) { showToast('Please select a Subcategory', 'error'); return; }

    const subjectVal = document.getElementById('subject').value;
    if (!subjectVal) { showToast('Please select a Subject', 'error'); return; }

    const actionResultVal = document.getElementById('actionResult').value;
    if (!actionResultVal) { showToast('Please select a Case Status', 'error'); return; }

    // Check HTML5 form validation for remaining fields
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    const isNewJob = document.getElementById('isNewJob').value, originalJobId = document.getElementById('originalJobId').value, editingId = document.getElementById('editingCaseId').value;
    // Build startDateTime and endDateTime from separate Date + Time fields
    const callDate = document.getElementById('callDate').value;
    const startTime = document.getElementById('startTime').value;
    const endTime = document.getElementById('endTime').value;
    const startDT = `${callDate}T${startTime}`;
    const endDT = `${callDate}T${endTime}`;
    // For editing, get the existing jobId; for new cases, leave it empty (server will generate)
    const existingJobId = editingId ? document.getElementById('jobIdHeader').textContent : null;

    // Validate end time is >= start time
    if (timeToMins(endTime) < timeToMins(startTime)) {
        showToast('End time cannot be before start time', 'error');
        document.getElementById('endTime').focus();
        return;
    }
    const dur = parseInt(document.getElementById('duration').value) || 1;
    const escalateVal = document.getElementById('escalateTicket').value.toUpperCase();

    // Build case data - jobId and followUpJobId will be set by server for new cases
    const caseData = {
        createDate: startDT.split('T')[0],
        startDateTime: startDT,
        endDateTime: endDT || startDT,
        durationMins: dur,
        createdBy: currentUser.name,
        userInitials: currentUser.initials,
        channel: channelVal,
        isNewJob,
        escalateTicket: escalateVal,
        source: document.getElementById('source').value,
        location: document.getElementById('location').value,
        contactPerson: document.getElementById('contactPerson').value,
        telNo: document.getElementById('telNo').value,
        agentCode: document.getElementById('agentCode').value.toUpperCase(),
        caseType: document.getElementById('caseType').value,
        category: document.getElementById('category').value,
        subcategory: document.getElementById('subcategory').value,
        subject: document.getElementById('subject').value,
        symptom: document.getElementById('symptom').value,
        actionDetail: document.getElementById('actionDetail').value,
        actionResult: normalizeActionResultForSave(document.getElementById('actionResult').value)
    };

    // For editing, include the existing jobId
    if (editingId) {
        caseData.jobId = existingJobId;
        caseData.followUpJobId = isNewJob === 'Y' ? existingJobId : originalJobId;
    } else {
        // For new cases, include originalJobId for follow-ups (server will generate jobId)
        if (isNewJob === 'N') {
            caseData.originalJobId = originalJobId;
        }
    }

    showLoadingOverlay('Saving case...');

    // Common fields that should sync across all related cases
    const commonFields = ['channel', 'source', 'contactPerson', 'telNo', 'agentCode', 'caseType', 'category', 'subcategory', 'subject', 'escalateTicket', 'actionResult'];

    try {
        let result;
        if (editingId) {
            // Update existing case
            result = await apiPost('updateCase', caseData, { worksheet: currentUser.worksheet });
        } else {
            // Add new case
            result = await apiPost('addCase', caseData, { worksheet: currentUser.worksheet });
        }

        if (!result.success) {
            hideLoadingOverlay();
            showToast(result.error || 'Failed to save case', 'error');
            return;
        }

        // Get the server-generated jobId for new cases
        const serverJobId = editingId ? existingJobId : result.jobId;

        // Sync common fields to all related cases (for follow-ups or when editing a case with follow-ups)
        // For new root cases, rootJobId equals serverJobId; for follow-ups, use originalJobId
        const rootJobId = (isNewJob === 'Y') ? serverJobId : originalJobId;
        const relatedCases = cases.filter(c => (c.followUpJobId === rootJobId || c.jobId === rootJobId) && c.jobId !== serverJobId);

        if (relatedCases.length > 0) {
            // Prepare common field values to sync
            const commonFieldValues = {};
            commonFields.forEach(field => {
                if (field === 'escalateTicket') {
                    commonFieldValues[field] = escalateVal;
                } else if (field === 'channel') {
                    commonFieldValues[field] = channelVal;
                } else if (field === 'agentCode') {
                    commonFieldValues[field] = document.getElementById('agentCode').value.toUpperCase();
                } else {
                    commonFieldValues[field] = caseData[field];
                }
            });

            // Update all related cases with the common field values (both API and memory)
            for (const relatedCase of relatedCases) {
                const updatedCase = Object.assign({}, relatedCase);
                commonFields.forEach(field => {
                    updatedCase[field] = commonFieldValues[field];
                });
                await apiPost('updateCase', updatedCase, { worksheet: currentUser.worksheet });
                // Update in memory
                updateCaseInMemory(relatedCase.jobId, commonFieldValues);
            }
        }

        // Update cases in memory (no API reload needed - faster and more reliable)
        if (editingId) {
            // Update existing case in memory
            updateCaseInMemory(serverJobId, caseData);
        } else {
            // Add new case to memory
            const newCaseForMemory = Object.assign({}, caseData, {
                jobId: serverJobId,
                followUpJobId: (isNewJob === 'Y') ? serverJobId : originalJobId
            });
            addCaseToMemory(newCaseForMemory);
        }

        dataChanged = true; // Mark data changed for dashboard refresh
        hideLoadingOverlay();

        if (editingId) {
            showToast(`Case ${serverJobId} updated!`, 'success');
            const savedCaseId = currentCaseId;
            const savedJobId = editingJobId;
            const wasEditMode = isEditMode;
            clearForm(); updateStats();
            if (wasEditMode) {
                openCase(savedCaseId);
                if (savedJobId) setTimeout(() => selectTimelineItem(savedJobId), 50);
            } else {
                showView('dashboard');
            }
        } else {
            showToast(`Case ${serverJobId} saved!`, 'success');
            clearForm(); updateStats(); showView('dashboard');
        }
    } catch (error) {
        hideLoadingOverlay();
        console.error('API error saving case:', error);
        showToast('Failed to connect to server', 'error');
    }
}

function openCase(jobId) {
    let target = cases.find(c => c.jobId === jobId); if (!target) return;
    const rootJobId = target.followUpJobId, rootCase = cases.find(c => c.jobId === rootJobId) || target;
    currentCaseId = rootJobId;
    const related = cases.filter(c => c.followUpJobId === rootJobId || c.jobId === rootJobId), latest = related[related.length - 1];

    // Check ownership for admin
    const isOwnCase = checkCaseOwnership(rootCase);
    const canEdit = isOwnCase;
    const isPending = latest.actionResult !== 'Completed';

    // Show/hide buttons based on ownership and status
    document.getElementById('closeBtn').style.display = (isPending && canEdit) ? 'inline-flex' : 'none';
    document.getElementById('followUpBtn').style.display = canEdit ? 'inline-flex' : 'none';
    document.getElementById('editBtn').style.display = canEdit ? 'inline-flex' : 'none';
    document.getElementById('deleteBtn').style.display = canEdit ? 'inline-flex' : 'none';
    // Clone button only visible for helpdesk users (who can create cases)
    document.getElementById('cloneBtn').style.display = currentUser.isHelpdesk ? 'inline-flex' : 'none';

    updateDetailHeader(rootCase, related);
    renderCaseDetails(rootCase); renderTimeline(rootJobId); showView('caseDetail');
}

// Check if current user owns the case
function checkCaseOwnership(caseObj) {
    if (!isAdmin) return true; // Regular users only see their own cases
    if (!currentUser.isHelpdesk) return false; // Admin without helpdesk flag can't edit any
    // Admin with helpdesk flag: can edit if it's their worksheet
    return caseObj.worksheet === currentUser.worksheet;
}

function renderCaseDetails(c) {
    const formattedTel = formatTelDisplay(c.telNo);
    const telLink = c.telNo ? `<a href="tel:${String(c.telNo).replace(/\D/g, '')}" class="tel-link">${formattedTel}<\/a>` : '-';
    const timeRange = formatTimeRange(c.startDateTime, c.endDateTime, c.durationMins);
    document.getElementById('caseDetails').innerHTML = `<div class="detail-row"><div class="detail-label">Time<\/div><div class="detail-value">${timeRange}<\/div><\/div><div class="detail-row"><div class="detail-label">Contact<\/div><div class="detail-value">${c.contactPerson} (${telLink})<\/div><\/div><div class="detail-row"><div class="detail-label">Agent Code<\/div><div class="detail-value">${c.agentCode || '-'}<\/div><\/div><div class="detail-row"><div class="detail-label">Source<\/div><div class="detail-value">${c.source}<\/div><\/div><div class="detail-row"><div class="detail-label">Category<\/div><div class="detail-value">${c.category}<\/div><\/div><div class="detail-row"><div class="detail-label">Subcategory<\/div><div class="detail-value">${c.subcategory}<\/div><\/div><div class="detail-row"><div class="detail-label">Subject<\/div><div class="detail-value">${c.subject}<\/div><\/div><div class="detail-row"><div class="detail-label">Symptom<\/div><div class="detail-value">${c.symptom}<\/div><\/div><div class="detail-row"><div class="detail-label">Action Taken<\/div><div class="detail-value">${c.actionDetail || '-'}<\/div><\/div>${c.escalateTicket ? `<div class="detail-row"><div class="detail-label">Ticket No.<\/div><div class="detail-value" style="color: var(--warning); font-weight: 600;">${c.escalateTicket}<\/div><\/div>` : ''}<div class="detail-row"><div class="detail-label">Created By<\/div><div class="detail-value">${c.createdBy}<\/div><\/div>`;
}

// Format time range with color-coded HTML
function formatTimeRange(start, end, duration) {
    if (!start) return '-';
    const startDate = new Date(start);
    const endDate = end ? new Date(end) : null;

    const day = startDate.getDate();
    const month = startDate.toLocaleDateString('en-GB', { month: 'short' });
    const year = startDate.getFullYear();
    const startTime = startDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });

    const dateStr = `<span class="time-date">${day} ${month} ${year}<\/span>`;

    if (!endDate) {
        const durationStr = duration ? ` <span class="time-duration">(${duration} min)<\/span>` : '';
        return `${dateStr} <span class="time-period">${startTime}<\/span>${durationStr}`;
    }

    const endTime = endDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
    const durationStr = duration ? ` <span class="time-duration">(${duration} min)<\/span>` : '';
    return `${dateStr} <span class="time-period">${startTime} - ${endTime}<\/span>${durationStr}`;
}

// Format tel for display: 9999-9999
function formatTelDisplay(tel) {
    if (!tel) return '-';
    const digits = String(tel).replace(/\D/g, '');
    if (digits.length === 8) {
        return digits.slice(0, 4) + '-' + digits.slice(4, 8);
    }
    return tel;
}

function renderTimeline(rootJobId) {
    const related = cases.filter(c => c.followUpJobId === rootJobId || c.jobId === rootJobId);
    const firstJobId = related[0]?.jobId || rootJobId;
    const timelineHtml = related.map((c, i) => {
        // Format actionResult for display
        const statusDisplay = c.actionResult === 'Completed' ? 'Completed' : (c.escalateTicket ? 'Escalated' : 'Pending');
        return `<div class="timeline-item ${i === 0 ? 'original selected' : ''}" data-jobid="${c.jobId}" onclick="selectTimelineItem('${c.jobId}')"><div class="timeline-dot"><\/div><div class="timeline-content"><div class="timeline-header"><span class="timeline-job-id">${c.jobId}<\/span><span class="timeline-date">${formatDateTime(c.startDateTime)}<\/span><\/div><div class="timeline-desc">${c.isNewJob === 'Y' ? 'Original' : 'Follow-up'} | ${statusDisplay} | ${c.durationMins} min<\/div><\/div><\/div>`;
    }).join('');
    document.getElementById('caseTimeline').innerHTML = timelineHtml;
    // Also populate mobile timeline
    const mobileTimeline = document.getElementById('mobileTimeline');
    if (mobileTimeline) mobileTimeline.innerHTML = timelineHtml;
    // Initialize mobile drawer on case open
    initMobileTimelineDrawer();
}

function selectTimelineItem(jobId) {
    // Update selection in both desktop and mobile timelines
    document.querySelectorAll('.timeline-item').forEach(el => el.classList.remove('selected'));
    document.querySelectorAll(`.timeline-item[data-jobid="${jobId}"]`).forEach(el => el.classList.add('selected'));
    const c = cases.find(x => x.jobId === jobId);
    if (c) {
        renderCaseDetails(c);
        updateDetailHeader(c);
        // Flash the case details panel to indicate refresh
        const detailsBody = document.getElementById('caseDetails');
        if (detailsBody) {
            detailsBody.classList.remove('flash');
            void detailsBody.offsetWidth; // Trigger reflow to restart animation
            detailsBody.classList.add('flash');
        }
    }
    // Auto-collapse mobile drawer after selection so user can see updated details
    if (window.innerWidth <= 1024) {
        setTimeout(() => {
            const drawer = document.getElementById('timelineDrawer');
            const tab = document.getElementById('timelineDrawerTab');
            const overlay = document.getElementById('timelineDrawerOverlay');
            if (drawer && !drawer.classList.contains('collapsed')) {
                drawer.classList.add('collapsed');
                tab.classList.add('visible');
                overlay.classList.remove('visible');
            }
        }, 300);
    }
}

function updateDetailHeader(c, relatedCases = null) {
    document.getElementById('detailJobId').textContent = c.jobId;
    document.getElementById('detailChannel').textContent = c.channel;
    document.getElementById('detailChannel').className = `channel-badge ${c.channel.toLowerCase()}`;

    // Determine status based on actionResult and escalation
    const related = relatedCases || cases.filter(x => x.followUpJobId === c.followUpJobId || x.jobId === c.followUpJobId);
    const isEscalated = related.some(x => x.escalateTicket && x.escalateTicket.trim() !== '');
    const latest = related[related.length - 1] || c;

    let statusClass, statusText;
    if (latest.actionResult === 'Completed') {
        statusClass = 'completed';
        statusText = 'Completed';
    } else if (isEscalated) {
        statusClass = 'escalated';
        statusText = 'Escalated';
    } else {
        statusClass = 'pending';
        statusText = 'Pending';
    }
    document.getElementById('detailStatus').textContent = statusText;
    document.getElementById('detailStatus').className = `status-badge ${statusClass}`;
    document.getElementById('detailSubject').textContent = c.subject;

    if (c.escalateTicket) {
        document.getElementById('detailTicket').style.display = 'inline-flex';
        document.getElementById('detailTicketNo').textContent = c.escalateTicket;
    } else {
        document.getElementById('detailTicket').style.display = 'none';
    }
}

function editCase() {
    // Find the currently selected timeline item, or use root case
    const selectedItem = document.querySelector('.timeline-item.selected');
    const selectedJobId = selectedItem ? selectedItem.dataset.jobid : currentCaseId;
    const c = cases.find(x => x.jobId === selectedJobId); if (!c) return;

    // Check ownership before allowing edit
    if (!checkCaseOwnership(c)) {
        showToast('You can only edit your own cases', 'error');
        return;
    }

    isEditMode = true; editingJobId = c.jobId;
    showView('newCase', true); // skipReset = true
    document.getElementById('formTitle').textContent = 'Edit Case';
    document.getElementById('formIcon').className = 'fas fa-edit';
    document.getElementById('formIcon').style.color = 'var(--warning)';
    document.getElementById('formBackBtn').style.display = 'flex';
    document.getElementById('editingCaseId').value = c.id;
    // Set hidden fields for sync logic
    document.getElementById('isNewJob').value = c.isNewJob;
    document.getElementById('originalJobId').value = c.followUpJobId;
    // Show Job ID header for editing existing case
    document.getElementById('jobIdHeader').textContent = c.jobId;
    document.getElementById('jobIdHeader').style.display = 'inline';
    // Parse startDateTime and endDateTime into separate Date + Time fields
    // startDateTime format: "YYYY-MM-DDTHH:MM" or "YYYY-MM-DD HH:MM"
    if (c.startDateTime) {
        const startParts = c.startDateTime.replace(' ', 'T').split('T');
        document.getElementById('callDate').value = startParts[0];
        document.getElementById('startTime').value = startParts[1] ? startParts[1].substring(0, 5) : '00:00';
    }
    if (c.endDateTime) {
        const endParts = c.endDateTime.replace(' ', 'T').split('T');
        document.getElementById('endTime').value = endParts[1] ? endParts[1].substring(0, 5) : '00:00';
    }
    document.getElementById('duration').value = c.durationMins || 1;
    updateDurationWarning();
    selectChannel(c.channel); setCustomDropdownValue('source', c.source);
    document.getElementById('contactPerson').value = c.contactPerson; document.getElementById('telNo').value = c.telNo;
    document.getElementById('agentCode').value = c.agentCode; document.getElementById('location').value = c.location;
    setCustomDropdownValue('caseType', c.caseType); setCustomDropdownValue('category', c.category);
    updateSubcategories(false); setCustomDropdownValue('subcategory', c.subcategory); updateSubjects(false);
    setCustomDropdownValue('subject', c.subject);
    setTimeout(() => {
        originalFormData = getFormData(); // Capture original form data after all fields are set
    }, 100);
    document.getElementById('symptom').value = c.symptom; document.getElementById('actionDetail').value = c.actionDetail;
    setCustomDropdownValue('actionResult', c.actionResult);
    document.getElementById('escalateTicket').value = c.escalateTicket; toggleEscalateField();
    document.getElementById('templatesSection').style.display = 'none';

    // Update button to Cancel for editing
    updateClearCancelButton(true);

    // Only show shared field styling if there are follow-ups (more than just the root case)
    const relatedCases = cases.filter(x => x.followUpJobId === c.followUpJobId || x.jobId === c.followUpJobId);
    if (relatedCases.length > 1) {
        markCommonFields();
    } else {
        removeCommonFieldIndicators();
    }
}

function closeCase() {
    showConfirm('Close Case', 'Mark this case and all follow-ups as Completed?', async () => {
        showLoadingOverlay('Closing case...');
        try {
            const casesToClose = cases.filter(c => c.followUpJobId === currentCaseId || c.jobId === currentCaseId);
            for (const c of casesToClose) {
                await apiPost('updateCase', Object.assign({}, c, { actionResult: 'Completed' }), { worksheet: currentUser.worksheet });
                // Update in memory (skip rebuild, we'll do it once at the end)
                updateCaseInMemory(c.jobId, { actionResult: 'Completed' }, true);
            }
            // Rebuild Team Breakdown once after all updates
            if (isAdmin) {
                buildAdminSummaryFromCases();
            }
            dataChanged = true; // Mark data changed for dashboard refresh
            hideLoadingOverlay();
            showToast('Case closed!', 'success'); openCase(currentCaseId); updateStats();
        } catch (error) {
            hideLoadingOverlay();
            console.error('API error closing case:', error);
            showToast('Failed to close case', 'error');
        }
    });
}

function createFollowUp() {
    const orig = cases.find(c => c.jobId === currentCaseId); if (!orig) return;

    // Check ownership before allowing follow-up
    if (!checkCaseOwnership(orig)) {
        showToast('You can only create follow-ups for your own cases', 'error');
        return;
    }

    showView('newCase'); document.getElementById('formTitle').textContent = 'Create Follow-up';
    document.getElementById('isNewJob').value = 'N'; document.getElementById('originalJobId').value = currentCaseId;
    document.getElementById('templatesSection').style.display = 'none'; document.getElementById('followUpInfo').style.display = 'flex';
    document.getElementById('followUpJobId').textContent = currentCaseId;
    selectChannel(orig.channel); setCustomDropdownValue('source', orig.source);
    document.getElementById('contactPerson').value = orig.contactPerson; document.getElementById('telNo').value = orig.telNo;
    document.getElementById('agentCode').value = orig.agentCode; setCustomDropdownValue('caseType', orig.caseType);
    setCustomDropdownValue('category', orig.category); updateSubcategories(false);
    setCustomDropdownValue('subcategory', orig.subcategory); updateSubjects(false);
    setCustomDropdownValue('subject', orig.subject);
    document.getElementById('escalateTicket').value = orig.escalateTicket; document.getElementById('symptom').value = orig.symptom || '';
    // Enable all fields - common fields can be edited and will sync to all related cases
    enableAllFormFields();
    setCurrentDateTime();
    // Hide Job ID header for new follow-up (will be generated server-side)
    document.getElementById('jobIdHeader').style.display = 'none';
    // Show shared field styling for follow-up cases
    markCommonFields();
    // Show back button and change Clear to Cancel for follow-up mode
    document.getElementById('formBackBtn').style.display = 'flex';
    updateClearCancelButton(true);
    // Capture form data after pre-fill so change detection works correctly
    setTimeout(() => { originalFormData = getFormData(); }, 100);
}

function confirmCloneCase() {
    // Find the currently selected timeline item, or use root case
    const selectedItem = document.querySelector('.timeline-item.selected');
    const selectedJobId = selectedItem ? selectedItem.dataset.jobid : currentCaseId;
    const c = cases.find(x => x.jobId === selectedJobId);
    if (!c) return;

    showConfirm(
        'Clone Case',
        `Create a new case cloned from ${c.jobId}? Start time will be set to now. Escalate Ticket and Case Status will be cleared.`,
        () => cloneCase(c)
    );
}

function confirmDeleteCase() {
    // Find the currently selected timeline item, or use root case
    const selectedItem = document.querySelector('.timeline-item.selected');
    const selectedJobId = selectedItem ? selectedItem.dataset.jobid : currentCaseId;
    const c = cases.find(x => x.jobId === selectedJobId);
    if (!c) return;

    // Check ownership before allowing delete
    if (!checkCaseOwnership(c)) {
        showToast('You can only delete your own cases', 'error');
        return;
    }

    // Check if this is an original case or a follow-up
    const isOriginal = c.isNewJob === 'Y';

    if (isOriginal) {
        // Deleting original case - will delete all follow-ups too
        const relatedCases = cases.filter(x => x.followUpJobId === c.jobId || x.jobId === c.jobId);
        const followUpCount = relatedCases.length - 1;

        let message = `<div style="text-align: center;">
            <div style="font-size: 3rem; color: var(--danger); margin-bottom: 16px;"><i class="fas fa-exclamation-triangle"><\/i><\/div>
            <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 12px;">Delete Case ${c.jobId}?<\/div>`;

        if (followUpCount > 0) {
            message += `<div style="background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                <strong style="color: var(--danger);">Warning:<\/strong> This will also delete <strong>${followUpCount} follow-up case${followUpCount > 1 ? 's' : ''}<\/strong>
            <\/div>`;
        }

        message += `<div style="color: var(--danger); font-weight: 600; font-size: 0.9rem;"><i class="fas fa-exclamation-circle"><\/i> This action CANNOT be undone!<\/div><\/div>`;

        showConfirm('Delete Case', message, () => deleteCase(c.jobId, true), 'Delete', 'btn-danger');
    } else {
        // Deleting a follow-up case only
        const message = `<div style="text-align: center;">
            <div style="font-size: 3rem; color: var(--danger); margin-bottom: 16px;"><i class="fas fa-exclamation-triangle"><\/i><\/div>
            <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 12px;">Delete Follow-up Case ${c.jobId}?<\/div>
            <div style="color: var(--danger); font-weight: 600; font-size: 0.9rem;"><i class="fas fa-exclamation-circle"><\/i> This action CANNOT be undone!<\/div>
        <\/div>`;

        showConfirm('Delete Follow-up', message, () => deleteCase(c.jobId, false), 'Delete', 'btn-danger');
    }
}

async function deleteCase(jobId, deleteAll) {
    showLoadingOverlay('Deleting...');
    try {
        const url = `${API_URL}?token=${encodeURIComponent(googleCredential)}&action=deleteCase&worksheet=${encodeURIComponent(currentUser.worksheet)}&jobId=${encodeURIComponent(jobId)}&deleteAll=${deleteAll}`;
        const response = await fetch(url);
        const result = await response.json();

        if (result.success) {
            showToast(result.message || 'Case deleted successfully', 'success');
            // Delete from memory (no API reload needed)
            deleteCaseFromMemory(jobId, deleteAll);
            dataChanged = true; // Mark data changed for dashboard refresh
            hideLoadingOverlay();
            showView('dashboard');
        } else {
            hideLoadingOverlay();
            showToast(result.error || 'Failed to delete case', 'error');
        }
    } catch (err) {
        hideLoadingOverlay();
        showToast('Error deleting case: ' + err.message, 'error');
    }
}

function cloneCase(orig) {
    if (!orig) return;

    showView('newCase');
    document.getElementById('formTitle').textContent = 'Clone Case';
    document.getElementById('formIcon').className = 'fas fa-clone';
    document.getElementById('formIcon').style.color = 'var(--purple)';

    // This is a NEW original case (not a follow-up)
    document.getElementById('isNewJob').value = 'Y';
    document.getElementById('originalJobId').value = '';
    document.getElementById('editingCaseId').value = '';

    // Hide templates, show cloned from info
    document.getElementById('templatesSection').style.display = 'none';
    document.getElementById('followUpInfo').style.display = 'none';
    document.getElementById('clonedFromInfo').style.display = 'flex';
    document.getElementById('clonedFromJobId').textContent = orig.jobId;

    // Copy fields (excluding: Start/End DateTime, Duration, Escalate Ticket, Case Status)
    selectChannel(orig.channel);
    setCustomDropdownValue('source', orig.source);
    document.getElementById('contactPerson').value = orig.contactPerson;
    document.getElementById('telNo').value = orig.telNo;
    document.getElementById('agentCode').value = orig.agentCode;
    document.getElementById('location').value = orig.location;
    setCustomDropdownValue('caseType', orig.caseType);
    setCustomDropdownValue('category', orig.category);
    updateSubcategories(false);
    setCustomDropdownValue('subcategory', orig.subcategory);
    updateSubjects(false);
    setCustomDropdownValue('subject', orig.subject);
    document.getElementById('symptom').value = orig.symptom || '';
    document.getElementById('actionDetail').value = orig.actionDetail || '';

    // Clear fields that should not be copied
    document.getElementById('escalateTicket').value = '';
    setCustomDropdownValue('actionResult', '');
    toggleEscalateField();

    // Set current datetime for start (also sets default duration and end time)
    setCurrentDateTime();

    // Enable all fields
    enableAllFormFields();

    // Hide Job ID header (will be generated server-side)
    document.getElementById('jobIdHeader').style.display = 'none';

    // Remove any common field indicators (not relevant for clone)
    removeCommonFieldIndicators();

    // Show back button and change Clear to Cancel
    document.getElementById('formBackBtn').style.display = 'flex';
    updateClearCancelButton(true);

    // Capture form data after pre-fill so change detection works correctly
    setTimeout(() => { originalFormData = getFormData(); }, 100);
}

function formatDate(str) { return new Date(str).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }); }

// Format date range for cases with follow-ups
// Desktop: "21-26 Jan" or "21 Jan-03 Feb"
// Mobile: "> 26 Jan" (shows end date with arrow)
function formatDateRange(startDateStr, endDateStr) {
    if (!startDateStr) return '-';
    const startDate = new Date(startDateStr);
    const endDate = endDateStr ? new Date(endDateStr) : startDate;

    // If same date, just show one date
    if (startDate.toDateString() === endDate.toDateString()) {
        const dateStr = formatDate(startDateStr);
        return `<span class="date-single">${dateStr}<\/span>`;
    }

    // Different dates - show range
    const startDay = startDate.getDate();
    const endDay = endDate.getDate();
    const startMonth = startDate.toLocaleDateString('en-GB', { month: 'short' });
    const endMonth = endDate.toLocaleDateString('en-GB', { month: 'short' });
    const endDateFormatted = `${endDay} ${endMonth}`;

    let desktopRange;
    if (startMonth === endMonth) {
        // Same month: "21-26 Jan"
        desktopRange = `${startDay}-${endDay} ${startMonth}`;
    } else {
        // Cross month: "21 Jan-03 Feb"
        desktopRange = `${startDay} ${startMonth}-${endDay.toString().padStart(2, '0')} ${endMonth}`;
    }

    // Desktop shows range, mobile shows arrow + end date
    return `<span class="date-range-desktop">${desktopRange}<\/span><span class="date-range-mobile">&gt; ${endDateFormatted}<\/span>`;
}

// Get the latest date from related cases for sorting and display
function getLatestCaseDate(rootCase, allCases) {
    const relatedCases = allCases.filter(f => f.followUpJobId === rootCase.jobId || f.jobId === rootCase.jobId);
    if (relatedCases.length === 0) return rootCase.createDate;

    // Find the latest date among all related cases
    let latestDate = rootCase.createDate;
    let latestDateTime = new Date(rootCase.startDateTime || rootCase.createDate);

    relatedCases.forEach(c => {
        const cDateTime = new Date(c.startDateTime || c.createDate);
        if (cDateTime > latestDateTime) {
            latestDateTime = cDateTime;
            latestDate = c.createDate;
        }
    });

    return latestDate;
}
function formatDateTime(str) {
    if (!str) return '-';
    const date = new Date(str);
    const day = date.getDate();
    const month = date.toLocaleDateString('en-GB', { month: 'short' });
    const year = date.getFullYear();
    const hours = date.getHours();
    const mins = String(date.getMinutes()).padStart(2, '0');
    const ampm = hours >= 12 ? 'PM' : 'AM';
    const hour12 = hours % 12 || 12;
    return `${day} ${month} ${year}, ${String(hour12).padStart(2, '0')}:${mins} ${ampm}`;
}

function showToast(msg, type = 'success', duration = 3000) { const toast = document.getElementById('toast'); document.getElementById('toastMessage').textContent = msg; toast.className = `toast ${type}`; toast.querySelector('i').className = type === 'success' ? 'fas fa-check-circle' : (type === 'warning' ? 'fas fa-exclamation-triangle' : 'fas fa-times-circle'); toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), duration); }

function showConfirm(title, msg, onConfirm, confirmBtnText = 'Confirm', confirmBtnClass = 'btn-danger') {
    document.getElementById('confirmTitle').textContent = title;
    // Support both text and HTML messages
    const msgEl = document.getElementById('confirmMessage');
    if (msg.includes('<')) {
        msgEl.innerHTML = msg;
    } else {
        msgEl.textContent = msg;
    }
    confirmCallback = onConfirm;
    // Update confirm button text and style
    const footer = document.getElementById('confirmFooter');
    footer.innerHTML = `<button class="btn btn-secondary" onclick="closeConfirm()">Cancel<\/button><button class="btn ${confirmBtnClass}" onclick="executeConfirm()">${confirmBtnText}<\/button>`;
    document.getElementById('confirmOverlay').classList.add('active');
}
function closeConfirm() {
    document.getElementById('confirmOverlay').classList.remove('active');
    confirmCallback = null;
    threeOptionSaveCallback = null;
    threeOptionDiscardCallback = null;
    // Reset footer to default state
    const footer = document.getElementById('confirmFooter');
    footer.className = 'confirm-modal-footer';
    footer.innerHTML = '<button class="btn btn-secondary" onclick="closeConfirm()">Cancel<\/button><button class="btn btn-danger" onclick="executeConfirm()">Confirm<\/button>';
}
function executeConfirm() { if (confirmCallback) confirmCallback(); closeConfirm(); }
function confirmClearForm() { showConfirm('Clear Form', 'Clear all fields?', () => { clearForm(); showToast('Form cleared', 'success'); }); }

// Bulk selection functions
function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('#casesList .case-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
    updateSelection();
}

function updateSelection() {
    const checkboxes = document.querySelectorAll('#casesList .case-checkbox:checked');
    const count = checkboxes.length;
    document.getElementById('selectedCount').textContent = count;
    document.getElementById('bulkActionBar').classList.toggle('show', count > 0);

    // Update select all checkbox state
    const allCheckboxes = document.querySelectorAll('#casesList .case-checkbox');
    const selectAllCheckbox = document.getElementById('selectAllCases');
    if (allCheckboxes.length > 0) {
        selectAllCheckbox.checked = checkboxes.length === allCheckboxes.length;
        selectAllCheckbox.indeterminate = checkboxes.length > 0 && checkboxes.length < allCheckboxes.length;
    }
}

function clearSelection() {
    document.querySelectorAll('#casesList .case-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('selectAllCases').checked = false;
    document.getElementById('selectAllCases').indeterminate = false;
    document.getElementById('bulkActionBar').classList.remove('show');
    document.getElementById('selectedCount').textContent = '0';
}

function bulkCloseCases() {
    const selectedJobIds = Array.from(document.querySelectorAll('#casesList .case-checkbox:checked'))
        .map(cb => cb.dataset.jobid);

    if (selectedJobIds.length === 0) return;

    showConfirm(
        'Close Selected Cases',
        `Are you sure you want to close ${selectedJobIds.length} case(s)? This will mark them and all follow-ups as Completed.`,
        async () => {
            showLoadingOverlay('Closing cases...');
            try {
                // Update each case via API and memory
                for (const jobId of selectedJobIds) {
                    const casesToClose = cases.filter(c => c.followUpJobId === jobId || c.jobId === jobId);
                    for (const c of casesToClose) {
                        await apiPost('updateCase', Object.assign({}, c, { actionResult: 'Completed' }), { worksheet: currentUser.worksheet });
                        // Update in memory (skip rebuild, we'll do it once at the end)
                        updateCaseInMemory(c.jobId, { actionResult: 'Completed' }, true);
                    }
                }
                // Rebuild Team Breakdown once after all updates
                if (isAdmin) {
                    buildAdminSummaryFromCases();
                }
                dataChanged = true; // Mark data changed for dashboard refresh
                hideLoadingOverlay();
                showToast(`${selectedJobIds.length} case(s) closed successfully!`, 'success');
                clearSelection();
                applyFilters();
                updateStats();
            } catch (error) {
                hideLoadingOverlay();
                console.error('API error closing cases:', error);
                showToast('Failed to close cases', 'error');
            }
        }
    );
}

// Autocomplete functions
let activeAutocompleteIndex = -1;

function getAutocompleteSuggestions(field, query) {
    if (!query || query.length < 2) return [];
    const lowerQuery = query.toLowerCase();

    // Get unique values from the specified field
    const values = cases
        .map(c => c[field])
        .filter(v => v && v.trim() !== '')
        .filter(v => v.toLowerCase().includes(lowerQuery))
        .filter((v, i, arr) => arr.indexOf(v) === i) // unique
        .slice(0, 8); // limit to 8 suggestions

    return values;
}

function showAutocomplete(field, query) {
    const listEl = document.getElementById(`${field}-autocomplete`);
    const suggestions = getAutocompleteSuggestions(field, query);
    activeAutocompleteIndex = -1;

    if (suggestions.length === 0) {
        listEl.classList.remove('show');
        listEl.innerHTML = '';
        return;
    }

    const lowerQuery = query.toLowerCase();
    listEl.innerHTML = suggestions.map((s, i) => {
        // Highlight matching text
        const idx = s.toLowerCase().indexOf(lowerQuery);
        let highlighted = s;
        if (idx >= 0) {
            highlighted = s.substring(0, idx) +
                '<mark>' + s.substring(idx, idx + query.length) + '<\/mark>' +
                s.substring(idx + query.length);
        }
        return `<div class="autocomplete-item" data-index="${i}" onclick="selectAutocomplete('${field}', ${i})" onmouseenter="setActiveAutocomplete(${i})">${highlighted}<\/div>`;
    }).join('');

    listEl.classList.add('show');
}

function hideAutocomplete(field) {
    const listEl = document.getElementById(`${field}-autocomplete`);
    listEl.classList.remove('show');
    activeAutocompleteIndex = -1;
}

function selectAutocomplete(field, index) {
    const listEl = document.getElementById(`${field}-autocomplete`);
    const items = listEl.querySelectorAll('.autocomplete-item');
    if (index >= 0 && index < items.length) {
        const text = items[index].textContent;
        document.getElementById(field).value = text;
        hideAutocomplete(field);
    }
}

function setActiveAutocomplete(index) {
    activeAutocompleteIndex = index;
    document.querySelectorAll('.autocomplete-item').forEach((item, i) => {
        item.classList.toggle('active', i === index);
    });
}

function handleAutocompleteKey(event, field) {
    const listEl = document.getElementById(`${field}-autocomplete`);
    const items = listEl.querySelectorAll('.autocomplete-item');

    if (!listEl.classList.contains('show') || items.length === 0) return;

    switch(event.key) {
        case 'ArrowDown':
            event.preventDefault();
            activeAutocompleteIndex = Math.min(activeAutocompleteIndex + 1, items.length - 1);
            setActiveAutocomplete(activeAutocompleteIndex);
            break;
        case 'ArrowUp':
            event.preventDefault();
            activeAutocompleteIndex = Math.max(activeAutocompleteIndex - 1, 0);
            setActiveAutocomplete(activeAutocompleteIndex);
            break;
        case 'Enter':
            if (activeAutocompleteIndex >= 0) {
                event.preventDefault();
                selectAutocomplete(field, activeAutocompleteIndex);
            }
            break;
        case 'Escape':
            hideAutocomplete(field);
            break;
    }
}

// Hide autocomplete when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.autocomplete-wrapper')) {
        hideAutocomplete('symptom');
        hideAutocomplete('actionDetail');
    }
});

// Admin functions
function showAdminTab(tabName) {
    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.remove('active'));

    if (tabName === 'users') {
        document.querySelector('.admin-tab:nth-child(1)').classList.add('active');
        document.getElementById('adminUsersTab').classList.add('active');
        renderAdminUserList();
    } else if (tabName === 'helpdeskCases') {
        document.querySelector('.admin-tab:nth-child(2)').classList.add('active');
        document.getElementById('adminHelpdeskTab').classList.add('active');
        populateColleagueFilter();
        // Filter and render the cases list
        filterAndRenderAdminCases();
        // Build summary from already loaded adminCases (no API call needed)
        buildAdminSummaryFromCases();
        renderUserSummary();
    } else if (tabName === 'reports') {
        document.querySelector('.admin-tab:nth-child(3)').classList.add('active');
        document.getElementById('adminReportsTab').classList.add('active');
    }
}

function renderAdminUserList() {
    var container = document.getElementById('adminUserList');
    container.innerHTML = USERS.map(function(u) {
        return '<div class="admin-user-row">' +
            '<div class="user-name">' + u.name + '<\/div>' +
            '<div class="user-email">' + u.email + '<\/div>' +
            '<div><span class="role-badge ' + u.role + '">' + (u.role === 'admin' ? '<i class="fas fa-shield-alt"><\/i>' : '<i class="fas fa-user"><\/i>') + ' ' + u.role + '<\/span><\/div>' +
            '<div>' + (u.worksheet || '-') + '<\/div>' +
            '<div><span class="status-dot ' + (u.isActive ? 'active' : 'inactive') + '"><\/span>' + (u.isActive ? 'Active' : 'Inactive') + '<\/div>' +
            '<div><span class="status-dot ' + (u.isHelpdesk ? 'active' : 'inactive') + '"><\/span>' + (u.isHelpdesk ? 'Yes' : 'No') + '<\/div>' +
            '<div class="admin-actions-cell">' +
                '<button class="btn btn-secondary" onclick="editUser(\'' + u.email + '\')" title="Edit"><i class="fas fa-edit"><\/i><\/button>' +
                '<button class="btn ' + (u.isActive ? 'btn-danger' : 'btn-success') + '" onclick="toggleUserStatus(\'' + u.email + '\')" title="' + (u.isActive ? 'Deactivate' : 'Activate') + '"><i class="fas fa-' + (u.isActive ? 'ban' : 'check') + '"><\/i><\/button>' +
            '<\/div>' +
        '<\/div>';
    }).join('');
}

// Admin Helpdesk Cases functions
let adminCurrentPage = 1;
let adminPageSize = 20;
let adminFilteredCases = [];

function populateColleagueFilter() {
    const select = document.getElementById('colleagueFilter');
    if (!select) return;

    // Keep "All Helpdesk" option, add individual users sorted by name
    // Include inactive users with visual indicator for historical data access
    select.innerHTML = '<option value="all">All Helpdesk<\/option>';
    const sortedUsers = helpdeskUsers.slice().sort((a, b) => a.name.localeCompare(b.name));
    sortedUsers.forEach(u => {
        const option = document.createElement('option');
        option.value = u.worksheet;
        // Show "(inactive)" suffix for users who are no longer active
        option.textContent = u.isActive ? u.name : u.name + ' (inactive)';
        select.appendChild(option);
    });
    select.value = selectedColleague;
}

function handleColleagueChange() {
    selectedColleague = document.getElementById('colleagueFilter').value;
    // Re-filter and re-render if we have cases loaded
    if (adminCases.length > 0) {
        filterAndRenderAdminCases();
    }
}

function buildAdminSummaryFromCases() {
    // Build summary from already loaded adminCases data - no API calls needed
    // Uses same logic as Dashboard updateStats() for consistent counts

    // Get ALL helpdesk users from USERS array (including inactive for historical data)
    const allHelpdeskUsers = USERS.filter(u => u.isHelpdesk);

    if (allHelpdeskUsers.length === 0) {
        return;
    }

    // Update helpdeskUsers for reference (include isActive flag)
    helpdeskUsers = allHelpdeskUsers.map(u => ({
        name: u.name,
        initials: u.initials,
        worksheet: u.worksheet,
        isActive: u.isActive
    }));

    // Get the selected date range for filtering - use same function as filterAndRenderAdminCases
    // Single source of truth for admin date filtering
    const range = getAdminFilterDateRange();
    const filterStartDate = range.start;
    const filterEndDate = new Date(range.end);
    filterEndDate.setHours(23, 59, 59, 999);

    // Group ALL adminCases by userName (need all for finding follow-ups)
    const allCasesByUser = {};
    helpdeskUsers.forEach(u => {
        allCasesByUser[u.name] = [];
    });

    adminCases.forEach(c => {
        if (allCasesByUser[c.userName] !== undefined) {
            allCasesByUser[c.userName].push(c);
        }
    });

    // Build summary for each user using same logic as Dashboard updateStats
    adminSummary = {};
    helpdeskUsers.forEach(user => {
        const allUserCases = allCasesByUser[user.name] || [];

        // Get root cases only, then filter by channel and date range
        // Use SAME logic as Dashboard updateStats and Admin filterAndRenderAdminCases:
        // - Filter by valid channels (Agency, Broker, Banca)
        // - Check if ANY case in the group (original + follow-ups) falls within the date range
        // SINGLE SOURCE OF TRUTH for filtering
        const rootCases = allUserCases.filter(c => c.isNewJob === 'Y');
        const rootsInRange = rootCases.filter(root => {
            // Channel filter - same as Dashboard and filterAndRenderAdminCases
            // Only include cases with valid channels (Agency, Broker, Banca)
            if (!VALID_CHANNELS.includes(root.channel)) return false;

            // Get all related cases (original + follow-ups)
            const relatedCases = allUserCases.filter(c => c.followUpJobId === root.jobId || c.jobId === root.jobId);
            // Period filter: check if ANY case in the group falls within the date range
            const anyInPeriod = relatedCases.some(c => {
                if (!c.createDate) return false;
                const cDate = new Date(c.createDate);
                return cDate >= filterStartDate && cDate <= filterEndDate;
            });
            return anyInPeriod;
        });

        // Build summary with same logic as Dashboard
        const s = {
            total: rootsInRange.length,
            agency: 0,
            broker: 0,
            banca: 0,
            pending: 0,
            escalated: 0,
            completed: 0,
            totalDuration: 0
        };

        rootsInRange.forEach(root => {
            const channel = (root.channel || '').toLowerCase();
            if (channel === 'agency') s.agency++;
            else if (channel === 'broker') s.broker++;
            else if (channel === 'banca') s.banca++;

            // Find all related cases (original + follow-ups) from ALL user cases (not just in range)
            const related = allUserCases.filter(c => c.followUpJobId === root.jobId || c.jobId === root.jobId);
            const latest = related[related.length - 1];
            // Check if any related case has an escalate ticket
            const isEscalated = related.some(c => c.escalateTicket && c.escalateTicket.trim() !== '');

            if (latest && latest.actionResult === 'Completed') s.completed++;
            else if (isEscalated) s.escalated++;
            else s.pending++;

            s.totalDuration += parseInt(root.durationMins) || 0;
        });

        adminSummary[user.name] = s;
    });

    renderUserSummary();
}

function getAdminDateRange() {
    const filter = document.getElementById('adminPeriodFilter').value;
    const now = new Date();
    let startDate, endDate;

    // Use custom date range if set (from Period Modal or legacy pickers)
    // 'custom' is set by Period Modal, 'pickYear'/'pickMonth'/'pickDate' are legacy values
    if (adminCustomDateRange && (filter === 'custom' || filter === 'pickYear' || filter === 'pickMonth' || filter === 'pickDate')) {
        return {
            startDate: formatLocalDate(adminCustomDateRange.start),
            endDate: formatLocalDate(adminCustomDateRange.end)
        };
    }

    switch (filter) {
        case 'today':
            startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
            break;
        case '7days':
            startDate = new Date(now);
            startDate.setDate(startDate.getDate() - 7);
            endDate = new Date(now);
            break;
        case '30days':
            startDate = new Date(now);
            startDate.setDate(startDate.getDate() - 30);
            endDate = new Date(now);
            break;
        case '60days':
            startDate = new Date(now);
            startDate.setDate(startDate.getDate() - 60);
            endDate = new Date(now);
            break;
        case '90days':
            startDate = new Date(now);
            startDate.setDate(startDate.getDate() - 90);
            endDate = new Date(now);
            break;
        case 'thisMonth':
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            break;
        case 'thisYear':
            startDate = new Date(now.getFullYear(), 0, 1);
            endDate = new Date(now.getFullYear(), 11, 31);
            break;
        default:
            startDate = new Date(now);
            startDate.setDate(startDate.getDate() - 7);
            endDate = new Date(now);
    }

    // Use shared formatLocalDate helper (single source of truth for date formatting)
    return {
        startDate: formatLocalDate(startDate),
        endDate: formatLocalDate(endDate)
    };
}

let adminSummary = {}; // Stores per-user summary from API

// Cache management for admin cases
let adminCacheTimestamp = null;
let adminCachePeriod = null;
const ADMIN_CACHE_DURATION_MS = 5 * 60 * 1000; // 5 minutes cache validity

/**
 * Check if admin cache is valid for the current requested date range
 * Instead of checking period filter string, checks if requested range is within cached range
 */
function isAdminCacheValid() {
    if (!adminCacheTimestamp || !adminCachedStartDate || !adminCachedEndDate) return false;

    // Check cache age
    const elapsed = Date.now() - adminCacheTimestamp;
    if (elapsed >= ADMIN_CACHE_DURATION_MS) return false;

    return true; // Cache is fresh, date range check done separately
}

/**
 * Check if the requested date range is covered by the cached data
 * Returns true if no new data needs to be fetched
 */
function isDateRangeCovered(requestedStart, requestedEnd) {
    if (!adminCachedStartDate || !adminCachedEndDate) {
        console.log('isDateRangeCovered: Cache not initialized', { adminCachedStartDate, adminCachedEndDate });
        return false;
    }

    // Normalize to date strings for comparison
    const reqStartStr = typeof requestedStart === 'string' ? requestedStart.slice(0, 10) : formatLocalDate(requestedStart);
    const reqEndStr = typeof requestedEnd === 'string' ? requestedEnd.slice(0, 10) : formatLocalDate(requestedEnd);
    const cachedStartStr = typeof adminCachedStartDate === 'string' ? adminCachedStartDate.slice(0, 10) : formatLocalDate(adminCachedStartDate);
    const cachedEndStr = typeof adminCachedEndDate === 'string' ? adminCachedEndDate.slice(0, 10) : formatLocalDate(adminCachedEndDate);

    // Check if requested range is within cached range
    const startCovered = reqStartStr >= cachedStartStr;
    const endCovered = reqEndStr <= cachedEndStr;
    const result = startCovered && endCovered;

    console.log('isDateRangeCovered:', { reqStartStr, reqEndStr, cachedStartStr, cachedEndStr, startCovered, endCovered, result, casesCount: cases.length });

    return startCovered && endCovered;
}

function getAdminCacheAge() {
    if (!adminCacheTimestamp) return null;
    const elapsed = Date.now() - adminCacheTimestamp;
    const mins = Math.floor(elapsed / 60000);
    const secs = Math.floor((elapsed % 60000) / 1000);
    return mins > 0 ? `${mins}m ${secs}s ago` : `${secs}s ago`;
}

async function loadAdminCases(forceRefresh = false) {
    var dateRange = getAdminDateRange();

    // Check if requested date range is already covered by cached data
    if (!forceRefresh && adminCases.length > 0 && isDateRangeCovered(dateRange.startDate, dateRange.endDate)) {
        // Use cached data - the requested range is within what we already have
        console.log('Using cached data - date range is covered');
        filterAndRenderAdminCases();
        buildAdminSummaryFromCases();
        renderUserSummary();
        updateAdminCacheStatus();
        updateAdminDataLoadedRange();
        showToast('Using cached data (' + getAdminCacheAge() + ')', 'info');
        return;
    }

    // Check if we only need delta load (extend cache backwards)
    if (!forceRefresh && adminCases.length > 0 && adminCachedStartDate) {
        const reqStartStr = typeof dateRange.startDate === 'string' ? dateRange.startDate.slice(0, 10) : formatLocalDate(new Date(dateRange.startDate));
        const cachedStartStr = typeof adminCachedStartDate === 'string' ? adminCachedStartDate.slice(0, 10) : formatLocalDate(adminCachedStartDate);

        if (reqStartStr < cachedStartStr) {
            // Need to load delta data for earlier period
            console.log('Loading delta data for admin - extending cache backwards');
            await loadDeltaData('custom', true); // true = admin context, uses adminCustomDateRange
            filterAndRenderAdminCases();
            buildAdminSummaryFromCases();
            renderUserSummary();
            updateAdminCacheStatus();
            updateAdminDataLoadedRange();
            return;
        }
    }

    try {
        var worksheetsToLoad = getWorksheetsToLoad();

        // Use unified loadCases function - same logic as Dashboard
        var loadResult = await loadCases({
            startDate: dateRange.startDate,
            endDate: dateRange.endDate,
            worksheets: worksheetsToLoad,
            showProgress: true,
            progressPrefix: 'Loading helpdesk cases...'
        });

        adminCases = loadResult.cases;
        cases = adminCases; // Keep cases in sync for Dashboard

        // Update cache metadata using ACTUAL dates from existing spreadsheets
        adminCacheTimestamp = Date.now();
        adminCachePeriod = document.getElementById('adminPeriodFilter').value;
        adminCachedStartDate = loadResult.actualStartDate || dateRange.startDate;
        adminCachedEndDate = loadResult.actualEndDate || dateRange.endDate;
        updateDataLoadedRange();
        updateAdminDataLoadedRange();

        // Build summary client-side from loaded cases
        buildAdminSummaryFromCases();

        // Update colleague filter
        populateColleagueFilter();

        filterAndRenderAdminCases();
        renderUserSummary();
        updateAdminCacheStatus();
        showToast('Loaded ' + adminCases.length + ' cases from ' + helpdeskUsers.length + ' helpdesk colleagues', 'success');
    } catch (err) {
        hideLoadingOverlay();
        showToast('Error loading admin cases: ' + err.message, 'error');
    }
}

function updateAdminCacheStatus() {
    const statusEl = document.getElementById('adminCacheStatus');
    if (!statusEl) return;
    if (adminCacheTimestamp) {
        statusEl.innerHTML = `<i class="fas fa-clock"><\/i> Cached ${getAdminCacheAge()}`;
        statusEl.style.display = 'inline-flex';
    } else {
        statusEl.style.display = 'none';
    }
}

function forceRefreshAdminCases() {
    loadAdminCases(true);
}

function filterAndRenderAdminCases() {
    // Get the date range for filtering (same approach as Dashboard's applyFilters)
    const range = getAdminFilterDateRange();

    // Start with all cases or filtered by colleague
    let baseCases;
    if (selectedColleague === 'all') {
        baseCases = adminCases.slice();
    } else {
        baseCases = adminCases.filter(c => c.worksheet === selectedColleague);
    }

    // Apply date filter - same logic as Dashboard's applyFiltersInternal
    // Filter root cases and check if ANY case in the group (original + follow-ups) falls within date range
    const rootCases = baseCases.filter(c => c.isNewJob === 'Y');

    adminFilteredCases = rootCases.filter(root => {
        // Channel filter - same as Dashboard's updateStats() which filters by selectedChannels
        // Only include cases with valid channels (Agency, Broker, Banca)
        if (!VALID_CHANNELS.includes(root.channel)) return false;

        // Get all related cases (original + follow-ups)
        const relatedCases = baseCases.filter(c => c.followUpJobId === root.jobId || c.jobId === root.jobId);

        // Period filter: check if ANY case in the group falls within the date range
        const anyInPeriod = relatedCases.some(c => {
            const cDate = new Date(c.createDate);
            return cDate >= range.start && cDate <= range.end;
        });

        return anyInPeriod;
    });

    // Also include follow-up cases that belong to filtered root cases (for follow-up count display)
    const filteredRootJobIds = new Set(adminFilteredCases.map(c => c.jobId));
    const relatedFollowUps = baseCases.filter(c => c.isNewJob !== 'Y' && filteredRootJobIds.has(c.followUpJobId));
    adminFilteredCases = adminFilteredCases.concat(relatedFollowUps);

    // Sort by date descending
    adminFilteredCases.sort((a, b) => new Date(b.receiveDate) - new Date(a.receiveDate));

    // Update stats
    updateAdminStats();

    // Reset to page 1 and render
    adminCurrentPage = 1;
    renderAdminCasesList();
}

/**
 * Get admin date range as Date objects for filtering
 * Mirrors getDateRange() logic but uses admin controls (adminPeriodFilter, adminCustomDateRange)
 * Single source of truth for admin date filtering
 */
function getAdminFilterDateRange() {
    const filterEl = document.getElementById('adminPeriodFilter');
    const filter = filterEl ? filterEl.value : '30days';
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

    // Return custom range if set (same as Dashboard's getDateRange)
    if (filter === 'custom' && adminCustomDateRange) {
        return { start: adminCustomDateRange.start, end: adminCustomDateRange.end };
    }

    let start, end;
    switch(filter) {
        case 'today':
            start = today;
            end = new Date(now.getTime() + 86400000);
            break;
        case '7days':
            start = new Date(today - 7 * 86400000);
            end = new Date(now.getTime() + 86400000);
            break;
        case '30days':
            start = new Date(today - 30 * 86400000);
            end = new Date(now.getTime() + 86400000);
            break;
        case '60days':
            start = new Date(today - 60 * 86400000);
            end = new Date(now.getTime() + 86400000);
            break;
        case '90days':
            start = new Date(today - 90 * 86400000);
            end = new Date(now.getTime() + 86400000);
            break;
        case 'thisMonth':
            start = new Date(now.getFullYear(), now.getMonth(), 1);
            end = new Date(now.getTime() + 86400000);
            break;
        case 'lastMonth':
            start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            end = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59);
            break;
        case 'thisYear':
            start = new Date(now.getFullYear(), 0, 1);
            end = new Date(now.getTime() + 86400000);
            break;
        case 'lastYear':
            start = new Date(now.getFullYear() - 1, 0, 1);
            end = new Date(now.getFullYear() - 1, 11, 31, 23, 59, 59);
            break;
        default:
            // Default to 30 days
            start = new Date(today - 30 * 86400000);
            end = new Date(now.getTime() + 86400000);
    }
    return { start, end };
}

function updateAdminStats() {
    // Use SAME logic as Dashboard's updateStats() - SINGLE SOURCE OF TRUTH
    // Get root cases from adminFilteredCases
    const rootCases = adminFilteredCases.filter(c => c.isNewJob === 'Y');

    let pendingCount = 0, escalatedCount = 0, resolvedCount = 0;
    rootCases.forEach(root => {
        // Find all related cases (original + follow-ups) and get the latest one
        // Same logic as Dashboard updateStats()
        const related = adminFilteredCases.filter(c => c.followUpJobId === root.jobId || c.jobId === root.jobId);
        const latest = related[related.length - 1];
        // Check if any related case has an escalate ticket
        const isEscalated = related.some(c => c.escalateTicket && c.escalateTicket.trim() !== '');

        if (latest && latest.actionResult === 'Completed') resolvedCount++;
        else if (isEscalated) escalatedCount++;
        else pendingCount++;
    });

    var statTotal = document.getElementById('adminStatTotal');
    var statPending = document.getElementById('adminStatPending');
    var statEscalated = document.getElementById('adminStatEscalated');
    var statResolved = document.getElementById('adminStatResolved');

    if (statTotal) statTotal.textContent = rootCases.length;
    if (statPending) statPending.textContent = pendingCount;
    if (statEscalated) statEscalated.textContent = escalatedCount;
    if (statResolved) statResolved.textContent = resolvedCount;
}

function renderAdminCasesList() {
    const container = document.getElementById('adminCasesList');
    if (!container) return; // Guard against null when tab not active

    // Only show original cases (isNewJob === 'Y') in the table
    const originalCases = adminFilteredCases.filter(c => c.isNewJob === 'Y');

    // Pagination
    const totalCases = originalCases.length;
    const totalPages = Math.ceil(totalCases / adminPageSize);
    const startIndex = (adminCurrentPage - 1) * adminPageSize;
    const endIndex = Math.min(startIndex + adminPageSize, totalCases);
    const pageCases = originalCases.slice(startIndex, endIndex);

    if (pageCases.length === 0) {
        container.innerHTML = `
            <div class="admin-empty-state">
                <i class="fas fa-inbox"><\/i>
                <p>No cases found for the selected filters<\/p>
            <\/div>
        `;
        document.getElementById('adminShowingRange').textContent = '0-0';
        document.getElementById('adminTotalCases').textContent = '0';
        document.getElementById('adminPrevPageBtn').disabled = true;
        document.getElementById('adminNextPageBtn').disabled = true;
        document.getElementById('adminPageNumbers').innerHTML = '';
        return;
    }

    container.innerHTML = pageCases.map(c => {
        // Find creator info
        const creator = helpdeskUsers.find(u => u.worksheet === c.worksheet);
        const creatorName = creator ? creator.name : c.worksheet;
        const creatorInitials = creator ? creator.initials : c.worksheet.substring(0, 2).toUpperCase();

        // Get follow-up count
        const followUps = adminFilteredCases.filter(fc => fc.originalJobId === c.jobId);
        const followUpBadge = followUps.length > 0 ? `<span class="follow-up-badge">${followUps.length}<\/span>` : '';

        // Status
        const statusClass = c.status === 'Closed' ? 'status-closed' : (c.escalateTicket ? 'status-escalated' : 'status-pending');
        const statusText = c.status === 'Closed' ? 'Closed' : (c.escalateTicket ? 'Escalated' : 'Pending');

        return `
            <div class="admin-case-row" onclick="viewAdminCaseDetail('${c.jobId}', '${c.worksheet}')">
                <div data-label="Date">${formatDate(c.receiveDate)} ${followUpBadge}<\/div>
                <div data-label="Created By" class="case-creator"><span class="case-creator-initials">${creatorInitials}<\/span>${creatorName}<\/div>
                <div data-label="Channel"><span class="channel-badge ${(c.channel || '').toLowerCase()}">${c.channel || '-'}<\/span><\/div>
                <div data-label="Category">${c.category || '-'}<\/div>
                <div data-label="Contact">${c.contactName || '-'}<\/div>
                <div data-label="Status"><span class="status-badge ${statusClass}">${statusText}<\/span><\/div>
            <\/div>
        `;
    }).join('');

    // Update pagination info
    document.getElementById('adminShowingRange').textContent = `${startIndex + 1}-${endIndex}`;
    document.getElementById('adminTotalCases').textContent = totalCases;

    // Update pagination buttons
    document.getElementById('adminPrevPageBtn').disabled = adminCurrentPage === 1;
    document.getElementById('adminNextPageBtn').disabled = adminCurrentPage >= totalPages;

    // Render page numbers
    renderAdminPageNumbers(totalPages);
}

function renderAdminPageNumbers(totalPages) {
    const container = document.getElementById('adminPageNumbers');
    if (totalPages <= 1) {
        container.innerHTML = '';
        return;
    }

    let pages = [];
    if (totalPages <= 5) {
        pages = Array.from({ length: totalPages }, (_, i) => i + 1);
    } else {
        pages.push(1);
        if (adminCurrentPage > 3) pages.push('...');
        for (let i = Math.max(2, adminCurrentPage - 1); i <= Math.min(totalPages - 1, adminCurrentPage + 1); i++) {
            pages.push(i);
        }
        if (adminCurrentPage < totalPages - 2) pages.push('...');
        pages.push(totalPages);
    }

    container.innerHTML = pages.map(p =>
        p === '...' ? '<span class="page-ellipsis">...<\/span>' :
        `<button class="page-number ${p === adminCurrentPage ? 'active' : ''}" onclick="goToAdminPage(${p})">${p}<\/button>`
    ).join('');
}

function goToAdminPage(page) {
    const originalCases = adminFilteredCases.filter(c => c.isNewJob === 'Y');
    const totalPages = Math.ceil(originalCases.length / adminPageSize);
    if (page < 1 || page > totalPages) return;
    adminCurrentPage = page;
    renderAdminCasesList();
}

function viewAdminCaseDetail(jobId, worksheet) {
    // For now, show a toast - view only mode could be implemented later
    showToast(`Case ${jobId} from ${worksheet} - View only mode`, 'info');
    // Future: Could navigate to a read-only case detail view
}

function renderUserSummary() {
    const container = document.getElementById('adminUserSummary');
    const tbody = document.getElementById('summaryTableBody');

    // Check if we have summary data
    const userNames = Object.keys(adminSummary);
    if (userNames.length === 0) {
        container.style.display = 'none';
        return;
    }

    container.style.display = 'block';

    // Sort user names alphabetically
    userNames.sort((a, b) => a.localeCompare(b));

    // Build rows for each user
    let totals = { total: 0, agency: 0, broker: 0, banca: 0, pending: 0, escalated: 0, completed: 0, totalDuration: 0 };

    const rows = userNames.map(name => {
        const s = adminSummary[name];
        // Accumulate totals
        totals.total += s.total;
        totals.agency += s.agency;
        totals.broker += s.broker;
        totals.banca += s.banca;
        totals.pending += s.pending;
        totals.escalated += s.escalated;
        totals.completed += s.completed;
        totals.totalDuration += s.totalDuration;

        const avgDuration = s.total > 0 ? Math.round(s.totalDuration / s.total) : 0;

        // Check if user is inactive (for visual indicator)
        const user = helpdeskUsers.find(u => u.name === name);
        const isInactive = user && !user.isActive;
        const displayName = isInactive ? `${name} <span class="inactive-badge">(inactive)<\/span>` : name;

        return `
            <div class="summary-table-row${isInactive ? ' inactive-user' : ''}">
                <div class="colleague-name">${displayName}<\/div>
                <div class="text-center summary-value highlight">${s.total}<\/div>
                <div class="text-center summary-value">${s.agency}<\/div>
                <div class="text-center summary-value">${s.broker}<\/div>
                <div class="text-center summary-value">${s.banca}<\/div>
                <div class="text-center summary-value" style="color: var(--warning);">${s.pending}<\/div>
                <div class="text-center summary-value" style="color: var(--purple);">${s.escalated}<\/div>
                <div class="text-center summary-value" style="color: var(--success);">${s.completed}<\/div>
                <div class="text-center summary-value">${avgDuration}<\/div>
            <\/div>
        `;
    }).join('');

    // Add totals row
    const totalAvgDuration = totals.total > 0 ? Math.round(totals.totalDuration / totals.total) : 0;
    const totalsRow = `
        <div class="summary-table-row totals-row">
            <div class="colleague-name">TOTAL<\/div>
            <div class="text-center summary-value highlight">${totals.total}<\/div>
            <div class="text-center summary-value">${totals.agency}<\/div>
            <div class="text-center summary-value">${totals.broker}<\/div>
            <div class="text-center summary-value">${totals.banca}<\/div>
            <div class="text-center summary-value" style="color: var(--warning);">${totals.pending}<\/div>
            <div class="text-center summary-value" style="color: var(--purple);">${totals.escalated}<\/div>
            <div class="text-center summary-value" style="color: var(--success);">${totals.completed}<\/div>
            <div class="text-center summary-value">${totalAvgDuration}<\/div>
        <\/div>
    `;

    tbody.innerHTML = rows + totalsRow;
}

function toggleUserSummary() {
    const content = document.getElementById('summaryContent');
    const toggleBtn = document.getElementById('summaryToggleBtn');

    content.classList.toggle('collapsed');
    toggleBtn.classList.toggle('collapsed');
}

function showAddUserModal() {
    document.getElementById('userModalTitle').innerHTML = '<i class="fas fa-user-plus"><\/i> Add User';
    document.getElementById('userForm').reset();
    document.getElementById('editingUserEmail').value = '';
    document.getElementById('userEmailInput').disabled = false;
    populateWorksheetDropdown();
    document.getElementById('userModal').classList.add('show');
}

function editUser(email) {
    const user = USERS.find(u => u.email === email);
    if (!user) return;

    document.getElementById('userModalTitle').innerHTML = '<i class="fas fa-user-edit"><\/i> Edit User';
    document.getElementById('userNameInput').value = user.name;
    document.getElementById('userEmailInput').value = user.email;
    document.getElementById('userEmailInput').disabled = true;
    document.getElementById('userInitialsInput').value = user.initials;
    document.getElementById('userRoleInput').value = user.role;
    document.getElementById('userStatusInput').value = user.isActive ? 'true' : 'false';
    document.getElementById('userIsHelpdeskInput').value = user.isHelpdesk ? 'true' : 'false';
    document.getElementById('editingUserEmail').value = email;
    populateWorksheetDropdown(user.worksheet);
    document.getElementById('userModal').classList.add('show');
}

function populateWorksheetDropdown(selectedValue = '') {
    const select = document.getElementById('userWorksheetInput');
    select.innerHTML = '<option value="">Select worksheet...<\/option>' +
        WORKSHEETS.map(w => `<option value="${w}" ${w === selectedValue ? 'selected' : ''}>${w}<\/option>`).join('');
}

function closeUserModal() {
    document.getElementById('userModal').classList.remove('show');
}

async function saveUser(event) {
    event.preventDefault();

    const editingEmail = document.getElementById('editingUserEmail').value;
    const name = document.getElementById('userNameInput').value.trim();
    const email = document.getElementById('userEmailInput').value.trim();
    const initials = document.getElementById('userInitialsInput').value.trim().toUpperCase();
    const worksheet = document.getElementById('userWorksheetInput').value;
    const role = document.getElementById('userRoleInput').value;
    const isActive = document.getElementById('userStatusInput').value === 'true';
    const isHelpdesk = document.getElementById('userIsHelpdeskInput').value === 'true';

    const userData = { name, email, initials, worksheet, role, isActive, isHelpdesk };

    showLoadingOverlay('Saving user...');

    try {
        let result;
        if (editingEmail) {
            // Editing existing user
            result = await apiPost('updateUser', userData);
        } else {
            // Adding new user
            result = await apiPost('addUser', userData);
        }

        hideLoadingOverlay();

        if (result.success) {
            showToast(editingEmail ? 'User updated successfully!' : 'User added successfully!', 'success');
            // Reload users from API
            await loadUsersFromAPI();
            closeUserModal();
            renderAdminUserList();
            renderUserList();
        } else {
            showToast(result.error || 'Failed to save user', 'error');
        }
    } catch (error) {
        hideLoadingOverlay();
        console.error('API error saving user:', error);
        showToast('Failed to connect to server', 'error');
    }
}

function toggleUserStatus(email) {
    const user = USERS.find(u => u.email === email);
    if (!user) return;

    // Prevent deactivating the last admin
    if (user.role === 'admin' && user.isActive) {
        const activeAdmins = USERS.filter(u => u.role === 'admin' && u.isActive);
        if (activeAdmins.length <= 1) {
            showToast('Cannot deactivate the last active admin!', 'error');
            return;
        }
    }

    const action = user.isActive ? 'deactivate' : 'activate';
    showConfirm(
        `${user.isActive ? 'Deactivate' : 'Activate'} User`,
        `Are you sure you want to ${action} ${user.name}?`,
        async () => {
            showLoadingOverlay('Updating user...');
            try {
                const result = await apiPost('updateUser', Object.assign({}, user, { isActive: !user.isActive }));
                hideLoadingOverlay();
                if (result.success) {
                    showToast(`User ${!user.isActive ? 'activated' : 'deactivated'} successfully!`, 'success');
                    await loadUsersFromAPI();
                    renderAdminUserList();
                    renderUserList();
                } else {
                    showToast(result.error || 'Failed to update user', 'error');
                }
            } catch (error) {
                hideLoadingOverlay();
                showToast('Failed to connect to server', 'error');
            }
        }
    );
}

// Dark mode detection
if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
    document.documentElement.classList.add('dark');
    isDarkMode = true;
}
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
    if (event.matches) {
        document.documentElement.classList.add('dark');
        isDarkMode = true;
    } else {
        document.documentElement.classList.remove('dark');
        isDarkMode = false;
    }
    document.getElementById('themeIcon').className = isDarkMode ? 'fas fa-sun' : 'fas fa-moon';
});

document.addEventListener('DOMContentLoaded', init);

// iOS Safari fix: Reinitialize dropdowns when page becomes visible again after switching apps
document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'visible' && currentUser) {
        // Small delay to let iOS Safari stabilize
        setTimeout(function() {
            initAllDropdowns();
        }, 100);
    }
});

// =============================================
// Google Apps Script Compatibility
// Explicitly expose all functions to window scope
// so that inline onclick/onchange/etc handlers work
// when served via HtmlService (Caja sanitization)
// =============================================
window.activateCustomTab = activateCustomTab;
window.applyPeriodSelection = applyPeriodSelection;
window.applyTemplate = applyTemplate;
window.bulkCloseCases = bulkCloseCases;
window.changePageSize = changePageSize;
window.clearSearch = clearSearch;
window.clearSelection = clearSelection;
window.closeCase = closeCase;
window.closeConfirm = closeConfirm;
window.closeUserModal = closeUserModal;
window.confirmCloneCase = confirmCloneCase;
window.confirmDeleteCase = confirmDeleteCase;
window.createFollowUp = createFollowUp;
window.editCase = editCase;
window.editUser = editUser;
window.executeConfirm = executeConfirm;
window.executeDiscard = executeDiscard;
window.executeThreeOptionSave = executeThreeOptionSave;
window.filterByStat = filterByStat;
window.formatTelNoInput = formatTelNoInput;
window.goBackFromEdit = goBackFromEdit;
window.goToAdminPage = goToAdminPage;
window.goToPage = goToPage;
window.handleAutocompleteKey = handleAutocompleteKey;
window.handleClearCancel = handleClearCancel;
window.handleDashboardColleagueChange = handleDashboardColleagueChange;
window.handleDropdownKey = handleDropdownKey;
window.handleSearchInput = handleSearchInput;
window.hideClassificationWizard = hideClassificationWizard;
window.hidePeriodModal = hidePeriodModal;
window.loginAs = loginAs;
window.logout = logout;
window.navigateTo = navigateTo;
window.onDurationChange = onDurationChange;
window.onEndTimeChange = onEndTimeChange;
window.onStartTimeChange = onStartTimeChange;
window.openCase = openCase;
window.saveCase = saveCase;
window.saveUser = saveUser;
window.selectAutocomplete = selectAutocomplete;
window.selectChannel = selectChannel;
window.selectCustomDropdownOption = selectCustomDropdownOption;
window.selectPeriodPreset = selectPeriodPreset;
window.selectTimelineItem = selectTimelineItem;
window.selectWizardOption = selectWizardOption;
window.setActiveAutocomplete = setActiveAutocomplete;
window.showAddUserModal = showAddUserModal;
window.showAdminTab = showAdminTab;
window.showAutocomplete = showAutocomplete;
window.showClassificationWizard = showClassificationWizard;
window.showPeriodModal = showPeriodModal;
window.showView = showView;
window.sortByColumn = sortByColumn;
window.switchPeriodCustomTab = switchPeriodCustomTab;
window.toggleChannel = toggleChannel;
window.toggleCustomDropdown = toggleCustomDropdown;
window.toggleInternalStaff = toggleInternalStaff;
window.toggleSelectAll = toggleSelectAll;
window.toggleTheme = toggleTheme;
window.toggleTimelineDrawer = toggleTimelineDrawer;
window.toggleUserStatus = toggleUserStatus;
window.updateSelection = updateSelection;
window.viewAdminCaseDetail = viewAdminCaseDetail;
window.wizardGoBack = wizardGoBack;
window.wizardGoNext = wizardGoNext;
window.wizardGoToStep = wizardGoToStep;
window.handleGoogleSignIn = handleGoogleSignIn;
window.handleSessionExpired = handleSessionExpired;
window.initGoogleSignIn = initGoogleSignIn;
window.showLoginError = showLoginError;
</script>
</body>
</html>
